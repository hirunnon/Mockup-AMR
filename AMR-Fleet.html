<!-- 
  Koa: Web Framework (Implicit)
  TailwindCSS: Styling
  Chart.js: Analytics Charts
  Tone.js: Alert Sounds
  Font Awesome: Icons
-->

<!-- 
  Chosen Palette: 'Cool Gray' (Tailwind's default gray, now referred to as 'slate')
  This palette provides a professional, clean, and neutral background (bg-slate-100)
  that allows key information (blue buttons, green/red status indicators) to stand out.
  It's modern, easy on the eyes, and suitable for a technical command center.
-->
<!-- 
  Application Structure Plan:
  - Structure: Single-Page Application (SPA) with a collapsible fixed sidebar and a `flex-1` main content area.
  - Interaction: User clicks a sidebar link. JavaScript hides all 'page-section' elements and shows only the one matching the link.
  - User Flow:
    1. Sidebar: Collapsible.
    2. Navigation: JS handles showing/hiding pages. Modals are used for editing/creation.
    3. 'AMR Page' (Req 1): Added 'Add AMR' button, 'Enable' toggle switch, and a new modal (`amr-editor-modal`) for adding/editing AMR properties (Name, IP, Model, Home/Charge tasks/points).
    4. 'Plan Page' (Req 2): Added 'Enable' toggle switch. The 'Plan Editor' modal (`plan-editor-modal`) now includes a checklist of available AMRs to assign to the plan.
    5. 'Task Page' (Req 3): Added 'Enable' toggle switch. 'Icon' field moved from Task Chain to the main Task Template. 'Task Chain' table column for Icon is removed.
  - Justification: This enhances the application from a simple monitor to a full configuration tool, allowing administrators to manage all assets (AMRs, Plans, Tasks) directly.
-->
<!-- 
  Visualization & Content Choices:
  - Report Info: AMR List
  - Goal: Manage individual AMRs.
  - Viz/Presentation: HTML Table (page-amrs)
  - Interaction: Added Toggle Switches, 'Add AMR' button, and 'Edit' button. All trigger the new `amr-editor-modal`.
  - Justification: Standard CRUD interface for asset management.
  
  - Report Info: Plan List
  - Goal: Manage Plans.
  - Viz/Presentation: HTML Cards (page-plans)
  - Interaction: Added Toggle Switches. 'Edit' button triggers `plan-editor-modal`, which now includes AMR checkboxes.
  - Justification: Provides on/off control and deep configuration (AMR assignment).
  
  - Report Info: Task List
  - Goal: Manage Task Templates.
  - Viz/Presentation: HTML Table (page-tasks)
  - Interaction: Added Toggle Switches. 'Edit' button triggers `task-editor-modal`, which now has the 'Icon' field at the top level.
  - Justification: Refactors the Task data structure for better organization (Icon belongs to Task, not Chain).
-->
<!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->

<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AMR Fleet Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        /* Global Styles */
        html {
            scroll-behavior: smooth;
            /* For anchor links */
        }

        body {
            font-family: 'Inter', 'Noto Sans Thai', sans-serif;
            background-color: #f1f5f9;
            /* bg-slate-100 */
        }

        .page-section {
            display: none;
        }

        .page-section.active {
            display: block;
        }

        .sidebar-link {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            color: #475569;
            /* text-slate-600 */
            transition: all 0.2s;
            white-space: nowrap;
            /* Prevent text wrap when collapsing */
        }

        .sidebar-link:hover {
            background-color: #e2e8f0;
            /* bg-slate-200 */
            color: #1e293b;
            /* text-slate-800 */
        }

        .sidebar-link.active {
            background-color: #e0f2fe;
            /* bg-sky-100 */
            color: #0c4a6e;
            /* text-sky-800 */
            font-weight: 600;
        }

        .nav-icon {
            width: 1.25rem;
            margin-right: 0.75rem;
            text-align: center;
            flex-shrink: 0;
            /* Prevent icon from shrinking */
        }

        /* Sidebar Collapse */
        #sidebar {
            transition: width 0.3s ease;
            width: 16rem;
            /* 256px */
        }

        #sidebar.sidebar-hidden {
            width: 4rem;
            /* 64px */
        }

        #sidebar.sidebar-hidden .sidebar-text,
        #sidebar.sidebar-hidden #add-order-chevron,
        #sidebar.sidebar-hidden #storage-chevron,
        #sidebar.sidebar-hidden #sidebar-title-text {
            display: none;
        }

        #sidebar.sidebar-hidden .sidebar-link,
        #sidebar.sidebar-hidden #add-order-toggle,
        #sidebar.sidebar-hidden #storage-toggle {
            justify-content: center;
        }

        #sidebar.sidebar-hidden .nav-icon {
            margin-right: 0;
        }

        #sidebar.sidebar-hidden #add-order-submenu,
        #sidebar.sidebar-hidden #storage-submenu {
            display: none !important;
            /* Force hide sub-menu when collapsed */
        }

        /* Main Content */
        #main-content {
            /* flex-1 is handled by Tailwind class */
        }

        /* Plan Step Styles */
        .plan-step {
            flex-shrink: 0;
            width: 150px;
            min-height: 100px;
            border: 1px solid #e2e8f0;
            /* border-slate-200 */
            background-color: #f8fafc;
            /* bg-slate-50 */
            border-radius: 0.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 0.5rem;
            font-size: 0.875rem;
        }

        .plan-arrow {
            flex-shrink: 0;
            padding: 0 1rem;
            color: #94a3b8;
            /* text-slate-400 */
            font-size: 1.5rem;
        }

        /* Order Page Button Styles */
        .order-point-btn {
            padding: 1rem 1.5rem;
            border: 2px solid #cbd5e1;
            /* border-slate-300 */
            border-radius: 0.5rem;
            background-color: #f8fafc;
            /* bg-slate-50 */
            color: #334155;
            /* text-slate-700 */
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.2s;
            position: relative;
            min-width: 140px;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .order-point-btn:hover:not(:disabled) {
            background-color: #f1f5f9;
            /* bg-slate-100 */
            border-color: #94a3b8;
            /* border-slate-400 */
        }

        .order-point-btn.status-available {
            background-color: #f0fdf4;
            /* bg-green-50 */
            border-color: #86efac;
            /* border-green-300 */
            color: #15803d;
            /* text-green-700 */
        }

        .order-point-btn.status-available:hover:not(:disabled) {
            background-color: #dcfce7;
            /* bg-green-100 */
        }

        .order-point-btn.status-inprogress {
            background-color: #fefce8;
            /* bg-yellow-50 */
            border-color: #fde047;
            /* border-yellow-300 */
            color: #854d0e;
            /* text-yellow-700 */
            opacity: 0.8;
            cursor: not-allowed;
        }

        .order-point-btn.status-unavailable {
            background-color: #f1f5f9;
            /* bg-slate-100 */
            border-color: #e2e8f0;
            /* border-slate-200 */
            color: #64748b;
            /* text-slate-500 */
            opacity: 0.7;
            cursor: not-allowed;
        }

        .order-point-btn.selected {
            background-color: #e0f2fe;
            /* bg-sky-100 */
            border-color: #38bdf8;
            /* border-sky-400 */
            color: #0c4a6e;
            /* text-sky-800 */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        /* Custom Checkbox Style */
        .form-checkbox {
            appearance: none;
            width: 1.25rem;
            /* 20px */
            height: 1.25rem;
            /* 20px */
            border: 2px solid #cbd5e1;
            /* border-slate-300 */
            border-radius: 0.25rem;
            display: inline-block;
            position: relative;
            cursor: pointer;
            vertical-align: middle;
        }

        .form-checkbox:checked {
            background-color: #2563eb;
            /* bg-blue-600 */
            border-color: #2563eb;
            /* border-blue-600 */
        }

        .form-checkbox:checked::after {
            content: '✓';
            /* Checkmark */
            font-size: 0.875rem;
            /* 14px */
            font-weight: 900;
            color: white;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            line-height: 1;
        }

        /* (Req 1, 2, 3) Toggle Switch Style */
        .switch {
            position: relative;
            display: inline-block;
            width: 3rem;
            /* 48px */
            height: 1.5rem;
            /* 24px */
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 1.5rem;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 1.125rem;
            /* 18px */
            width: 1.125rem;
            /* 18px */
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: #22c55e;
            /* bg-green-500 */
        }

        input:focus+.slider {
            box-shadow: 0 0 1px #22c55e;
        }

        input:checked+.slider:before {
            transform: translateX(1.5rem);
            /* 24px */
        }

        /* Modal Styles */
        .modal {
            display: none;
            /* Hidden by default */
            position: fixed;
            z-index: 50;
            inset: 0;
            overflow-y: auto;
        }

        .modal.open {
            display: flex;
            /* Show modal */
        }

        .modal-backdrop {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            transition: opacity 0.3s;
        }

        .modal-container {
            position: relative;
            margin: auto;
            background: white;
            border-radius: 0.5rem;
            padding: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            width: 90%;
            max-width: 48rem;
            /* 768px */
            z-index: 60;
        }

        .modal-container-sm {
            max-width: 32rem;
            /* 512px */
        }

        .modal-container-lg {
            max-width: 64rem;
            /* 1024px */
        }

        /* Drag & Drop Styles */
        .draggable-task {
            padding: 1rem;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            cursor: grab;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .draggable-task:hover {
            border-color: #38bdf8;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .draggable-task.dragging {
            opacity: 0.5;
            background: #e0f2fe;
            border-style: dashed;
        }

        .drag-handle {
            cursor: grab;
            margin-right: 0.75rem;
            color: #94a3b8;
        }

        .drag-handle:active {
            cursor: grabbing;
        }

        /* Blinking animation for active step */
        @keyframes blink-yellow {

            0%,
            100% {
                background-color: #fef9c3;
                border-color: #fde047;
            }

            50% {
                background-color: #fef3c7;
                border-color: #fbbf24;
            }
        }

        .plan-step.blinking {
            animation: blink-yellow 1.5s ease-in-out infinite;
        }
    </style>
</head>

<body class="text-slate-800">
    <div class="flex h-screen">
        <!-- Sidebar Navigation -->
        <nav id="sidebar" class="bg-white shadow-lg flex-shrink-0 overflow-y-auto overflow-x-hidden">
            <div class="p-4 flex items-center">
                <!-- Toggle Button -->
                <button id="sidebar-toggle-btn" class="text-slate-600 hover:text-blue-700 p-2 rounded-lg">
                    <i class="fas fa-bars"></i>
                </button>
                <h2 id="sidebar-title-text" class="text-xl font-bold text-blue-700 ml-2">AMR Fleet</h2>
            </div>

            <div class="px-4 space-y-2">
                <a href="#dashboard" class="sidebar-link active" data-page="page-dashboard">
                    <i class="fas fa-tachometer-alt nav-icon"></i>
                    <span class="sidebar-text">แดชบอร์ด</span>
                </a>
                <a href="#map" class="sidebar-link" data-page="page-map">
                    <i class="fas fa-map-marked-alt nav-icon"></i>
                    <span class="sidebar-text">แผนที่ (Live)</span>
                </a>

                <!-- Add Order Menu -->
                <div>
                    <button id="add-order-toggle" class="sidebar-link w-full text-left"
                        data-page="page-add-order-parent">
                        <i class="fas fa-plus-circle nav-icon text-green-500"></i>
                        <span class="sidebar-text">สั่งงาน (Add Order)</span>
                        <i class="fas fa-chevron-down ml-auto transition-transform duration-200 sidebar-text"
                            id="add-order-chevron"></i>
                    </button>
                    <!-- Sub-menu -->
                    <div id="add-order-submenu" class="pl-8 py-2 space-y-2 hidden">
                        <a href="#order-plan-101" class="sidebar-link text-sm" data-page="page-order-plan-101"
                            data-anchor="#plan-101-anchor">
                            <i class="fas fa-tasks nav-icon"></i>
                            <span class="sidebar-text">Plan 101 (A -> B)</span>
                        </a>
                        <a href="#order-plan-102" class="sidebar-link text-sm" data-page="page-order-plan-102"
                            data-anchor="#plan-102-anchor">
                            <i class="fas fa-tasks nav-icon"></i>
                            <span class="sidebar-text">Plan 102 (C -> D)</span>
                        </a>
                        <a href="#order-plan-103" class="sidebar-link text-sm" data-page="page-order-plan-103"
                            data-anchor="#plan-103-anchor">
                            <i class="fas fa-tasks nav-icon"></i>
                            <span class="sidebar-text">Plan 103 (D -> E)</span>
                        </a>
                    </div>
                </div>

                <a href="#amrs" class="sidebar-link" data-page="page-amrs">
                    <i class="fas fa-robot nav-icon"></i>
                    <span class="sidebar-text">จัดการหุ่นยนต์</span>
                </a>
                <a href="#plans" class="sidebar-link" data-page="page-plans">
                    <i class="fas fa-sitemap nav-icon"></i>
                    <span class="sidebar-text">จัดการแผนงาน</span>
                </a>
                <a href="#tasks" class="sidebar-link" data-page="page-tasks">
                    <i class="fas fa-cogs nav-icon"></i>
                    <span class="sidebar-text">จัดการงาน (Task)</span>
                </a>

                <!-- Storage Menu -->
                <div>
                    <button id="storage-toggle" class="sidebar-link w-full text-left" data-page="page-storage-parent">
                        <i class="fas fa-boxes nav-icon"></i>
                        <span class="sidebar-text">จัดการสต็อก (Storage)</span>
                        <i class="fas fa-chevron-down ml-auto transition-transform duration-200 sidebar-text"
                            id="storage-chevron"></i>
                    </button>
                    <div id="storage-submenu" class="pl-8 py-2 space-y-2 hidden">
                        <a href="#storage-ab" class="sidebar-link text-sm" data-page="page-storage-ab"
                            data-anchor="#storage-ab-anchor">
                            <i class="fas fa-box nav-icon"></i>
                            <span class="sidebar-text">Plan 101 (A -> B)</span>
                        </a>
                        <a href="#storage-cd" class="sidebar-link text-sm" data-page="page-storage-cd"
                            data-anchor="#storage-cd-anchor">
                            <i class="fas fa-box nav-icon"></i>
                            <span class="sidebar-text">Plan 102 (C -> D)</span>
                        </a>
                        <a href="#storage-de" class="sidebar-link text-sm" data-page="page-storage-de"
                            data-anchor="#storage-de-anchor">
                            <i class="fas fa-box nav-icon"></i>
                            <span class="sidebar-text">Plan 103 (D -> E)</span>
                        </a>
                    </div>
                </div>

                <a href="#settings" class="sidebar-link" data-page="page-settings">
                    <i class="fas fa-user-cog nav-icon"></i>
                    <span class="sidebar-text">ตั้งค่า / ผู้ใช้</span>
                </a>
                <!--<a href="#recommend" class="sidebar-link" data-page="page-recommend">
                    <i class="fas fa-book nav-icon"></i>
                    <span class="sidebar-text">คำแนะนำ (Report)</span>
                </a>-->
            </div>
        </nav>

        <!-- Main Content Area -->
        <main id="main-content" class="flex-1 overflow-y-auto">
            <header class="bg-white shadow-sm sticky top-0 z-10">
                <div class="p-6 flex justify-between items-center">
                    <h1 id="page-title" class="text-2xl font-semibold text-slate-800">แดชบอร์ดภาพรวม</h1>
                    <div>
                        <span class="mr-4">User: <strong class="text-blue-600">operator01</strong></span>
                        <button class="text-slate-500 hover:text-red-600">
                            <i class="fas fa-sign-out-alt mr-1"></i>
                            ออกจากระบบ
                        </button>
                    </div>
                </div>
            </header>

            <div class="p-6 space-y-6">
                <!-- Page: Dashboard -->
                <section id="page-dashboard" class="page-section active space-y-6">
                    <p class="text-slate-600">สรุปผลและวิเคราะห์ข้อมูลการทำงานของระบบ AMR</p>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-lg font-semibold mb-4 text-slate-700">ประสิทธิภาพ AMR (รายชั่วโมง)</h3>
                            <!-- (FIX) Added wrapper div to constrain chart height -->
                            <div class="relative h-96">
                                <canvas id="amrPerfChart"></canvas>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-lg font-semibold mb-4 text-slate-700">อัตราส่วนงาน (Task Ratio)</h3>
                            <div class="relative h-96">
                                <canvas id="taskRatioChart"></canvas>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Page: Map -->
                <section id="page-map" class="page-section space-y-6">
                    <p class="text-slate-600">แผนที่จำลอง 2D แสดงตำแหน่งและการเคลื่อนที่ของ AMR แบบ Real-time</p>
                    <div class="bg-white rounded-lg shadow-md p-4">
                        <canvas id="mapCanvas" class="w-full h-[60vh] rounded-lg"></canvas>
                    </div>
                </section>

                <!-- Page: AMRs (Req 1: Added Toggle, Add Button) -->
                <section id="page-amrs" class="page-section space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-lg font-semibold text-slate-700">AMR ทั้งหมด</h3>
                            <p class="text-4xl font-bold text-blue-600">4</p>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-lg font-semibold text-slate-700">กำลังทำงาน</h3>
                            <p class="text-4xl font-bold text-green-600">3</p>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-lg font-semibold text-slate-700">มีปัญหา</h3>
                            <p class="text-4xl font-bold text-red-600">1</p>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-lg font-semibold text-slate-700">ว่างงาน / ปิดใช้งาน</h3>
                            <p class="text-4xl font-bold text-grey-600">0</p>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md overflow-x-auto">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-slate-700">รายการหุ่นยนต์ (AMR List)</h3>
                            <button id="add-amr-btn"
                                class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition">
                                <i class="fas fa-plus mr-2"></i>เพิ่ม AMR
                            </button>
                        </div>
                        <table class="w-full text-left text-sm text-slate-600 min-w-[800px]">
                            <thead class="bg-slate-50">
                                <tr>
                                    <th class="p-3">AMR ID</th>
                                    <th class="p-3">สถานะ</th>
                                    <th class="p-3">แบตเตอรี่</th>
                                    <th class="p-3">งานปัจจุบัน</th>
                                    <th class="p-3">Plans ที่รองรับ</th>
                                    <th class="p-3">เปิด/ปิด</th>
                                    <th class="p-3">จัดการ</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="border-b">
                                    <td class="p-3 font-medium text-blue-600">AMR-001</td>
                                    <td class="p-3"><span
                                            class="px-2 py-1 bg-blue-100 text-blue-700 rounded-full">กำลังทำงาน</span>
                                    </td>
                                    <td class="p-3">95%</td>
                                    <td class="p-3">ORD-1023</td>
                                    <td class="p-3">101, 103</td>
                                    <td class="p-3">
                                        <label class="switch"><input type="checkbox" checked><span
                                                class="slider"></span></label>
                                    </td>
                                    <td class="p-3">
                                        <button class="text-blue-500 hover:text-blue-700 edit-amr-btn"
                                            data-amr-id="AMR-001"><i class="fas fa-edit"></i> แก้ไข</button>
                                    </td>
                                </tr>
                                <tr class="border-b">
                                    <td class="p-3 font-medium text-blue-600">AMR-002</td>
                                    <td class="p-3"><span
                                            class="px-2 py-1 bg-red-100 text-red-700 rounded-full">มีปัญหา</span></td>
                                    <td class="p-3">30%</td>
                                    <td class="p-3">--</td>
                                    <td class="p-3">101</td>
                                    <td class="p-3">
                                        <label class="switch"><input type="checkbox" checked><span
                                                class="slider"></span></label>
                                    </td>
                                    <td class="p-3">
                                        <button class="text-blue-500 hover:text-blue-700 edit-amr-btn"
                                            data-amr-id="AMR-002"><i class="fas fa-edit"></i> แก้ไข</button>
                                    </td>
                                </tr>
                                <tr class="border-b">
                                    <td class="p-3 font-medium text-blue-600">AMR-003</td>
                                    <td class="p-3"><span
                                            class="px-2 py-1 bg-blue-100 text-blue-700 rounded-full">กำลังทำงาน</span>
                                    </td>
                                    <td class="p-3">78%</td>
                                    <td class="p-3">ORD-1025</td>
                                    <td class="p-3">102</td>
                                    <td class="p-3">
                                        <label class="switch"><input type="checkbox" checked><span
                                                class="slider"></span></label>
                                    </td>
                                    <td class="p-3">
                                        <button class="text-blue-500 hover:text-blue-700 edit-amr-btn"
                                            data-amr-id="AMR-003"><i class="fas fa-edit"></i> แก้ไข</button>
                                    </td>
                                </tr>
                                <tr class="border-b">
                                    <td class="p-3 font-medium text-blue-600">AMR-004</td>
                                    <td class="p-3"><span
                                            class="px-2 py-1 bg-slate-100 text-slate-700 rounded-full">ปิดใช้งาน</span>
                                    </td>
                                    <td class="p-3">22%</td>
                                    <td class="p-3">--</td>
                                    <td class="p-3">103</td>
                                    <td class="p-3">
                                        <label class="switch"><input type="checkbox"><span
                                                class="slider"></span></label>
                                    </td>
                                    <td class="p-3">
                                        <button class="text-blue-500 hover:text-blue-700 edit-amr-btn"
                                            data-amr-id="AMR-004"><i class="fas fa-edit"></i> แก้ไข</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </section>

                <!-- Page: Plans (Req 2: Added Toggle) -->
                <section id="page-plans" class="page-section space-y-6">
                    <p class="text-slate-600">"แผนงาน" (Plan) หรือ "เวิร์กโฟลว์" (Workflow) คือการนำ "งานย่อย" (Task)
                        หลายๆ งานมาเรียงต่อกันเป็นลำดับ ที่นี่คือส่วนที่ใช้สร้างและจัดการแม่แบบ (Template)
                        ของแผนงานเหล่านี้</p>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-slate-700">แผนงาน (Plans) ทั้งหมด</h3>
                            <button
                                class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition open-plan-modal-btn"
                                data-plan-id="new">
                                <i class="fas fa-plus mr-2"></i>สร้างแผนงานใหม่
                            </button>
                        </div>

                        <div class="space-y-6">
                            <!-- Plan 1 -->
                            <div class="border rounded-lg p-4 bg-white shadow-sm">
                                <div class="flex justify-between items-center mb-3">
                                    <h3 class="text-lg font-semibold text-blue-700">Plan 101: แผนกประกอบ 001 (A -> B)
                                    </h3>
                                    <div class="flex items-center space-x-4">
                                        <label class="switch" title="เปิด/ปิด Plan นี้"><input type="checkbox"
                                                checked><span class="slider"></span></label>
                                        <button class="text-blue-500 hover:text-blue-700 open-plan-modal-btn"
                                            data-plan-id="Plan 101"><i class="fas fa-edit"></i> แก้ไข</button>
                                    </div>
                                </div>
                                <div class="flex items-center overflow-x-auto p-2 bg-slate-50 rounded-lg">
                                    <div class="plan-step"><i
                                            class="fas fa-map-marker-alt text-xl mb-2 text-blue-500"></i>เลือกจุดรับ
                                        (Group A)</div>
                                    <div class="plan-arrow"><i class="fas fa-long-arrow-alt-right"></i></div>
                                    <div class="plan-step"><i
                                            class="fas fa-arrow-up text-xl mb-2 text-blue-500"></i>ยกของ (30cm)</div>
                                    <div class="plan-arrow"><i class="fas fa-long-arrow-alt-right"></i></div>
                                    <div class="plan-step"><i
                                            class="fas fa-map-marker-alt text-xl mb-2 text-green-500"></i>เลือกจุดวาง
                                        (Group B)</div>
                                    <div class="plan-arrow"><i class="fas fa-long-arrow-alt-right"></i></div>
                                    <div class="plan-step"><i
                                            class="fas fa-arrow-down text-xl mb-2 text-green-500"></i>วางของ</div>
                                </div>
                            </div>

                            <!-- Plan 2 -->
                            <div class="border rounded-lg p-4 bg-white shadow-sm">
                                <div class="flex justify-between items-center mb-3">
                                    <h3 class="text-lg font-semibold text-blue-700">Plan 102: แผนกประกอบ 002 (C -> D)
                                    </h3>
                                    <div class="flex items-center space-x-4">
                                        <label class="switch" title="เปิด/ปิด Plan นี้"><input type="checkbox"
                                                checked><span class="slider"></span></label>
                                        <button class="text-blue-500 hover:text-blue-700 open-plan-modal-btn"
                                            data-plan-id="Plan 102"><i class="fas fa-edit"></i> แก้ไข</button>
                                    </div>
                                </div>
                                <div class="flex items-center overflow-x-auto p-2 bg-slate-50 rounded-lg">
                                    <div class="plan-step"><i
                                            class="fas fa-map-marker-alt text-xl mb-2 text-blue-500"></i>เลือกจุดรับ
                                        (Group C)</div>
                                    <div class="plan-arrow"><i class="fas fa-long-arrow-alt-right"></i></div>
                                    <div class="plan-step"><i
                                            class="fas fa-arrow-up text-xl mb-2 text-blue-500"></i>ยกของ (50cm)</div>
                                    <div class="plan-arrow"><i class="fas fa-long-arrow-alt-right"></i></div>
                                    <div class="plan-step"><i
                                            class="fas fa-user-clock text-xl mb-2 text-yellow-500"></i>รอผู้ใช้ยืนยัน
                                    </div>
                                    <div class="plan-arrow"><i class="fas fa-long-arrow-alt-right"></i></div>
                                    <div class="plan-step"><i
                                            class="fas fa-map-marker-alt text-xl mb-2 text-green-500"></i>เลือกจุดวาง
                                        (Group D)</div>
                                    <div class="plan-arrow"><i class="fas fa-long-arrow-alt-right"></i></div>
                                    <div class="plan-step"><i
                                            class="fas fa-arrow-down text-xl mb-2 text-green-500"></i>วางของ</div>
                                </div>
                            </div>

                            <!-- Plan 3 -->
                            <div class="border rounded-lg p-4 bg-white shadow-sm">
                                <div class="flex justify-between items-center mb-3">
                                    <h3 class="text-lg font-semibold text-blue-700">Plan 103: แผนกประกอบ 003 (D -> E)
                                    </h3>
                                    <div class="flex items-center space-x-4">
                                        <label class="switch" title="เปิด/ปิด Plan นี้"><input type="checkbox"
                                                checked><span class="slider"></span></label>
                                        <button class="text-blue-500 hover:text-blue-700 open-plan-modal-btn"
                                            data-plan-id="Plan 103"><i class="fas fa-edit"></i> แก้ไข</button>
                                    </div>
                                </div>
                                <div class="flex items-center overflow-x-auto p-2 bg-slate-50 rounded-lg">
                                    <div class="plan-step"><i
                                            class="fas fa-map-marker-alt text-xl mb-2 text-blue-500"></i>เลือกจุดรับ
                                        (Group D)</div>
                                    <div class="plan-arrow"><i class="fas fa-long-arrow-alt-right"></i></div>
                                    <div class="plan-step"><i
                                            class="fas fa-arrow-up text-xl mb-2 text-blue-500"></i>ยกของ (30cm)</div>
                                    <div class="plan-arrow"><i class="fas fa-long-arrow-alt-right"></i></div>
                                    <div class="plan-step"><i
                                            class="fas fa-exchange-alt text-xl mb-2 text-purple-500"></i>เปลี่ยนจุดวาง
                                        (Group E)</div>
                                    <div class="plan-arrow"><i class="fas fa-long-arrow-alt-right"></i></div>
                                    <div class="plan-step"><i
                                            class="fas fa-map-marker-alt text-xl mb-2 text-green-500"></i>เลือกจุดวาง
                                        (Group E)</div>
                                    <div class="plan-arrow"><i class="fas fa-long-arrow-alt-right"></i></div>
                                    <div class="plan-step"><i
                                            class="fas fa-arrow-down text-xl mb-2 text-green-500"></i>วางของ</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Page: Task Management (Req 3: Added Toggle, Icon moved) -->
                <section id="page-tasks" class="page-section space-y-6">
                    <p class="text-slate-600">จัดการ "แม่แบบของงานย่อย" (Task Templates) ที่จะถูกนำไปใช้ประกอบร่างเป็น
                        "แผนงาน" (Plans)</p>
                    <div class="bg-white p-6 rounded-lg shadow-md overflow-x-auto">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-slate-700">รายการ Task Templates</h3>
                            <button
                                class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition open-task-modal-btn"
                                data-task-id="new">
                                <i class="fas fa-plus mr-2"></i>สร้าง Task ใหม่
                            </button>
                        </div>
                        <table class="w-full text-left text-sm text-slate-600 min-w-[600px]">
                            <thead class="bg-slate-50">
                                <tr>
                                    <th class="p-3">Icon</th>
                                    <th class="p-3">ชื่อ Task Template</th>
                                    <th class="p-3">ตัวเลือก (Task Chains)</th>
                                    <th class="p-3">เปิด/ปิด</th>
                                    <th class="p-3">จัดการ</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="border-b">
                                    <td class="p-3"><i class="fas fa-map-marker-alt text-blue-500 text-lg"></i></td>
                                    <td class="p-3 font-medium">เลือกจุดรับ (Group A)</td>
                                    <td class="p-3">3 (A01, A02, A03)</td>
                                    <td class="p-3">
                                        <label class="switch"><input type="checkbox" checked><span
                                                class="slider"></span></label>
                                    </td>
                                    <td class="p-3">
                                        <button class="text-blue-500 hover:text-blue-700 open-task-modal-btn"
                                            data-task-id="T-001"><i class="fas fa-edit"></i> แก้ไข</button>
                                    </td>
                                </tr>
                                <tr class="border-b">
                                    <td class="p-3"><i class="fas fa-arrow-up text-blue-500 text-lg"></i></td>
                                    <td class="p-3 font-medium">ยกของ</td>
                                    <td class="p-3">2 (30cm, 50cm)</td>
                                    <td class="p-3">
                                        <label class="switch"><input type="checkbox" checked><span
                                                class="slider"></span></label>
                                    </td>
                                    <td class="p-3">
                                        <button class="text-blue-500 hover:text-blue-700 open-task-modal-btn"
                                            data-task-id="T-002"><i class="fas fa-edit"></i> แก้ไข</button>
                                    </td>
                                </tr>
                                <tr class="border-b">
                                    <td class="p-3"><i class="fas fa-arrow-down text-green-500 text-lg"></i></td>
                                    <td class="p-3 font-medium">วางของ</td>
                                    <td class="p-3">1 (0cm)</td>
                                    <td class="p-3">
                                        <label class="switch"><input type="checkbox" checked><span
                                                class="slider"></span></label>
                                    </td>
                                    <td class="p-3">
                                        <button class="text-blue-500 hover:text-blue-700 open-task-modal-btn"
                                            data-task-id="T-003"><i class="fas fa-edit"></i> แก้ไข</button>
                                    </td>
                                </tr>
                                <tr class="border-b">
                                    <td class="p-3"><i class="fas fa-map-marker-alt text-green-500 text-lg"></i></td>
                                    <td class="p-3 font-medium text-slate-400">เลือกจุดวาง (Group B)</td>
                                    <td class="p-3 text-slate-400">3 (B01, B02, B03)</td>
                                    <td class="p-3">
                                        <label class="switch"><input type="checkbox"><span
                                                class="slider"></span></label>
                                    </td>
                                    <td class="p-3">
                                        <button class="text-blue-500 hover:text-blue-700 open-task-modal-btn"
                                            data-task-id="T-004"><i class="fas fa-edit"></i> แก้ไข</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </section>

                <!-- 
                  Page: Consolidated Add Order (Parent) 
                -->
                <section id="page-add-order-parent" class="page-section space-y-6">

                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-lg font-semibold text-slate-700">สำเร็จ</h3>
                            <p class="text-4xl font-bold text-green-600">8</p>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-lg font-semibold text-slate-700">ยกเลิก / ล้มเหลว</h3>
                            <p class="text-4xl font-bold text-red-600">3</p>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-lg font-semibold text-slate-700">กำลังทำงาน</h3>
                            <p class="text-4xl font-bold text-blue-600">4</p>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-lg font-semibold text-slate-700">รอทำงาน</h3>
                            <p class="text-4xl font-bold text-yellow-600">5</p>
                        </div>
                    </div>
                    <div id="consolidated-order-list-anchor" class="bg-white p-6 rounded-lg shadow-md overflow-x-auto">
                        <h3 class="text-lg font-semibold mb-4 text-slate-700">ภาพรวมคำสั่ง (Consolidated Order List)
                        </h3>
                        <table class="w-full text-left text-sm text-slate-600 min-w-[900px]">
                            <thead class="bg-slate-50">
                                <tr>
                                    <th class="p-3">Order ID</th>
                                    <th class="p-3">Plan</th>
                                    <th class="p-3">AMR</th>
                                    <th class="p-3">สถานะ</th>
                                    <th class="p-3">Step</th>
                                    <th class="p-3">เวลาที่ใช้</th>
                                    <th class="p-3">จัดการ</th>
                                </tr>
                            </thead>
                            <tbody id="orders-table-body-consolidated">
                                <!-- JS will populate this -->
                            </tbody>
                        </table>
                    </div>

                </section>

                <!-- Page: Order Plan 101 (Sub-page) -->
                <section id="page-order-plan-101" class="page-section space-y-6">
                    <p class="text-slate-600">ติดตามคำสั่งที่มีอยู่ หรือสร้าง Order ใหม่โดยเลือกจุดรับและจุดวาง</p>

                    <div class="bg-white p-6 rounded-lg shadow-md space-y-6">
                        <!-- Step 1: Select Pickup Point -->
                        <div>
                            <h4 class="text-md font-semibold mb-3 text-slate-700">1. เลือกจุดรับ (Group A)</h4>
                            <div class="flex flex-wrap gap-3" id="pickup-group-a">
                                <button class="order-point-btn status-available" data-group="a" data-value="A01">
                                    <i class="fas fa-map-marker-alt mr-2"></i>A01
                                </button>
                                <button class="order-point-btn status-available" data-group="a" data-value="A02">
                                    <i class="fas fa-map-marker-alt mr-2"></i>A02
                                </button>
                                <button class="order-point-btn status-available" data-group="a" data-value="A03">
                                    <i class="fas fa-map-marker-alt mr-2"></i>A03
                                </button>
                                <button class="order-point-btn status-available" data-group="a" data-value="A04">
                                    <i class="fas fa-map-marker-alt mr-2"></i>A04
                                </button>
                                <button class="order-point-btn status-available" data-group="a" data-value="A05">
                                    <i class="fas fa-map-marker-alt mr-2"></i>A05
                                </button>
                                <button class="order-point-btn status-available" data-group="a" data-value="A06">
                                    <i class="fas fa-map-marker-alt mr-2"></i>A06
                                </button>
                                <button class="order-point-btn status-available" data-group="a" data-value="A07">
                                    <i class="fas fa-map-marker-alt mr-2"></i>A07
                                </button>
                                <button class="order-point-btn status-available" data-group="a" data-value="A08">
                                    <i class="fas fa-map-marker-alt mr-2"></i>A08
                                </button>
                            </div>
                        </div>

                        <!-- Step 2: Select Dropoff Point -->
                        <div>
                            <h4 class="text-md font-semibold mb-3 text-slate-700">2. เลือกจุดวาง (Group B)</h4>
                            <div class="flex flex-wrap gap-3" id="dropoff-group-b">
                                <button class="order-point-btn status-available" data-group="b" data-value="B01">
                                    <i class="fas fa-flag-checkered mr-2"></i>B01
                                </button>
                                <button class="order-point-btn status-available" data-group="b" data-value="B02">
                                    <i class="fas fa-flag-checkered mr-2"></i>B02
                                </button>
                                <button class="order-point-btn status-available" data-group="b" data-value="B03">
                                    <i class="fas fa-flag-checkered mr-2"></i>B03
                                </button>
                                <button class="order-point-btn status-available" data-group="b" data-value="B04">
                                    <i class="fas fa-flag-checkered mr-2"></i>B04
                                </button>
                                <button class="order-point-btn status-available" data-group="b" data-value="B05">
                                    <i class="fas fa-flag-checkered mr-2"></i>B05
                                </button>
                                <button class="order-point-btn status-available" data-group="b" data-value="B06">
                                    <i class="fas fa-flag-checkered mr-2"></i>B06
                                </button>
                                <button class="order-point-btn status-available" data-group="b" data-value="B07">
                                    <i class="fas fa-flag-checkered mr-2"></i>B07
                                </button>
                                <button class="order-point-btn status-available" data-group="b" data-value="B08">
                                    <i class="fas fa-flag-checkered mr-2"></i>B08
                                </button>
                            </div>
                        </div>

                        <!-- Step 3: Confirm -->
                        <div class="border-t pt-6">
                            <button id="confirm-order-101"
                                class="w-full md:w-auto bg-green-600 text-white px-8 py-3 rounded-lg shadow text-lg font-bold hover:bg-green-700 transition disabled:opacity-50 disabled:cursor-not-allowed"
                                disabled>
                                <i class="fas fa-check-circle mr-2"></i>ยืนยันการสั่งงาน
                            </button>
                            <p id="order-summary-101" class="text-slate-500 mt-3">กรุณาเลือกจุดรับและจุดวาง</p>
                        </div>
                    </div>

                    <!-- Work Sequence Display for Orders -->
                    <div id="orders-work-sequence-plan-101" class="bg-white p-6 rounded-lg shadow-md space-y-4">
                        <!-- JS will populate this -->
                    </div>
                </section>

                <!-- Page: Order Plan 102 (Sub-page) -->
                <section id="page-order-plan-102" class="page-section space-y-6">
                    <p class="text-slate-600">ติดตามคำสั่งที่มีอยู่ หรือสร้าง Order ใหม่โดยเลือกจุดรับและจุดวาง</p>

                    <div class="bg-white p-6 rounded-lg shadow-md space-y-6">
                        <!-- Step 1: Select Pickup Point -->
                        <div>
                            <h4 class="text-md font-semibold mb-3 text-slate-700">1. เลือกจุดรับ (Group C)</h4>
                            <div class="flex flex-wrap gap-3" id="pickup-group-c">
                                <button class="order-point-btn status-available" data-group="c" data-value="C01">
                                    <i class="fas fa-map-marker-alt mr-2"></i>C01
                                </button>
                                <button class="order-point-btn status-available" data-group="c" data-value="C02">
                                    <i class="fas fa-map-marker-alt mr-2"></i>C02
                                </button>
                                <button class="order-point-btn status-available" data-group="c" data-value="C03">
                                    <i class="fas fa-map-marker-alt mr-2"></i>C03
                                </button>
                                <button class="order-point-btn status-available" data-group="c" data-value="C04">
                                    <i class="fas fa-map-marker-alt mr-2"></i>C04
                                </button>
                                <button class="order-point-btn status-available" data-group="c" data-value="C05">
                                    <i class="fas fa-map-marker-alt mr-2"></i>C05
                                </button>
                                <button class="order-point-btn status-available" data-group="c" data-value="C06">
                                    <i class="fas fa-map-marker-alt mr-2"></i>C06
                                </button>
                                <button class="order-point-btn status-available" data-group="c" data-value="C07">
                                    <i class="fas fa-map-marker-alt mr-2"></i>C07
                                </button>
                                <button class="order-point-btn status-available" data-group="c" data-value="C08">
                                    <i class="fas fa-map-marker-alt mr-2"></i>C08
                                </button>
                            </div>
                        </div>

                        <!-- Step 2: Select Dropoff Point -->
                        <div>
                            <h4 class="text-md font-semibold mb-3 text-slate-700">2. เลือกจุดวาง (Group D)</h4>
                            <div class="flex flex-wrap gap-3" id="dropoff-group-d">
                                <button class="order-point-btn status-available" data-group="d" data-value="D01">
                                    <i class="fas fa-flag-checkered mr-2"></i>D01
                                </button>
                                <button class="order-point-btn status-available" data-group="d" data-value="D02">
                                    <i class="fas fa-flag-checkered mr-2"></i>D02
                                </button>
                                <button class="order-point-btn status-available" data-group="d" data-value="D03">
                                    <i class="fas fa-flag-checkered mr-2"></i>D03
                                </button>
                                <button class="order-point-btn status-available" data-group="d" data-value="D04">
                                    <i class="fas fa-flag-checkered mr-2"></i>D04
                                </button>
                                <button class="order-point-btn status-available" data-group="d" data-value="D05">
                                    <i class="fas fa-flag-checkered mr-2"></i>D05
                                </button>
                                <button class="order-point-btn status-available" data-group="d" data-value="D06">
                                    <i class="fas fa-flag-checkered mr-2"></i>D06
                                </button>
                                <button class="order-point-btn status-available" data-group="d" data-value="D07">
                                    <i class="fas fa-flag-checkered mr-2"></i>D07
                                </button>
                                <button class="order-point-btn status-available" data-group="d" data-value="D08">
                                    <i class="fas fa-flag-checkered mr-2"></i>D08
                                </button>
                            </div>
                        </div>

                        <!-- Step 3: Confirm -->
                        <div class="border-t pt-6">
                            <button id="confirm-order-102"
                                class="w-full md:w-auto bg-green-600 text-white px-8 py-3 rounded-lg shadow text-lg font-bold hover:bg-green-700 transition disabled:opacity-50 disabled:cursor-not-allowed"
                                disabled>
                                <i class="fas fa-check-circle mr-2"></i>ยืนยันการสั่งงาน
                            </button>
                            <p id="order-summary-102" class="text-slate-500 mt-3">กรุณาเลือกจุดรับและจุดวาง</p>
                        </div>
                    </div>

                    <!-- Work Sequence Display for Orders -->
                    <div id="orders-work-sequence-plan-102" class="bg-white p-6 rounded-lg shadow-md space-y-4">
                        <!-- JS will populate this -->
                    </div>
                </section>

                <!-- Page: Order Plan 103 (Sub-page) -->
                <section id="page-order-plan-103" class="page-section space-y-6">
                    <p class="text-slate-600">ติดตามคำสั่งที่มีอยู่ (User นี้ไม่มีสิทธิ์สร้าง Order ใหม่)</p>

                    <!-- Work Sequence Display for Orders -->
                    <div id="orders-work-sequence-plan-103" class="bg-white p-6 rounded-lg shadow-md space-y-4">
                        <!-- JS will populate this -->
                    </div>
                </section>

                <!-- 
                  Page: Consolidated Storage (Parent)
                -->
                <section id="page-storage-parent" class="page-section space-y-6">
                    <p class="text-slate-600">จัดการสถานะ "ว่าง" หรือ "มีของ" ของจุดจัดเก็บทั้งหมดในระบบ (Digital Twin)
                    </p>

                    <div id="storage-ab-anchor" class="bg-white p-6 rounded-lg shadow-md space-y-6">
                        <h3 class="text-lg font-semibold text-slate-700">จุดจัดเก็บ: Group A (จุดรับ)</h3>
                        <div class="flex flex-wrap gap-3" id="storage-group-a">
                            <!-- JS will populate this -->
                        </div>

                        <h3 class="text-lg font-semibold text-slate-700 mt-6">จุดจัดเก็บ: Group B (จุดวาง)</h3>
                        <div class="flex flex-wrap gap-3" id="storage-group-b">
                            <!-- JS will populate this -->
                        </div>
                    </div>

                    <div id="storage-cd-anchor" class="bg-white p-6 rounded-lg shadow-md space-y-6">
                        <h3 class="text-lg font-semibold text-slate-700">จุดจัดเก็บ: Group C (จุดรับ)</h3>
                        <div class="flex flex-wrap gap-3" id="storage-group-c">
                            <!-- JS will populate this -->
                        </div>

                        <h3 class="text-lg font-semibold text-slate-700 mt-6">จุดจัดเก็บ: Group D (จุดวาง)</h3>
                        <div class="flex flex-wrap gap-3" id="storage-group-d">
                            <!-- JS will populate this -->
                        </div>
                    </div>
                </section>

                <!-- Page: Storage Plan A/B (Sub-page) -->
                <section id="page-storage-ab" class="page-section space-y-6">
                    <p class="text-slate-600">จัดการสถานะ "ว่าง" หรือ "มีของ" ของจุดจัดเก็บ Group A และ B</p>

                    <div class="bg-white p-6 rounded-lg shadow-md space-y-6">
                        <h3 class="text-lg font-semibold text-slate-700">จุดจัดเก็บ: Group A (จุดรับ)</h3>
                        <div class="flex flex-wrap gap-3" id="storage-group-a-sub">
                            <!-- JS will populate this -->
                        </div>

                        <h3 class="text-lg font-semibold text-slate-700 mt-6">จุดจัดเก็บ: Group B (จุดวาง)</h3>
                        <div class="flex flex-wrap gap-3" id="storage-group-b-sub">
                            <!-- JS will populate this -->
                        </div>
                    </div>
                </section>

                <!-- Page: Storage Plan C/D (Sub-page) -->
                <section id="page-storage-cd" class="page-section space-y-6">
                    <p class="text-slate-600">จัดการสถานะ "ว่าง" หรือ "มีของ" ของจุดจัดเก็บ Group C และ D</p>

                    <div class="bg-white p-6 rounded-lg shadow-md space-y-6">
                        <h3 class="text-lg font-semibold text-slate-700">จุดจัดเก็บ: Group C (จุดรับ)</h3>
                        <div class="flex flex-wrap gap-3" id="storage-group-c-sub">
                            <!-- JS will populate this -->
                        </div>

                        <h3 class="text-lg font-semibold text-slate-700 mt-6">จุดจัดเก็บ: Group D (จุดวาง)</h3>
                        <div class="flex flex-wrap gap-3" id="storage-group-d-sub">
                            <!-- JS will populate this -->
                        </div>
                    </div>
                </section>

                <!-- Page: Storage Plan D/E (Sub-page) -->
                <section id="page-storage-de" class="page-section space-y-6">
                    <p class="text-slate-600">จัดการสถานะ "ว่าง" หรือ "มีของ" ของจุดจัดเก็บ Group D และ E</p>

                    <div id="storage-de-anchor" class="bg-white p-6 rounded-lg shadow-md space-y-6">
                        <h3 class="text-lg font-semibold text-slate-700">จุดจัดเก็บ: Group D (จุดรับ)</h3>
                        <div class="flex flex-wrap gap-3" id="storage-group-d-sub-de">
                            <!-- JS will populate this -->
                        </div>

                        <h3 class="text-lg font-semibold text-slate-700 mt-6">จุดจัดเก็บ: Group E (จุดวาง)</h3>
                        <div class="flex flex-wrap gap-3" id="storage-group-e-sub">
                            <!-- JS will populate this -->
                        </div>
                    </div>
                </section>


                <!-- Page: Settings -->
                <section id="page-settings" class="page-section space-y-6">
                    <p class="text-slate-600">ตั้งค่าระบบ ผู้ใช้งาน และสิทธิ์การเข้าถึง</p>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-slate-700">จัดการผู้ใช้งาน (User Management)</h3>
                            <button id="add-user-btn"
                                class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition">
                                <i class="fas fa-plus mr-2"></i>เพิ่มผู้ใช้
                            </button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm text-slate-600 min-w-[600px]">
                                <thead class="bg-slate-50">
                                    <tr>
                                        <th class="p-3">Username</th>
                                        <th class="p-3">วันหมดสิทธิ์</th>
                                        <th class="p-3">สถานะ</th>
                                        <th class="p-3">จัดการ</th>
                                    </tr>
                                </thead>
                                <tbody id="users-table-body">
                                    <!-- JS will populate this -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- Page: Recommendations -->
                <section id="page-recommend" class="page-section space-y-6">
                    <p class="text-slate-600">คำแนะนำและแนวทางปฏิบัติ (Best Practices)
                        สำหรับการออกแบบสถาปัตยกรรมระบบควบคุม AMR บน Node-RED</p>

                    <div class="bg-white p-6 rounded-lg shadow-md space-y-4">
                        <h3 class="text-lg font-semibold text-slate-700">1. สถาปัตยกรรมที่แนะนำ (Node-RED Centric)</h3>
                        <p>จากข้อจำกัดที่ต้องใช้ Node-RED เป็นหลัก และรองรับทั้ง MQTT, Modbus, และเชื่อมต่อ Roboshop
                            (สันนิษฐานว่าผ่าน API หรือ Database) สถาปัตยกรรมควรเป็นดังนี้:</p>
                        <ul class="list-disc list-inside space-y-2 text-slate-600">
                            <li><strong>Core Logic (Node-RED):</strong> ใช้ Node-RED เป็นศูนย์กลางจัดการ Flow ทั้งหมด
                                (Task, Plan, Order Management)</li>
                            <li><strong>Device Layer (Adaptors):</strong>
                                <ul>
                                    <li><strong class="text-blue-600">MQTT Nodes:</strong> สำหรับ AMR รุ่นใหม่
                                        และอุปกรณ์ IoT (ประตู, ไฟ)</li>
                                    <li><strong class="text-blue-600">Modbus Nodes:</strong> (เช่น
                                        `node-red-contrib-modbus`) สำหรับ AMR รุ่นเก่า</li>
                                    <li><strong class="text-blue-600">HTTP/Database Nodes:</strong> สำหรับเชื่อมต่อ
                                        Roboshop และ WMS</li>
                                </ul>
                            </li>
                            <li><strong>Presentation Layer (Dashboard):</strong>
                                <ul>
                                    <li><strong class="text-purple-600">node-red-dashboard (แนะนำ):</strong> สร้าง UI
                                        ทั้งหมดนี้โดยตรงบน Node-RED เพื่อความรวดเร็วและง่ายต่อการเชื่อมโยง Flow</li>
                                    <li><strong class="text-purple-600">Custom Web App (ที่คุณทำอยู่):</strong> (เช่น
                                        React/Vue/HTML) เชื่อมต่อกับ Node-RED ผ่าน WebSocket
                                        (node-red-contrib-websocket) หรือ HTTP API</li>
                                </ul>
                            </li>
                            <li><strong>Data Layer (Database):</strong>
                                <ul>
                                    <li><strong class="text-green-600">Internal (Flow Context):</strong> ใช้ `flow` หรือ
                                        `global` context สำหรับเก็บสถานะ Real-time (ตำแหน่ง AMR, สถานะ Storage)</li>
                                    <li><strong class="text-green-600">Persistent (Database):</strong> ใช้ฐานข้อมูล
                                        (เช่น SQLite, MySQL, InfluxDB) สำหรับเก็บ Logs, Order History, และ Analytics
                                        Data</li>
                                </ul>
                            </li>
                        </ul>
                    </div>

                    <div class="bg-white p-6 rounded-lg shadow-md space-y-4">
                        <h3 class="text-lg font-semibold text-slate-700">2. การจัดการ Task และ Plan (State Machine)</h3>
                        <p>หัวใจของระบบนี้คือ "Order" ซึ่งควรถูกจัดการแบบ "State Machine" (เครื่องสถานะ) ใน Node-RED</p>
                        <ul class="list-disc list-inside space-y-2 text-slate-600">
                            <li>เมื่อ Order ถูกสร้าง (จาก UI), Node-RED จะสร้าง "State" ของ Order นั้นๆ (เช่น `order_id:
                                1023, plan: 101, current_task: 0, status: 'WAITING'`)</li>
                            <li><strong>Task Executor Flow:</strong> Flow หลักจะวนลูปตรวจสอบ Order ที่ `WAITING` เมื่อพบ
                                AMR ที่ว่าง (และรองรับ Plan นั้น) จะเริ่มทำงาน</li>
                            <li>Flow จะอ่าน Task ปัจจุบัน (เช่น `Task 0: Go to A01`) ส่งคำสั่ง (MQTT/Modbus) ไปยัง AMR
                            </li>
                            <li>AMR ตอบกลับ (เช่น `status: 'ARRIVED_AT_A01'`), Node-RED ตรวจสอบ, อัปเดต State (เช่น
                                `current_task: 1, status: 'EXECUTING_LIFT'`)</li>
                            <li><strong>User-in-the-Loop:</strong> ถ้า Task เป็น `WAIT_CONFIRM`, State จะเปลี่ยนเป็น
                                `WAITING_USER` และส่งข้อมูลไปที่ UI ผ่าน WebSocket UI ส่ง "Confirm" กลับมา, State
                                เปลี่ยนเป็น `EXECUTING`</li>
                            <li><strong>Change Destination:</strong> ถ้า Task เป็น `CHANGE_DEST`, State จะเปลี่ยนเป็น
                                `WAITING_CHANGE` UI จะแสดงปุ่มให้แก้ Task ที่เหลือใน State เมื่อแก้เสร็จ State
                                จะกลับเป็น `EXECUTING`</li>
                        </ul>
                    </div>

                    <div class="bg-white p-6 rounded-lg shadow-md space-y-4">
                        <h3 class="text-lg font-semibold text-slate-700">3. การป้องกันการ Copy Code (Code Obfuscation)
                        </h3>
                        <p>การเข้ารหัสโค้ดใน Node-RED ทำได้ยาก (เพราะเป็น JSON และ JS) แต่มีแนวทางดังนี้:</p>
                        <ul class="list-disc list-inside space-y-2 text-slate-600">
                            <li><strong>JS Obfuscation:</strong> เขียน Logic ที่ซับซ้อนใน "Function Node" จากนั้นนำโค้ด
                                JS ใน Function Node นั้นไปผ่าน "JS Obfuscator" (เช่น `javascript-obfuscator`)
                                แล้วค่อยนำกลับมาวาง โค้ดจะอ่านไม่ออก</li>
                            <li><strong>Subflows:</strong> ซ่อน Logic ที่ซับซ้อนไว้ใน "Subflow" แม้จะไม่ใช่การเข้ารหัส
                                แต่ก็ทำให้การ Copy ไปใช้งานตรงๆ ยากขึ้น</li>
                            <li><strong>External Modules:</strong> เขียน Logic สำคัญเป็น Custom Node-RED Node (NPM
                                Module) ส่วนตัว แล้วใช้วิธี Obfuscate โค้ดใน Module นั้นก่อนเผยแพร่</li>
                        </ul>
                    </div>
                </section>

                <!-- Page: Live Order Tracking -->
                <section id="page-working" class="page-section space-y-6">
                    <div class="flex justify-between items-center">
                        <h3 id="working-title" class="text-xl font-semibold text-slate-700">ติดตาม Order: ...</h3>
                        <div class="flex gap-2">
                            <button id="cancel-order-working-btn"
                                class="bg-red-500 text-white px-4 py-2 rounded-lg shadow-sm hover:bg-red-600 transition order-cancel-btn"
                                data-order-id="">
                                <i class="fas fa-times mr-2"></i>ยกเลิก
                            </button>
                            <button id="back-to-orders-btn"
                                class="bg-slate-200 text-slate-700 px-4 py-2 rounded-lg shadow-sm hover:bg-slate-300 transition">
                                <i class="fas fa-arrow-left mr-2"></i>กลับไปหน้ารวม
                            </button>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <div id="working-plan-container" class="flex items-center overflow-x-auto p-2">
                            <p class="text-slate-400">กำลังโหลด...</p>
                        </div>
                    </div>

                    <div id="working-controls-section" class="bg-white p-6 rounded-lg shadow-md">
                        <h4 class="text-lg font-semibold text-slate-700 mb-4">คำสั่ง (Controls)</h4>
                        <div id="working-controls">
                            <p class="text-slate-500">ไม่มีคำสั่งพิเศษสำหรับ Order นี้</p>
                        </div>
                    </div>
                </section>

            </div>
        </main>
    </div>

    <!-- Modals -->

    <!-- (Req 1) AMR Editor Modal -->
    <div id="amr-editor-modal" class="modal">
        <div class="modal-backdrop"></div>
        <div class="modal-container modal-container-sm">
            <div class="flex justify-between items-center mb-4">
                <h3 id="amr-editor-title" class="text-lg font-semibold text-slate-700">เพิ่ม/แก้ไข AMR</h3>
                <button class="modal-close text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
            </div>
            <form class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-600 mb-1">ชื่อของ AMR</label>
                    <input id="amr-name-input" type="text" placeholder="เช่น AMR-001"
                        class="w-full p-2 border rounded-lg bg-slate-50">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-600 mb-1">IP ของ AMR</label>
                        <input id="amr-ip-input" type="text" placeholder="192.168.1.101"
                            class="w-full p-2 border rounded-lg bg-slate-50">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-600 mb-1">รุ่นของ AMR</label>
                        <input id="amr-model-input" type="text" placeholder="MiR 250"
                            class="w-full p-2 border rounded-lg bg-slate-50">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-600 mb-1">Home Task</label>
                        <input id="amr-home-task-input" type="text" placeholder="Task ID (เช่น 901)"
                            class="w-full p-2 border rounded-lg bg-slate-50">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-600 mb-1">Home Point</label>
                        <input id="amr-home-point-input" type="text" placeholder="Point ID (เช่น H01)"
                            class="w-full p-2 border rounded-lg bg-slate-50">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-600 mb-1">Charge Task</label>
                        <input id="amr-charge-task-input" type="text" placeholder="Task ID (เช่น 902)"
                            class="w-full p-2 border rounded-lg bg-slate-50">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-600 mb-1">Charge Point</label>
                        <input id="amr-charge-point-input" type="text" placeholder="Point ID (เช่น C01)"
                            class="w-full p-2 border rounded-lg bg-slate-50">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-600 mb-1">Cancel Task</label>
                        <input id="amr-cancel-task-input" type="text" placeholder="Task ID (เช่น 999)"
                            class="w-full p-2 border rounded-lg bg-slate-50">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-600 mb-1">Priority</label>
                        <input id="amr-priority-input" type="number" placeholder="1-10"
                            class="w-full p-2 border rounded-lg bg-slate-50">
                    </div>
                </div>
                <div class="flex justify-end pt-4">
                    <button type="button"
                        class="bg-blue-600 text-white px-6 py-2 rounded-lg shadow hover:bg-blue-700">บันทึก</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Plan Editor Modal (Req 2: Added AMR Checklist) -->
    <div id="plan-editor-modal" class="modal">
        <div class="modal-backdrop"></div>
        <div class="modal-container modal-container-lg">
            <div class="flex justify-between items-center mb-4">
                <h3 id="plan-editor-title" class="text-lg font-semibold text-slate-700">แก้ไขแผนงาน</h3>
                <button class="modal-close text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Left Column: Plan Details & AMRs -->
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-600 mb-1">ชื่อแผนงาน</label>
                        <input id="plan-name-input" type="text" class="w-full p-2 border rounded-lg bg-slate-50">
                    </div>

                    <!-- (Req 2) AMR Assignment -->
                    <div>
                        <label class="block text-sm font-medium text-slate-600 mb-2">กำหนด AMR ที่ใช้งานได้</label>
                        <div class="grid grid-cols-2 gap-2 p-3 bg-slate-50 rounded-lg border max-h-48 overflow-y-auto">
                            <!-- Mockup AMR List -->
                            <div><label class="flex items-center"><input type="checkbox" class="form-checkbox" checked>
                                    AMR-001</label></div>
                            <div><label class="flex items-center"><input type="checkbox" class="form-checkbox" checked>
                                    AMR-002</label></div>
                            <div><label class="flex items-center"><input type="checkbox" class="form-checkbox">
                                    AMR-003</label></div>
                            <div><label class="flex items-center"><input type="checkbox" class="form-checkbox" checked>
                                    AMR-004</label></div>
                        </div>
                    </div>

                    <!-- Task Library (Hidden by default) -->
                    <div id="plan-task-library" class="hidden space-y-2">
                        <h4 class="text-md font-semibold text-slate-600">เลือก Task ที่จะเพิ่ม</h4>
                        <div class="bg-slate-50 border rounded-lg p-3 max-h-60 overflow-y-auto space-y-2">
                            <!-- Mockup Task Library -->
                            <button
                                class="w-full text-left p-2 bg-white rounded-lg border hover:bg-slate-100 add-task-from-lib-btn"
                                data-task-id="T-001">
                                <i class="fas fa-map-marker-alt text-blue-500 mr-2"></i>เลือกจุดรับ (Group A)
                            </button>
                            <button
                                class="w-full text-left p-2 bg-white rounded-lg border hover:bg-slate-100 add-task-from-lib-btn"
                                data-task-id="T-002">
                                <i class="fas fa-arrow-up text-blue-500 mr-2"></i>ยกของ
                            </button>
                            <button
                                class="w-full text-left p-2 bg-white rounded-lg border hover:bg-slate-100 add-task-from-lib-btn"
                                data-task-id="T-003">
                                <i class="fas fa-arrow-down text-green-500 mr-2"></i>วางของ
                            </button>
                            <button
                                class="w-full text-left p-2 bg-white rounded-lg border hover:bg-slate-100 add-task-from-lib-btn"
                                data-task-id="T-004">
                                <i class="fas fa-map-marker-alt text-green-500 mr-2"></i>เลือกจุดวาง (Group B)
                            </button>
                        </div>
                        <button id="cancel-add-task-btn"
                            class="text-sm text-slate-500 hover:text-red-600">ยกเลิก</button>
                    </div>

                </div>

                <!-- Right Column: Task Sequence -->
                <div class="md:col-span-2">
                    <h4 class="text-md font-semibold text-slate-600 mb-2">ลำดับการทำงาน (Task Sequence)</h4>
                    <div id="plan-task-list"
                        class="space-y-2 min-h-[200px] bg-slate-50 p-2 rounded-lg border border-dashed">
                        <!-- Draggable tasks will be populated here -->
                    </div>
                    <div class="flex space-x-2 mt-3">
                        <button id="add-task-to-plan-btn"
                            class_name="flex-1 bg-blue-100 text-blue-700 px-4 py-2 rounded-lg hover:bg-blue-200 text-sm">
                            <i class="fas fa-plus mr-1"></i>เพิ่ม Task
                        </button>
                        <button id="add-confirm-task-btn"
                            class="flex-1 bg-yellow-100 text-yellow-700 px-4 py-2 rounded-lg hover:bg-yellow-200 text-sm">
                            <i class="fas fa-user-clock mr-1"></i>เพิ่ม Confirm
                        </button>
                        <button id="add-change-dest-task-btn"
                            class="flex-1 bg-purple-100 text-purple-700 px-4 py-2 rounded-lg hover:bg-purple-200 text-sm">
                            <i class="fas fa-exchange-alt mr-1"></i>เพิ่ม เปลี่ยนจุดวาง
                        </button>
                    </div>
                </div>
            </div>

            <div class="flex justify-end pt-6 border-t mt-6">
                <button type="button"
                    class="bg-blue-600 text-white px-6 py-2 rounded-lg shadow hover:bg-blue-700">บันทึกแผนงาน</button>
            </div>
        </div>
    </div>

    <!-- Cancel Order Confirmation Modal -->
    <div id="cancel-order-modal" class="modal">
        <div class="modal-backdrop"></div>
        <div class="modal-container modal-container-sm">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-slate-700">ยืนยันการยกเลิก Order</h3>
                <button class="modal-close text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
            </div>
            <div class="space-y-4">
                <p class="text-slate-600">คุณต้องการยกเลิก Order <span id="cancel-order-id"
                        class="font-semibold"></span> ใช่หรือไม่?</p>
                <p class="text-sm text-slate-500">การยกเลิกนี้ไม่สามารถยกเลิกได้</p>
                <div class="flex justify-end gap-3 pt-4">
                    <button
                        class="modal-close bg-slate-200 text-slate-700 px-6 py-2 rounded-lg hover:bg-slate-300">ยกเลิก</button>
                    <button id="confirm-cancel-order-btn"
                        class="bg-red-600 text-white px-6 py-2 rounded-lg shadow hover:bg-red-700">ยืนยันยกเลิก</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Change Destination Modal (Plan 103 - Group E) -->
    <div id="change-destination-modal" class="modal">
        <div class="modal-backdrop"></div>
        <div class="modal-container modal-container-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-slate-700">เปลี่ยนจุดวาง (Group E)</h3>
                <button class="modal-close text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
            </div>
            <div class="space-y-4">
                <p class="text-slate-600">Order: <span id="change-dest-order-id" class="font-semibold"></span></p>
                <div>
                    <h4 class="text-md font-semibold mb-3 text-slate-700">เลือกจุดวาง (Group E)</h4>
                    <div class="flex flex-wrap gap-3" id="change-dest-group-e">
                        <!-- JS will populate this -->
                    </div>
                </div>
                <div class="flex justify-end gap-3 pt-4">
                    <button
                        class="modal-close bg-slate-200 text-slate-700 px-6 py-2 rounded-lg hover:bg-slate-300">ยกเลิก</button>
                    <button id="confirm-change-dest-btn"
                        class="bg-blue-600 text-white px-6 py-2 rounded-lg shadow hover:bg-blue-700"
                        disabled>ยืนยัน</button>
                </div>
            </div>
        </div>
    </div>

    <!-- (Req 3) Task Editor Modal -->
    <div id="task-editor-modal" class="modal">
        <div class="modal-backdrop"></div>
        <div class="modal-container modal-container-lg">
            <div class="flex justify-between items-center mb-4">
                <h3 id="task-editor-title" class="text-lg font-semibold text-slate-700">แก้ไข Task Template</h3>
                <button class="modal-close text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
            </div>
            <form class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-600 mb-1">ชื่อ Task Template</label>
                        <input id="task-name-input" type="text" class="w-full p-2 border rounded-lg bg-slate-50">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-600 mb-1">Icon (Font Awesome Class)</label>
                        <input id="task-icon-input" type="hidden" class="w-full p-2 border rounded-lg bg-slate-50">
                        <div id="task-icon-preview"
                            class="mb-2 p-3 border rounded-lg bg-slate-50 text-center min-h-[3rem] flex items-center justify-center">
                            <i id="task-icon-preview-icon" class="fas fa-question text-2xl text-slate-400"></i>
                        </div>
                        <div id="task-icon-selector"
                            class="grid grid-cols-6 gap-2 p-3 border rounded-lg bg-slate-50 max-h-64 overflow-y-auto">
                            <!-- Icon buttons will be populated by JS -->
                        </div>
                    </div>
                </div>

                <div>
                    <h4 class="text-md font-semibold text-slate-600 mb-2">ตัวเลือก (Task Chains)</h4>
                    <div class="overflow-x-auto max-h-64 overflow-y-auto border rounded-lg">
                        <table class="w-full text-sm">
                            <thead class="bg-slate-50 sticky top-0">
                                <tr>
                                    <th class="p-2 text-left">ชื่อ</th>
                                    <th class="p-2 text-left">ID (Task Chain)</th>
                                    <th class="p-2 text-left">ID (Storage)</th>
                                    <th class="p-2 text-left w-12"></th>
                                </tr>
                            </thead>
                            <tbody id="task-chain-container">
                                <!-- JS will populate this -->
                            </tbody>
                        </table>
                    </div>
                    <button id="add-task-chain-btn" type="button"
                        class="mt-2 bg-blue-100 text-blue-700 px-3 py-1 rounded-lg hover:bg-blue-200 text-sm">
                        <i class="fas fa-plus mr-1"></i>เพิ่มตัวเลือก
                    </button>
                </div>

                <div class="flex justify-end pt-4">
                    <button type="button"
                        class="bg-blue-600 text-white px-6 py-2 rounded-lg shadow hover:bg-blue-700">บันทึก
                        Task</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Storage Management Modal -->
    <div id="storage-confirm-modal" class="modal">
        <div class="modal-backdrop"></div>
        <div class="modal-container modal-container-sm">
            <h3 class="text-lg font-semibold text-slate-700 mb-4">เปลี่ยนสถานะจุดจัดเก็บ</h3>
            <p id="storage-confirm-text" class="mb-4">...</p>
            <div id="storage-item-name-section" class="mb-6 hidden">
                <label class="block text-sm font-medium text-slate-600 mb-2">ชื่อสินค้า</label>
                <input id="storage-item-name-input" type="text" placeholder="กรอกชื่อสินค้า"
                    class="w-full p-2 border rounded-lg">
            </div>
            <div class="flex justify-end space-x-3">
                <button
                    class="modal-close bg-slate-200 text-slate-700 px-4 py-2 rounded-lg hover:bg-slate-300">ยกเลิก</button>
                <button id="storage-modal-confirm-btn"
                    class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">ยืนยัน</button>
            </div>
        </div>
    </div>

    <!-- User Editor Modal -->
    <div id="user-editor-modal" class="modal">
        <div class="modal-backdrop"></div>
        <div class="modal-container modal-container-sm">
            <div class="flex justify-between items-center mb-4">
                <h3 id="user-editor-title" class="text-lg font-semibold text-slate-700">เพิ่ม/แก้ไขผู้ใช้</h3>
                <button class="modal-close text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
            </div>
            <form class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-600 mb-1">Username</label>
                    <input id="user-username-input" type="text" placeholder="เช่น operator01"
                        class="w-full p-2 border rounded-lg bg-slate-50">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-600 mb-1">วันหมดสิทธิ์</label>
                    <input id="user-expiry-input" type="date" class="w-full p-2 border rounded-lg bg-slate-50">
                </div>
                <div id="user-password-section">
                    <label class="block text-sm font-medium text-slate-600 mb-1">รหัสผ่าน</label>
                    <input id="user-password-input" type="password" placeholder="กรอกรหัสผ่าน"
                        class="w-full p-2 border rounded-lg bg-slate-50">
                </div>
                <div id="user-password-confirm-section">
                    <label class="block text-sm font-medium text-slate-600 mb-1">ยืนยันรหัสผ่าน</label>
                    <input id="user-password-confirm-input" type="password" placeholder="ยืนยันรหัสผ่าน"
                        class="w-full p-2 border rounded-lg bg-slate-50">
                </div>
                <div class="flex justify-end pt-4">
                    <button type="button"
                        class="bg-blue-600 text-white px-6 py-2 rounded-lg shadow hover:bg-blue-700">บันทึก</button>
                </div>
            </form>
        </div>
    </div>

    <!-- User Permissions Modal -->
    <div id="user-permissions-modal" class="modal">
        <div class="modal-backdrop"></div>
        <div class="modal-container modal-container-lg">
            <div class="flex justify-between items-center mb-4">
                <h3 id="user-permissions-title" class="text-lg font-semibold text-slate-700">กำหนดสิทธิ์การใช้แผนงาน
                </h3>
                <button class="modal-close text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
            </div>
            <div class="mb-4">
                <p class="text-sm text-slate-600">ผู้ใช้: <strong id="permissions-user-name"
                        class="text-blue-600">...</strong></p>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left text-sm text-slate-600">
                    <thead class="bg-slate-50">
                        <tr>
                            <th class="p-3">Plan</th>
                            <th class="p-3">สิทธิ์สั่งงาน</th>
                            <th class="p-3">สิทธิ์ติดตามงาน</th>
                            <th class="p-3">สิทธิ์จัดการสต็อก</th>
                        </tr>
                    </thead>
                    <tbody id="permissions-table-body">
                        <!-- JS will populate this -->
                    </tbody>
                </table>
            </div>
            <div class="flex justify-end pt-4 border-t mt-4">
                <button type="button"
                    class="bg-blue-600 text-white px-6 py-2 rounded-lg shadow hover:bg-blue-700">บันทึกสิทธิ์</button>
            </div>
        </div>
    </div>

    <!-- Delete User Confirmation Modal -->
    <div id="delete-user-modal" class="modal">
        <div class="modal-backdrop"></div>
        <div class="modal-container modal-container-sm">
            <h3 class="text-lg font-semibold text-slate-700 mb-4">ยืนยันการลบผู้ใช้</h3>
            <p id="delete-user-text" class="mb-6 text-slate-600">คุณต้องการลบผู้ใช้ <strong id="delete-user-name"
                    class="text-red-600">...</strong> หรือไม่?</p>
            <div class="flex justify-end space-x-3">
                <button
                    class="modal-close bg-slate-200 text-slate-700 px-4 py-2 rounded-lg hover:bg-slate-300">ยกเลิก</button>
                <button id="delete-user-confirm-btn"
                    class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">ยืนยันลบ</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Globals
            let mapAnimationId = null;
            let barChart = null;
            let doughnutChart = null;
            let currentStorageBtn = null;

            const sidebar = document.getElementById('sidebar');
            const sidebarToggleBtn = document.getElementById('sidebar-toggle-btn');
            const pageTitle = document.getElementById('page-title');

            const addOrderToggle = document.getElementById('add-order-toggle');
            const addOrderSubmenu = document.getElementById('add-order-submenu');
            const addOrderChevron = document.getElementById('add-order-chevron');
            const storageToggle = document.getElementById('storage-toggle');
            const storageSubmenu = document.getElementById('storage-submenu');
            const storageChevron = document.getElementById('storage-chevron');

            const pageSections = document.querySelectorAll('.page-section');
            const sidebarLinks = document.querySelectorAll('.sidebar-link');

            // Storage Modal
            const storageConfirmModal = document.getElementById('storage-confirm-modal');
            const storageConfirmText = document.getElementById('storage-confirm-text');
            const storageModalConfirmBtn = document.getElementById('storage-modal-confirm-btn');
            const storageItemNameSection = document.getElementById('storage-item-name-section');
            const storageItemNameInput = document.getElementById('storage-item-name-input');

            // Storage data with item names
            const storageData = {
                'A01': { status: 'available', itemName: 'Box A-001' },
                'A02': { status: 'inprogress', itemName: 'Item A-002' },
                'A03': { status: 'unavailable', itemName: '' },
                'A04': { status: 'available', itemName: 'Item XYZ' },
                'A05': { status: 'unavailable', itemName: '' },
                'A06': { status: 'available', itemName: 'Part 123' },
                'A07': { status: 'unavailable', itemName: '' },
                'A08': { status: 'available', itemName: 'Component ABC' },
                'B01': { status: 'unavailable', itemName: '' },
                'B02': { status: 'inprogress', itemName: 'Box B-002' },
                'B03': { status: 'available', itemName: 'Item DEF' },
                'B04': { status: 'unavailable', itemName: '' },
                'B05': { status: 'available', itemName: 'Box B-005' },
                'B06': { status: 'unavailable', itemName: '' },
                'B07': { status: 'unavailable', itemName: '' },
                'B08': { status: 'available', itemName: 'Part 456' },
                'C01': { status: 'available', itemName: 'Item C-001' },
                'C02': { status: 'unavailable', itemName: '' },
                'C03': { status: 'available', itemName: 'Part C-003' },
                'C04': { status: 'unavailable', itemName: '' },
                'C05': { status: 'available', itemName: 'Box C-005' },
                'C06': { status: 'inprogress', itemName: 'Item C-006' },
                'C07': { status: 'unavailable', itemName: '' },
                'C08': { status: 'available', itemName: 'Item C-008' },
                'D01': { status: 'unavailable', itemName: '' },
                'D02': { status: 'available', itemName: 'Item D-002' },
                'D03': { status: 'unavailable', itemName: '' },
                'D04': { status: 'unavailable', itemName: '' },
                'D05': { status: 'available', itemName: 'Part D-005' },
                'D06': { status: 'inprogress', itemName: 'Box D-006' },
                'D07': { status: 'unavailable', itemName: '' },
                'D08': { status: 'available', itemName: 'Box D-008' }
            };

            // Current User (default: operator01, can be changed)
            let currentUser = "operator01";

            // User Permissions Data
            const userPermissionsData = {
                "operator01": [
                    { plan: "Plan 101", canOrder: true, canTrack: true, canManageStorage: true },
                    { plan: "Plan 102", canOrder: true, canTrack: true, canManageStorage: false },
                    { plan: "Plan 103", canOrder: false, canTrack: true, canManageStorage: false }
                ],
                "operator02": [
                    { plan: "Plan 102", canOrder: true, canTrack: true, canManageStorage: true }
                ],
                "operator03": [
                    { plan: "Plan 101", canOrder: false, canTrack: true, canManageStorage: false }
                ]
            };

            // Helper function to check if user has permission for a plan
            function hasStoragePermission(planName) {
                const permissions = userPermissionsData[currentUser] || [];
                const perm = permissions.find(p => p.plan === planName);
                return perm && perm.canManageStorage;
            }

            // Render storage buttons
            function renderStorageButtons(containerId, items, isPickup) {
                const container = document.getElementById(containerId);
                if (!container) return;

                container.innerHTML = items.map(itemId => {
                    const data = storageData[itemId];
                    // Handle missing data with default values
                    if (!data) {
                        return `
                            <button class="order-point-btn storage-toggle-btn status-unavailable" 
                                    data-id="${itemId}" 
                                    data-current-status="unavailable" 
                                    data-name="${itemId}"
                                    data-item-name="">
                                <div class="text-center">${itemId}</div>
                            </button>
                        `;
                    }
                    const status = data.status;
                    const itemName = data.itemName;

                    let btnClass = 'order-point-btn storage-toggle-btn';
                    let isDisabled = status === 'inprogress';
                    let symbol = '';

                    // Color logic based on pickup/dropoff
                    if (isPickup) {
                        // Pickup location: Green if has item, Gray if empty, Yellow if clearing
                        if (status === 'available') {
                            btnClass += ' status-available'; // Green
                        } else if (status === 'inprogress') {
                            btnClass += ' status-inprogress'; // Yellow
                            symbol = '- '; // Clearing symbol only for yellow status
                        } else {
                            btnClass += ' status-unavailable'; // Gray
                        }
                    } else {
                        // Dropoff location: Green if empty, Gray if has item, Yellow if filling
                        if (status === 'unavailable') {
                            btnClass += ' status-available'; // Green (empty is good for dropoff)
                        } else if (status === 'inprogress') {
                            btnClass += ' status-inprogress'; // Yellow
                            symbol = '+ '; // Filling symbol only for yellow status
                        } else {
                            btnClass += ' status-unavailable'; // Gray (has item is not preferred for dropoff)
                        }
                    }

                    // Display text without status text
                    const displayText = itemName ?
                        `<div class="text-center"><div>${itemId}</div><div class="text-xs mt-1 font-normal">${symbol}${itemName}</div></div>` :
                        `<div class="text-center">${itemId}</div>`;

                    return `
                        <button class="${btnClass}" 
                                data-id="${itemId}" 
                                data-current-status="${status}" 
                                data-name="${itemId}"
                                data-item-name="${itemName}"
                                ${isDisabled ? 'disabled title="มี AMR กำลังทำงาน"' : ''}>
                            ${displayText}
                        </button>
                    `;
                }).join('');
            }

            // Render order buttons with item names from storageData
            function renderOrderButtons(containerId, items, iconClass) {
                const container = document.getElementById(containerId);
                if (!container) return;

                container.innerHTML = items.map(itemId => {
                    const data = storageData[itemId];
                    const itemName = data ? data.itemName : '';
                    const status = data ? data.status : 'unavailable';

                    // Determine button class based on status
                    let btnClass = 'order-point-btn';
                    if (status === 'available') {
                        btnClass += ' status-available';
                    } else if (status === 'inprogress') {
                        btnClass += ' status-inprogress';
                    } else {
                        btnClass += ' status-unavailable';
                    }

                    // Display text with item name if available
                    const displayText = itemName ?
                        `<div class="text-center"><div><i class="${iconClass} mr-2"></i>${itemId}</div><div class="text-xs mt-1 font-normal">${itemName}</div></div>` :
                        `<i class="${iconClass} mr-2"></i>${itemId}`;

                    return `
                        <button class="${btnClass}" data-group="${itemId[0].toLowerCase()}" data-value="${itemId}">
                            ${displayText}
                        </button>
                    `;
                }).join('');
            }

            // Render all storage groups
            function renderAllStorageGroups() {
                const groupAItems = ['A01', 'A02', 'A03', 'A04', 'A05', 'A06', 'A07', 'A08'];
                const groupBItems = ['B01', 'B02', 'B03', 'B04', 'B05', 'B06', 'B07', 'B08'];
                const groupCItems = ['C01', 'C02', 'C03', 'C04', 'C05', 'C06', 'C07', 'C08'];
                const groupDItems = ['D01', 'D02', 'D03', 'D04', 'D05', 'D06', 'D07', 'D08'];
                const groupEItems = ['E01', 'E02', 'E03', 'E04', 'E05', 'E06', 'E07', 'E08'];

                // Consolidated storage page - only show plans user has permission for
                const storageABAnchor = document.getElementById('storage-ab-anchor');
                const storageCDAnchor = document.getElementById('storage-cd-anchor');

                if (hasStoragePermission("Plan 101")) {
                    if (storageABAnchor) storageABAnchor.style.display = 'block';
                    renderStorageButtons('storage-group-a', groupAItems, true);
                    renderStorageButtons('storage-group-b', groupBItems, false);
                } else {
                    if (storageABAnchor) storageABAnchor.style.display = 'none';
                }

                if (hasStoragePermission("Plan 102")) {
                    if (storageCDAnchor) storageCDAnchor.style.display = 'block';
                    renderStorageButtons('storage-group-c', groupCItems, true);
                    renderStorageButtons('storage-group-d', groupDItems, false);
                } else {
                    if (storageCDAnchor) storageCDAnchor.style.display = 'none';
                }

                // Plan 103 uses D -> E, handle separately if needed
                // Note: Group E storage buttons would need to be added to HTML if needed

                // Sub pages
                renderStorageButtons('storage-group-a-sub', groupAItems, true);
                renderStorageButtons('storage-group-b-sub', groupBItems, false);
                renderStorageButtons('storage-group-c-sub', groupCItems, true);
                renderStorageButtons('storage-group-d-sub', groupDItems, false);
                renderStorageButtons('storage-group-d-sub-de', groupDItems, true);
                renderStorageButtons('storage-group-e-sub', groupEItems, false);
            }

            // Initialize storage on page load
            renderAllStorageGroups();

            // (Req 1) AMR Editor Modal
            const amrEditorModal = document.getElementById('amr-editor-modal');
            const amrEditorTitle = document.getElementById('amr-editor-title');
            const amrNameInput = document.getElementById('amr-name-input');
            const amrIpInput = document.getElementById('amr-ip-input');
            const amrModelInput = document.getElementById('amr-model-input');
            const amrHomeTaskInput = document.getElementById('amr-home-task-input');
            const amrHomePointInput = document.getElementById('amr-home-point-input');
            const amrChargeTaskInput = document.getElementById('amr-charge-task-input');
            const amrChargePointInput = document.getElementById('amr-charge-point-input');
            const amrCancelTaskInput = document.getElementById('amr-cancel-task-input');
            const amrPriorityInput = document.getElementById('amr-priority-input');

            // (Req 2) Plan Editor Modal
            const planEditorModal = document.getElementById('plan-editor-modal');
            const planEditorTitle = document.getElementById('plan-editor-title');
            const planNameInput = document.getElementById('plan-name-input');
            const planTaskList = document.getElementById('plan-task-list');
            const addTaskToPlanBtn = document.getElementById('add-task-to-plan-btn');
            const addConfirmTaskBtn = document.getElementById('add-confirm-task-btn');
            const addChangeDestTaskBtn = document.getElementById('add-change-dest-task-btn');
            const planTaskLibrary = document.getElementById('plan-task-library');
            const cancelAddTaskBtn = document.getElementById('cancel-add-task-btn');

            // (Req 3) Task Editor Modal
            const taskEditorModal = document.getElementById('task-editor-modal');
            const taskEditorTitle = document.getElementById('task-editor-title');
            const taskNameInput = document.getElementById('task-name-input');
            const taskIconInput = document.getElementById('task-icon-input');
            const taskIconPreview = document.getElementById('task-icon-preview-icon');
            const taskIconSelector = document.getElementById('task-icon-selector');
            const taskChainContainer = document.getElementById('task-chain-container');
            const addTaskChainBtn = document.getElementById('add-task-chain-btn');

            // User Management Modals
            const userEditorModal = document.getElementById('user-editor-modal');
            const userEditorTitle = document.getElementById('user-editor-title');
            const userUsernameInput = document.getElementById('user-username-input');
            const userExpiryInput = document.getElementById('user-expiry-input');
            const userPasswordInput = document.getElementById('user-password-input');
            const userPasswordConfirmInput = document.getElementById('user-password-confirm-input');
            const userPasswordSection = document.getElementById('user-password-section');
            const userPasswordConfirmSection = document.getElementById('user-password-confirm-section');
            const usersTableBody = document.getElementById('users-table-body');

            const userPermissionsModal = document.getElementById('user-permissions-modal');
            const permissionsUserName = document.getElementById('permissions-user-name');
            const permissionsTableBody = document.getElementById('permissions-table-body');

            const deleteUserModal = document.getElementById('delete-user-modal');
            const deleteUserName = document.getElementById('delete-user-name');
            const deleteUserConfirmBtn = document.getElementById('delete-user-confirm-btn');
            let currentDeleteUserId = null;

            // Common Font Awesome icons for task selection
            const commonIcons = [
                // Navigation & Movement
                'fa-map-marker-alt', 'fa-map-pin', 'fa-location-arrow', 'fa-route', 'fa-directions',
                'fa-arrow-up', 'fa-arrow-down', 'fa-arrow-left', 'fa-arrow-right', 'fa-arrows-alt',
                'fa-arrow-circle-up', 'fa-arrow-circle-down', 'fa-arrow-circle-left', 'fa-arrow-circle-right',
                'fa-exchange-alt', 'fa-sync', 'fa-sync-alt', 'fa-redo', 'fa-undo', 'fa-undo-alt',
                // Actions & Operations
                'fa-hand-paper', 'fa-hand-rock', 'fa-hand-holding', 'fa-hand-holding-box',
                'fa-box', 'fa-boxes', 'fa-box-open', 'fa-pallet', 'fa-warehouse', 'fa-archive',
                'fa-truck', 'fa-truck-loading', 'fa-truck-moving', 'fa-shipping-fast', 'fa-dolly',
                'fa-dolly-flatbed', 'fa-forklift', 'fa-robot', 'fa-cog', 'fa-cogs', 'fa-tasks',
                // Status & Control
                'fa-check-circle', 'fa-check', 'fa-times-circle', 'fa-times', 'fa-question-circle',
                'fa-exclamation-circle', 'fa-info-circle', 'fa-ban', 'fa-lock', 'fa-unlock',
                'fa-play', 'fa-pause', 'fa-stop', 'fa-forward', 'fa-backward', 'fa-step-forward',
                'fa-step-backward', 'fa-eject', 'fa-power-off', 'fa-toggle-on', 'fa-toggle-off',
                // User & Interaction
                'fa-user-clock', 'fa-user-check', 'fa-user-times', 'fa-user-cog', 'fa-user-shield',
                'fa-handshake', 'fa-comments', 'fa-bell', 'fa-bell-slash', 'fa-flag', 'fa-flag-checkered',
                // Tools & Equipment
                'fa-wrench', 'fa-tools', 'fa-screwdriver', 'fa-hammer', 'fa-key', 'fa-keyboard',
                'fa-mouse', 'fa-mouse-pointer', 'fa-grip-vertical', 'fa-grip-horizontal', 'fa-grip-lines',
                // Location & Storage
                'fa-home', 'fa-building', 'fa-warehouse', 'fa-store', 'fa-store-alt', 'fa-door-open',
                'fa-door-closed', 'fa-sign-in-alt', 'fa-sign-out-alt', 'fa-map', 'fa-map-marked-alt',
                // Time & Schedule
                'fa-clock', 'fa-calendar', 'fa-calendar-alt', 'fa-calendar-check', 'fa-calendar-times',
                'fa-hourglass-half', 'fa-hourglass-start', 'fa-hourglass-end', 'fa-stopwatch',
                // Safety & Warning
                'fa-shield-alt', 'fa-shield-virus', 'fa-exclamation-triangle', 'fa-radiation',
                'fa-fire', 'fa-fire-extinguisher', 'fa-first-aid', 'fa-ambulance'
            ];

            // Initialize icon selector
            function initIconSelector() {
                if (!taskIconSelector) return;
                taskIconSelector.innerHTML = commonIcons.map(icon => `
                    <button type="button" class="icon-select-btn p-2 border rounded-lg hover:bg-blue-100 hover:border-blue-400 transition text-center ${taskIconInput.value === `fas ${icon}` ? 'bg-blue-200 border-blue-500' : ''}" data-icon="fas ${icon}">
                        <i class="fas ${icon} text-lg"></i>
                    </button>
                `).join('');
            }

            // Update icon preview
            function updateIconPreview(iconClass) {
                if (taskIconPreview) {
                    taskIconPreview.className = `${iconClass} text-2xl text-blue-600`;
                }
                if (taskIconInput) {
                    taskIconInput.value = iconClass;
                }
                // Update selected state in icon selector
                if (taskIconSelector) {
                    taskIconSelector.querySelectorAll('.icon-select-btn').forEach(btn => {
                        if (btn.dataset.icon === iconClass) {
                            btn.classList.add('bg-blue-200', 'border-blue-500');
                        } else {
                            btn.classList.remove('bg-blue-200', 'border-blue-500');
                        }
                    });
                }
            }

            // Mock Data
            const planTaskData = {
                "Plan 101": [
                    { id: "T-001", name: "เลือกจุดรับ (Group A)", icon: "fa-map-marker-alt" },
                    { id: "T-002", name: "ยกของ (30cm)", icon: "fa-arrow-up" },
                    { id: "T-004", name: "เลือกจุดวาง (Group B)", icon: "fa-map-marker-alt" },
                    { id: "T-003", name: "วางของ", icon: "fa-arrow-down" }
                ],
                "Plan 102": [
                    { id: "T-005", name: "เลือกจุดรับ (Group C)", icon: "fa-map-marker-alt" },
                    { id: "T-002", name: "ยกของ (50cm)", icon: "fa-arrow-up" },
                    { id: "C-001", name: "รอผู้ใช้ยืนยัน", icon: "fa-user-clock" },
                    { id: "T-006", name: "เลือกจุดวาง (Group D)", icon: "fa-map-marker-alt" },
                    { id: "T-003", name: "วางของ", icon: "fa-arrow-down" }
                ],
                "Plan 103": [
                    { id: "T-007", name: "เลือกจุดรับ (Group D)", icon: "fa-map-marker-alt" },
                    { id: "T-002", name: "ยกของ (30cm)", icon: "fa-arrow-up" },
                    { id: "C-002", name: "เปลี่ยนจุดวาง (Group E)", icon: "fa-exchange-alt" },
                    { id: "T-008", name: "เลือกจุดวาง (Group E)", icon: "fa-map-marker-alt" },
                    { id: "T-003", name: "วางของ", icon: "fa-arrow-down" }
                ]
            };

            const taskTemplateData = {
                "T-001": {
                    name: "เลือกจุดรับ (Group A)",
                    icon: "fas fa-map-marker-alt",
                    chains: [
                        { label: "A01", chainId: "101", storageId: "S-A01" },
                        { label: "A02", chainId: "102", storageId: "S-A02" },
                        { label: "A03", chainId: "103", storageId: "S-A03" }
                    ]
                },
                "T-002": {
                    name: "ยกของ",
                    icon: "fas fa-arrow-up",
                    chains: [
                        { label: "30cm", chainId: "201", storageId: "" },
                        { label: "50cm", chainId: "202", storageId: "" }
                    ]
                },
                "T-003": {
                    name: "วางของ",
                    icon: "fas fa-arrow-down",
                    chains: [
                        { label: "0cm", chainId: "301", storageId: "" }
                    ]
                }
            };

            const amrData = {
                "AMR-001": { name: "AMR-001", ip: "192.168.1.101", model: "MiR 250", homeTask: "901", homePoint: "H01", chargeTask: "902", chargePoint: "C01", cancelTask: "999", priority: 1 },
                "AMR-002": { name: "AMR-002", ip: "192.168.1.102", model: "MiR 250", homeTask: "901", homePoint: "H02", chargeTask: "902", chargePoint: "C01", cancelTask: "999", priority: 1 },
                "AMR-003": { name: "AMR-003", ip: "192.168.1.103", model: "OTTO 100", homeTask: "801", homePoint: "H03", chargeTask: "802", chargePoint: "C02", cancelTask: "899", priority: 2 },
                "AMR-004": { name: "AMR-004", ip: "192.168.1.104", model: "OTTO 100", homeTask: "801", homePoint: "H04", chargeTask: "802", chargePoint: "C02", cancelTask: "899", priority: 2 },
            };

            // User Data
            // Case 1: User ที่หมดสิทธิ์แล้ว - วันที่สีแดง, toggle ปิด, disable
            // Case 2: User ที่ยังไม่หมดสิทธิ์ แต่ toggle ปิด - สามารถเปิดได้
            // Case 3: User ที่ยังไม่หมดสิทธิ์ และ toggle เปิด - สามารถปิดได้
            const userData = {
                "operator01": {
                    username: "operator01",
                    expiry: "2024-11-15",  // หมดสิทธิ์แล้ว (Case 1)
                    status: "active"
                },
                "operator02": {
                    username: "operator02",
                    expiry: "2025-06-30",  // ยังไม่หมดสิทธิ์, toggle ปิด (Case 2)
                    status: "inactive"
                },
                "operator03": {
                    username: "operator03",
                    expiry: "2025-12-31",  // ยังไม่หมดสิทธิ์, toggle เปิด (Case 3)
                    status: "active"
                }
            };

            // Render Users Table
            function renderUsersTable() {
                if (!usersTableBody) return;

                const today = new Date();
                today.setHours(0, 0, 0, 0);

                usersTableBody.innerHTML = Object.keys(userData).map(userId => {
                    const user = userData[userId];
                    const expiryDate = new Date(user.expiry);
                    expiryDate.setHours(0, 0, 0, 0);
                    const isExpired = expiryDate < today;

                    // Case 1: ถ้าหมดสิทธิ์แล้ว - force toggle เป็นปิดและ disable
                    // Case 2 & 3: ถ้ายังไม่หมดสิทธิ์ - ใช้ status จาก userData
                    let isActive = false;
                    if (isExpired) {
                        // หมดสิทธิ์แล้ว - force เป็น inactive
                        isActive = false;
                    } else {
                        // ยังไม่หมดสิทธิ์ - ใช้ status จาก userData
                        isActive = user.status === 'active';
                    }

                    return `
                        <tr class="border-b">
                            <td class="p-3 font-medium">${user.username}</td>
                            <td class="p-3 ${isExpired ? 'text-red-600 font-semibold' : ''}">${user.expiry}</td>
                            <td class="p-3">
                                <label class="switch">
                                    <input type="checkbox" ${isActive ? 'checked' : ''} ${isExpired ? 'disabled' : ''} data-user-id="${userId}" class="user-status-toggle">
                                    <span class="slider ${isExpired ? 'opacity-50 cursor-not-allowed' : ''}"></span>
                                </label>
                            </td>
                            <td class="p-3">
                                <button class="text-blue-500 hover:text-blue-700 mr-3 edit-user-btn" data-user-id="${userId}"><i class="fas fa-edit"></i> แก้ไข</button>
                                <button class="text-green-500 hover:text-green-700 mr-3 manage-permissions-btn" data-user-id="${userId}"><i class="fas fa-key"></i> สิทธิ์</button>
                                <button class="text-red-500 hover:text-red-700 delete-user-btn" data-user-id="${userId}"><i class="fas fa-trash"></i> ลบ</button>
                            </td>
                        </tr>
                    `;
                }).join('');
            }

            // Orders Data (20 orders)
            const ordersData = [
                { id: "ORD-1023", plan: "Plan 101", amr: "AMR-001", status: "working", lastUpdate: "14:30", totalTime: "00:03:38", currentStep: 2, failedStep: null },
                { id: "ORD-1025", plan: "Plan 102", amr: "AMR-003", status: "working", lastUpdate: "14:25", totalTime: "00:04:12", currentStep: 3, failedStep: null },
                { id: "ORD-1026", plan: "Plan 103", amr: "AMR-004", status: "working", lastUpdate: "14:20", totalTime: "00:02:45", currentStep: 1, failedStep: null },
                { id: "ORD-1027", plan: "Plan 101", amr: "AMR-001", status: "working", lastUpdate: "14:15", totalTime: "00:01:52", currentStep: 1, failedStep: null },
                { id: "ORD-1028", plan: "Plan 102", amr: "AMR-002", status: "waiting", lastUpdate: "14:10", totalTime: "00:00:00", currentStep: 0, failedStep: null },
                { id: "ORD-1029", plan: "Plan 103", amr: "AMR-003", status: "waiting", lastUpdate: "14:05", totalTime: "00:00:00", currentStep: 0, failedStep: null },
                { id: "ORD-1030", plan: "Plan 101", amr: "AMR-004", status: "waiting", lastUpdate: "14:00", totalTime: "00:00:00", currentStep: 0, failedStep: null },
                { id: "ORD-1031", plan: "Plan 102", amr: "AMR-001", status: "waiting", lastUpdate: "13:55", totalTime: "00:00:00", currentStep: 0, failedStep: null },
                { id: "ORD-1032", plan: "Plan 103", amr: "AMR-002", status: "waiting", lastUpdate: "13:50", totalTime: "00:00:00", currentStep: 0, failedStep: null },
                { id: "ORD-1020", plan: "Plan 101", amr: "AMR-001", status: "completed", lastUpdate: "13:45", totalTime: "00:08:23", currentStep: -1, failedStep: null },
                { id: "ORD-1021", plan: "Plan 102", amr: "AMR-003", status: "completed", lastUpdate: "13:40", totalTime: "00:12:15", currentStep: -1, failedStep: null },
                { id: "ORD-1022", plan: "Plan 103", amr: "AMR-004", status: "completed", lastUpdate: "13:35", totalTime: "00:10:42", currentStep: -1, failedStep: null },
                { id: "ORD-1018", plan: "Plan 101", amr: "AMR-002", status: "completed", lastUpdate: "13:30", totalTime: "00:07:58", currentStep: -1, failedStep: null },
                { id: "ORD-1019", plan: "Plan 102", amr: "AMR-001", status: "completed", lastUpdate: "13:25", totalTime: "00:11:30", currentStep: -1, failedStep: null },
                { id: "ORD-1015", plan: "Plan 103", amr: "AMR-003", status: "failed", lastUpdate: "13:20", totalTime: "00:05:18", currentStep: -1, failedStep: 3 },
                { id: "ORD-1016", plan: "Plan 101", amr: "AMR-004", status: "failed", lastUpdate: "13:15", totalTime: "00:04:05", currentStep: -1, failedStep: 2 },
                { id: "ORD-1017", plan: "Plan 102", amr: "AMR-002", status: "failed", lastUpdate: "13:10", totalTime: "00:06:22", currentStep: -1, failedStep: 4 },
                { id: "ORD-1013", plan: "Plan 103", amr: "AMR-001", status: "completed", lastUpdate: "13:05", totalTime: "00:09:47", currentStep: -1, failedStep: null },
                { id: "ORD-1014", plan: "Plan 101", amr: "AMR-003", status: "completed", lastUpdate: "13:00", totalTime: "00:08:12", currentStep: -1, failedStep: null },
                { id: "ORD-1012", plan: "Plan 102", amr: "AMR-004", status: "completed", lastUpdate: "12:55", totalTime: "00:11:55", currentStep: -1, failedStep: null }
            ];

            // Auto-scroll Logic
            function setupAutoScroll(container) {
                if (!container) return;

                const scrollToActive = () => {
                    const activeStep = container.querySelector('.blinking');
                    if (activeStep) {
                        // Use getBoundingClientRect for robust relative positioning
                        const containerRect = container.getBoundingClientRect();
                        const stepRect = activeStep.getBoundingClientRect();

                        // Calculate relative position of the step within the container
                        // We want to scroll so that the step is at the left side + padding
                        const relativeLeft = stepRect.left - containerRect.left;
                        const currentScroll = container.scrollLeft;

                        // Target: Align left with 50px padding
                        // New Scroll Left = Current Scroll + Relative Left - Padding
                        const padding = 50;
                        const targetScroll = currentScroll + relativeLeft - padding;

                        container.scrollTo({
                            left: targetScroll,
                            behavior: 'smooth'
                        });
                    }
                };

                // Initial scroll
                // Use setTimeout to ensure DOM is fully rendered and layout is calculated
                setTimeout(scrollToActive, 100);

                // Inactivity Timer
                let isManualScroll = false;
                let scrollTimeout;

                container.addEventListener('scroll', () => {
                    // Detect if this scroll was triggered by our code or user
                    // Simple heuristic: if we are not currently "auto-scrolling" (which is hard to track perfectly without a flag)
                    // But here we just want to reset if user stops scrolling.

                    // Clear existing timeout
                    if (scrollTimeout) clearTimeout(scrollTimeout);

                    // Set new timeout to snap back after 3 seconds
                    scrollTimeout = setTimeout(() => {
                        scrollToActive();
                    }, 3000);
                });
            }

            // Render Plan-Specific Orders Work Sequences
            function renderPlanOrdersWorkSequence(planId, containerId) {
                const container = document.getElementById(containerId);
                if (!container) return;

                // Filter orders for this plan, only show working and waiting (exclude cancelled)
                const planOrders = ordersData.filter(o => o.plan === planId && (o.status === 'working' || o.status === 'waiting'));

                if (planOrders.length === 0) {
                    container.innerHTML = '<p class="text-slate-500 text-center py-4">ไม่มี Order ที่กำลังทำงานหรือรอทำงาน</p>';
                    return;
                }

                // Sort by status and lastUpdate
                const statusOrder = { working: 1, waiting: 2 };
                const sortedOrders = [...planOrders].sort((a, b) => {
                    const statusDiff = statusOrder[a.status] - statusOrder[b.status];
                    if (statusDiff !== 0) return statusDiff;

                    const timeA = a.lastUpdate.split(':').map(Number);
                    const timeB = b.lastUpdate.split(':').map(Number);
                    const minutesA = timeA[0] * 60 + timeA[1];
                    const minutesB = timeB[0] * 60 + timeB[1];
                    return minutesB - minutesA;
                });

                container.innerHTML = sortedOrders.map(order => {
                    const statusBadge = order.status === 'working'
                        ? '<span class="px-2 py-1 bg-blue-100 text-blue-700 rounded-full text-xs">กำลังทำงาน</span>'
                        : '<span class="px-2 py-1 bg-yellow-100 text-yellow-700 rounded-full text-xs">รอทำงาน</span>';

                    // Render work sequence similar to tracking page
                    const planSteps = planTaskData[order.plan] || [];
                    const currentStepIndex = order.currentStep || 0;
                    const completedSteps = currentStepIndex > 0 ? currentStepIndex - 1 : 0;

                    let sequenceHTML = '<div class="flex items-center overflow-x-auto p-2 auto-scroll-container">';

                    // Step 0: รอทำงาน
                    const isWaitingActive = currentStepIndex === 0;
                    const isWaitingCompleted = completedSteps >= 0 && currentStepIndex > 0;

                    let waitingStepClass = 'plan-step ';
                    if (isWaitingActive) {
                        waitingStepClass += 'bg-yellow-100 border-yellow-400 blinking';
                    } else if (isWaitingCompleted) {
                        waitingStepClass += 'bg-green-100 border-green-300';
                    } else {
                        waitingStepClass += 'bg-slate-50';
                    }

                    const waitingTime = '00:05:23'; // Mockup time
                    const waitingIconColor = isWaitingActive ? 'text-yellow-600' : (isWaitingCompleted ? 'text-green-600' : 'text-slate-500');
                    const waitingTimeColor = isWaitingCompleted ? 'text-green-600' : 'text-slate-600';

                    sequenceHTML += `
                        <div class="${waitingStepClass}">
                            <i class="fas fa-clock text-xl mb-1 ${waitingIconColor}"></i>
                            <div class="text-xs font-medium">รอทำงาน</div>
                            <div class="text-xs ${waitingTimeColor} mt-1">${waitingTime}</div>
                        </div>
                    `;

                    // Arrow after waiting step
                    const waitingArrowColor = isWaitingCompleted ? 'text-green-500' : 'text-slate-400';
                    sequenceHTML += `<div class="plan-arrow"><i class="fas fa-long-arrow-alt-right ${waitingArrowColor}"></i></div>`;

                    // Plan Steps
                    planSteps.forEach((step, index) => {
                        const stepNumber = index + 1;
                        const isCompleted = stepNumber <= completedSteps;
                        const isCurrent = stepNumber === currentStepIndex;
                        const isFuture = stepNumber > currentStepIndex;

                        let stepClass = 'plan-step ';
                        let clickable = false;
                        let clickAction = '';

                        // Check if this step should be clickable
                        if (step.id === 'C-001') {
                            // รอผู้ใช้ยืนยัน - make whole step clickable when current
                            if (isCurrent) {
                                stepClass += 'bg-yellow-100 border-yellow-400 blinking cursor-pointer hover:bg-yellow-200 ';
                                clickable = true;
                                clickAction = `order-confirm-step-btn`;
                            } else if (isCompleted) {
                                stepClass += 'bg-green-100 border-green-300';
                            } else {
                                stepClass += 'bg-slate-50';
                            }
                        } else if (step.id === 'C-002') {
                            // เปลี่ยนจุดวาง - make clickable even before reaching it
                            if (isCurrent) {
                                stepClass += 'bg-yellow-100 border-yellow-400 blinking cursor-pointer hover:bg-yellow-200 ';
                                clickable = true;
                            } else if (isFuture) {
                                stepClass += 'bg-slate-50 cursor-pointer hover:bg-slate-100 border-2 border-dashed border-purple-300 ';
                                clickable = true;
                            } else if (isCompleted) {
                                stepClass += 'bg-green-100 border-green-300';
                                clickable = false;
                            }
                            if (clickable) {
                                clickAction = `order-change-dest-step-btn`;
                            }
                        } else {
                            if (isCompleted) {
                                stepClass += 'bg-green-100 border-green-300';
                            } else if (isCurrent) {
                                stepClass += 'bg-yellow-100 border-yellow-400 blinking';
                            } else {
                                stepClass += 'bg-slate-50';
                            }
                        }

                        // Mockup times
                        let stepTime = '00:00:00';
                        if (isCompleted) {
                            stepTime = stepNumber === 1 ? '00:02:15' : '00:01:45';
                        } else if (isCurrent) {
                            stepTime = '00:01:23';
                        }

                        const iconColor = isCompleted ? 'text-green-600' : isCurrent ? 'text-yellow-600' : 'text-slate-500';
                        const timeColor = isCompleted ? 'text-green-600' : isCurrent ? 'text-yellow-600' : 'text-slate-600';

                        const dataAttrs = clickable ? `data-order-id="${order.id}" data-step-id="${step.id}"` : '';
                        const clickableClass = clickable ? clickAction : '';

                        sequenceHTML += `
                            <div class="${stepClass} ${clickableClass}" ${dataAttrs}>
                                <i class="fas ${step.icon} text-xl mb-1 ${iconColor}"></i>
                                <div class="text-xs font-medium">${step.name}</div>
                                <div class="text-xs ${timeColor} mt-1">${stepTime}</div>
                            </div>
                        `;

                        if (index < planSteps.length - 1) {
                            const arrowColor = isCompleted ? 'text-green-500' : 'text-slate-400';
                            sequenceHTML += `<div class="plan-arrow"><i class="fas fa-long-arrow-alt-right ${arrowColor}"></i></div>`;
                        }
                    });

                    sequenceHTML += '</div>';

                    return `
                        <div class="border-b pb-4 mb-4 last:border-b-0 last:mb-0">
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center gap-3">
                                    <span class="font-semibold text-slate-700">${order.id}</span>
                                    ${statusBadge}
                                    <span class="text-sm text-slate-600">${order.amr}</span>
                                    <span class="text-sm text-slate-500">รวมเวลา: ${order.totalTime}</span>
                                </div>
                                <button class="text-red-500 hover:text-red-700 text-sm order-cancel-btn" data-order-id="${order.id}">
                                    <i class="fas fa-times-circle mr-1"></i>ยกเลิก
                                </button>
                            </div>
                            ${sequenceHTML}
                        </div>
                    `;
                }).join('');

                // Apply auto-scroll to all generated containers
                const scrollContainers = container.querySelectorAll('.auto-scroll-container');
                scrollContainers.forEach(scrollContainer => {
                    setupAutoScroll(scrollContainer);
                });
            }

            // Helper function to get step description
            function getStepDescription(order) {
                const planSteps = planTaskData[order.plan] || [];
                if (order.status === 'waiting') {
                    return 'รอทำงาน';
                } else if (order.status === 'completed') {
                    return `เสร็จสิ้น (${planSteps.length + 1}/${planSteps.length + 1})`;
                } else if (order.status === 'failed') {
                    const failedStep = order.failedStep || 0;
                    const stepName = failedStep === 0 ? 'รอทำงาน' : (planSteps[failedStep - 1]?.name || `Step ${failedStep}`);
                    return `ล้มเหลว: ${stepName}`;
                } else if (order.status === 'working') {
                    const currentStep = order.currentStep || 0;
                    if (currentStep === 0) {
                        return 'รอทำงาน (0/' + (planSteps.length + 1) + ')';
                    } else {
                        const stepName = planSteps[currentStep - 1]?.name || `Step ${currentStep}`;
                        return `${stepName} (${currentStep}/${planSteps.length + 1})`;
                    }
                }
                return '-';
            }

            // Render Consolidated Orders Table
            function renderConsolidatedOrdersTable() {
                const ordersTableBody = document.getElementById('orders-table-body-consolidated');
                if (!ordersTableBody) return;

                // Sort orders: working > waiting > completed/failed, then by lastUpdate (newest first)
                const statusOrder = { working: 1, waiting: 2, completed: 3, failed: 3 };
                const sortedOrders = [...ordersData].sort((a, b) => {
                    const statusDiff = statusOrder[a.status] - statusOrder[b.status];
                    if (statusDiff !== 0) return statusDiff;

                    // If same status, sort by lastUpdate (newest first)
                    const timeA = a.lastUpdate.split(':').map(Number);
                    const timeB = b.lastUpdate.split(':').map(Number);
                    const minutesA = timeA[0] * 60 + timeA[1];
                    const minutesB = timeB[0] * 60 + timeB[1];
                    return minutesB - minutesA; // Descending (newest first)
                });

                ordersTableBody.innerHTML = sortedOrders.map(order => {
                    let statusBadge = '';
                    let actionButton = '';

                    if (order.status === 'working') {
                        statusBadge = '<span class="px-2 py-1 bg-blue-100 text-blue-700 rounded-full">กำลังทำงาน</span>';
                        actionButton = `<button class="text-blue-500 hover:text-blue-700 order-track-btn" data-order-id="${order.id}" data-plan-id="${order.plan}"><i class="fas fa-tv"></i> ติดตาม</button>`;
                    } else if (order.status === 'waiting') {
                        statusBadge = '<span class="px-2 py-1 bg-yellow-100 text-yellow-700 rounded-full">รอทำงาน</span>';
                        actionButton = `<button class="text-blue-500 hover:text-blue-700 order-track-btn" data-order-id="${order.id}" data-plan-id="${order.plan}"><i class="fas fa-tv"></i> ติดตาม</button>`;
                    } else if (order.status === 'completed') {
                        statusBadge = '<span class="px-2 py-1 bg-green-100 text-green-700 rounded-full">เสร็จสิ้น</span>';
                        actionButton = `<button class="text-green-500 hover:text-green-700 order-summary-btn" data-order-id="${order.id}" data-plan-id="${order.plan}" data-status="completed"><i class="fas fa-search"></i> ดูสรุป</button>`;
                    } else if (order.status === 'failed') {
                        statusBadge = '<span class="px-2 py-1 bg-red-100 text-red-700 rounded-full">ล้มเหลว</span>';
                        actionButton = `<button class="text-red-500 hover:text-red-700 order-summary-btn" data-order-id="${order.id}" data-plan-id="${order.plan}" data-status="failed"><i class="fas fa-search"></i> ดูสรุป</button>`;
                    }

                    const stepDesc = getStepDescription(order);

                    return `
                        <tr class="border-b">
                            <td class="p-3 font-medium">${order.id}</td>
                            <td class="p-3"><span class="font-medium">${order.plan}</span></td>
                            <td class="p-3">${order.amr}</td>
                            <td class="p-3">${statusBadge}</td>
                            <td class="p-3 text-xs">${stepDesc}</td>
                            <td class="p-3">${order.totalTime}</td>
                            <td class="p-3">${actionButton}</td>
                        </tr>
                    `;
                }).join('');
            }

            const pageTitles = {
                'page-dashboard': 'แดชบอร์ดภาพรวม',
                'page-map': 'แผนที่และสถานะสด (Live Map)',
                'page-add-order-parent': 'ภาพรวมคำสั่ง (Consolidated List)',
                'page-order-plan-101': 'สั่งงาน: Plan 101 (A -> B)',
                'page-order-plan-102': 'สั่งงาน: Plan 102 (C -> D)',
                'page-order-plan-103': 'สั่งงาน: Plan 103 (D -> E)',
                'page-amrs': 'จัดการหุ่นยนต์ (AMR Management)',
                'page-plans': 'จัดการแผนงาน (Plan Management)',
                'page-tasks': 'จัดการงาน (Task Templates)',
                'page-storage-parent': 'ภาพรวมสต็อก (Consolidated Storage)',
                'page-storage-ab': 'จัดการสต็อก: Plan 101 (A -> B)',
                'page-storage-cd': 'จัดการสต็อก: Plan 102 (C -> D)',
                'page-storage-de': 'จัดการสต็อก: Plan 103 (D -> E)',
                'page-settings': 'ตั้งค่า / ผู้ใช้ (Settings)',
                'page-recommend': 'คำแนะนำและแนวทาง (Recommendations)',
                'page-working': 'ติดตามการทำงาน (Live Order Tracking)'
            };

            function navigateToPage(pageId, context = null, anchor = null) {
                if (!pageId) return;

                // Stop animations
                if (pageId !== 'page-map' && mapAnimationId) {
                    stopMapSimulation();
                }
                if (pageId !== 'page-dashboard') {
                    if (barChart) barChart.destroy();
                    if (doughnutChart) doughnutChart.destroy();
                    barChart = null;
                    doughnutChart = null;
                }

                pageSections.forEach(section => {
                    section.classList.remove('active');
                });

                const activeSection = document.getElementById(pageId);
                if (activeSection) {
                    activeSection.classList.add('active');
                }

                // Update sidebar active state
                sidebarLinks.forEach(link => {
                    link.classList.remove('active');
                });

                const activeLink = document.querySelector(`.sidebar-link[data-page="${pageId}"]`);
                if (activeLink) {
                    activeLink.classList.add('active');
                    // Also activate parent if it's a sub-menu item
                    const parentToggle = activeLink.closest('div.space-y-2')?.previousElementSibling;
                    if (parentToggle && (parentToggle.id === 'add-order-toggle' || parentToggle.id === 'storage-toggle')) {
                        parentToggle.classList.add('active');
                    }
                }

                let title = pageTitles[pageId] || 'Dashboard';

                if (pageId === 'page-dashboard') {
                    setupAnalytics();
                } else if (pageId === 'page-map') {
                    startMapSimulation();
                } else if (pageId === 'page-add-order-parent') {
                    renderConsolidatedOrdersTable();
                } else if (pageId === 'page-order-plan-101') {
                    renderPlanOrdersWorkSequence('Plan 101', 'orders-work-sequence-plan-101');
                } else if (pageId === 'page-order-plan-102') {
                    renderPlanOrdersWorkSequence('Plan 102', 'orders-work-sequence-plan-102');
                } else if (pageId === 'page-order-plan-103') {
                    renderPlanOrdersWorkSequence('Plan 103', 'orders-work-sequence-plan-103');
                } else if (pageId === 'page-working') {
                    title = `ติดตาม Order: ${context.orderId}`;

                    const workingTitleEl = document.getElementById('working-title');
                    if (workingTitleEl) {
                        workingTitleEl.textContent = title;
                    }

                    // Find order data
                    const orderData = ordersData.find(o => o.id === context.orderId);
                    const isSummaryView = context.isSummaryView || false;
                    const totalTime = orderData ? orderData.totalTime : '00:00:00';

                    // Update cancel button with order ID
                    const cancelOrderWorkingBtn = document.getElementById('cancel-order-working-btn');
                    if (cancelOrderWorkingBtn) {
                        cancelOrderWorkingBtn.dataset.orderId = context.orderId;
                    }

                    const container = document.getElementById('working-plan-container');
                    if (container) {
                        container.innerHTML = ''; // Clear previous

                        // Check if title already exists, if not create it
                        const parentDiv = container.parentElement;
                        let existingTitle = parentDiv.querySelector('.working-plan-title');
                        if (!existingTitle) {
                            existingTitle = document.createElement('h4');
                            existingTitle.className = 'working-plan-title text-lg font-semibold text-slate-700 mb-4';
                            parentDiv.insertBefore(existingTitle, container);
                        }
                        existingTitle.textContent = `เวลาทำงานรวม - ${totalTime}`;

                        const planSteps = planTaskData[context.planId] || [];

                        // Determine step states based on view type
                        let currentStepIndex, completedSteps, failedStepIndex;

                        if (isSummaryView) {
                            // Summary view: show final state
                            if (context.status === 'completed') {
                                // All steps completed
                                currentStepIndex = -1;
                                completedSteps = planSteps.length + 1; // +1 for waiting step
                                failedStepIndex = null;
                            } else if (context.status === 'failed') {
                                // Failed at specific step
                                failedStepIndex = orderData ? orderData.failedStep : 0;
                                currentStepIndex = -1;
                                completedSteps = failedStepIndex - 1;
                            }
                        } else {
                            // Live view: show current progress
                            currentStepIndex = orderData ? orderData.currentStep : 0;
                            completedSteps = currentStepIndex > 0 ? currentStepIndex - 1 : 0;
                            failedStepIndex = null;
                        }

                        // Step 0: รอทำงาน
                        const waitingStepDiv = document.createElement('div');
                        const waitingTime = '00:05:23'; // Mockup time
                        const isWaitingActive = currentStepIndex === 0;
                        const isWaitingCompleted = completedSteps >= 0 && currentStepIndex > 0;

                        let waitingStepClass = 'plan-step ';
                        if (isWaitingActive) {
                            waitingStepClass += 'bg-yellow-100 border-yellow-400 blinking';
                        } else if (isWaitingCompleted || context.status === 'completed' || (context.status === 'failed' && failedStepIndex > 0)) {
                            waitingStepClass += 'bg-green-100 border-green-300';
                        } else {
                            waitingStepClass += 'bg-slate-50';
                        }

                        waitingStepDiv.className = waitingStepClass;
                        const waitingIconColor = isWaitingActive ? 'text-yellow-600' : (isWaitingCompleted || context.status === 'completed' || (context.status === 'failed' && failedStepIndex > 0)) ? 'text-green-600' : 'text-slate-500';
                        waitingStepDiv.innerHTML = `
                            <i class="fas fa-clock text-xl mb-1 ${waitingIconColor}"></i>
                            <div class="text-xs font-medium">รอทำงาน</div>
                            <div class="text-xs ${isWaitingCompleted || context.status === 'completed' || (context.status === 'failed' && failedStepIndex > 0) ? 'text-green-600' : 'text-slate-600'} mt-1">${waitingTime}</div>
                        `;
                        container.appendChild(waitingStepDiv);

                        // Arrow after waiting step
                        const waitingArrowDiv = document.createElement('div');
                        waitingArrowDiv.className = 'plan-arrow';
                        const arrowColor = (isWaitingCompleted || context.status === 'completed') ? 'text-green-500' : 'text-slate-400';
                        waitingArrowDiv.innerHTML = `<i class="fas fa-long-arrow-alt-right ${arrowColor}"></i>`;
                        container.appendChild(waitingArrowDiv);

                        // Plan Steps
                        planSteps.forEach((step, index) => {
                            const stepNumber = index + 1; // Step number (1-based)
                            const isCompleted = stepNumber <= completedSteps || context.status === 'completed';
                            const isCurrent = stepNumber === currentStepIndex && !isSummaryView;
                            const isFailed = failedStepIndex === stepNumber;

                            const stepDiv = document.createElement('div');
                            let stepClass = 'plan-step ';
                            if (isFailed) {
                                stepClass += 'bg-red-100 border-red-300';
                            } else if (isCompleted) {
                                stepClass += 'bg-green-100 border-green-300';
                            } else if (isCurrent) {
                                stepClass += 'bg-yellow-100 border-yellow-400 blinking';
                            } else {
                                stepClass += 'bg-slate-50';
                            }
                            stepDiv.className = stepClass;

                            // Mockup times for each step
                            let stepTime = '00:00:00';
                            if (isCompleted) {
                                stepTime = stepNumber === 1 ? '00:02:15' : '00:01:45';
                            } else if (isCurrent) {
                                stepTime = '00:01:23'; // Running time
                            } else if (isFailed) {
                                stepTime = '00:01:10'; // Time before failure
                            }

                            const iconColor = isFailed ? 'text-red-600' : isCompleted ? 'text-green-600' : isCurrent ? 'text-yellow-600' : 'text-slate-500';
                            const timeColor = isFailed ? 'text-red-600' : isCompleted ? 'text-green-600' : isCurrent ? 'text-yellow-600' : 'text-slate-600';

                            // Check if this step should be clickable
                            let clickable = false;
                            let clickAction = '';
                            if (!isSummaryView && step.id === 'C-001' && isCurrent) {
                                // รอผู้ใช้ยืนยัน - make whole step clickable when current
                                stepClass += 'cursor-pointer hover:bg-yellow-200 ';
                                clickable = true;
                                clickAction = 'order-confirm-step-btn';
                            } else if (!isSummaryView && step.id === 'C-002') {
                                // เปลี่ยนจุดวาง - make clickable even before reaching it
                                if (!isCompleted) {
                                    if (isCurrent) {
                                        stepClass += 'cursor-pointer hover:bg-yellow-200 ';
                                    } else {
                                        stepClass += 'cursor-pointer hover:bg-slate-100 border-2 border-dashed border-purple-300 ';
                                    }
                                    clickable = true;
                                    clickAction = 'order-change-dest-step-btn';
                                }
                            }

                            const dataAttrs = clickable ? `data-order-id="${context.orderId}" data-step-id="${step.id}"` : '';
                            const clickableClass = clickable ? clickAction : '';

                            stepDiv.className = stepClass + ' ' + clickableClass;

                            // Add confirm button for Plan 102 Step C-001 when current
                            let confirmButton = '';
                            if (!isSummaryView && step.id === 'C-001' && isCurrent && context.planId === 'Plan 102') {
                                confirmButton = `
                                    <button class="mt-2 px-3 py-1 bg-yellow-500 text-white text-xs rounded-lg hover:bg-yellow-600 transition order-confirm-step-btn" 
                                            data-order-id="${context.orderId}" 
                                            data-step-id="${step.id}"
                                            onclick="event.stopPropagation();">
                                        <i class="fas fa-check mr-1"></i>กดเพื่อยืนยัน
                                    </button>
                                `;
                            }

                            stepDiv.innerHTML = `
                                <i class="fas ${step.icon} text-xl mb-1 ${iconColor}"></i>
                                <div class="text-xs font-medium">${step.name}</div>
                                <div class="text-xs ${timeColor} mt-1">${stepTime}</div>
                                ${isFailed ? '<div class="text-xs text-red-600 font-semibold mt-1">ล้มเหลว</div>' : ''}
                                ${confirmButton}
                            `;
                            if (clickable) {
                                stepDiv.setAttribute('data-order-id', context.orderId);
                                stepDiv.setAttribute('data-step-id', step.id);
                            }
                            container.appendChild(stepDiv);

                            if (index < planSteps.length - 1) {
                                const arrowDiv = document.createElement('div');
                                arrowDiv.className = 'plan-arrow';
                                const arrowColor = isCompleted ? 'text-green-500' : 'text-slate-400';
                                arrowDiv.innerHTML = `<i class="fas fa-long-arrow-alt-right ${arrowColor}"></i>`;
                                container.appendChild(arrowDiv);
                            }
                        });
                    }

                    // Hide controls section since buttons are now shown directly on steps
                    const controlsSection = document.getElementById('working-controls-section');
                    if (controlsSection) {
                        controlsSection.style.display = 'none';
                    }
                }

                if (pageTitle) {
                    pageTitle.textContent = title;
                }

                if (anchor) {
                    const targetElement = document.getElementById(anchor.substring(1));
                    if (targetElement) {
                        targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                } else if (!['page-working'].includes(pageId)) {
                    // Scroll to top if not an anchor link
                    const mainContent = document.getElementById('main-content');
                    if (mainContent) {
                        mainContent.scrollTop = 0;
                    }
                }
            }

            // Sidebar Toggle
            if (sidebarToggleBtn) {
                sidebarToggleBtn.addEventListener('click', () => {
                    sidebar.classList.toggle('sidebar-hidden');
                    // Force-hide submenus when collapsing
                    if (sidebar.classList.contains('sidebar-hidden')) {
                        addOrderSubmenu.classList.add('hidden');
                        storageSubmenu.classList.add('hidden');
                    }
                });
            }

            // Sidebar Links
            sidebarLinks.forEach(link => {
                link.addEventListener('click', function (e) {
                    e.preventDefault();

                    const pageId = this.dataset.page;
                    const anchor = this.dataset.anchor || null;

                    if (pageId === 'na') return;

                    if (pageId === 'page-add-order-parent' || pageId === 'page-storage-parent') {
                        // Handle clicking the parent toggle button
                        const submenu = (pageId === 'page-add-order-parent') ? addOrderSubmenu : storageSubmenu;
                        const chevron = (pageId === 'page-add-order-parent') ? addOrderChevron : storageChevron;

                        if (!sidebar.classList.contains('sidebar-hidden')) {
                            submenu.classList.toggle('hidden');
                            chevron.classList.toggle('rotate-180');
                        }
                    }

                    navigateToPage(pageId, null, anchor);
                    if (!anchor) {
                        window.location.hash = pageId;
                    } else {
                        window.location.hash = anchor;
                    }
                });
            });

            // Initial Page Load
            let initialHash = window.location.hash.substring(1);
            let initialPage, initialAnchor;

            if (initialHash.includes('-anchor')) {
                initialAnchor = '#' + initialHash;
                initialPage = document.querySelector(`.sidebar-link[data-anchor="${initialAnchor}"]`).dataset.page;
            } else {
                initialPage = initialHash || 'page-dashboard';
                initialAnchor = null;
            }

            if (pageTitles[initialPage]) {
                if (initialPage.startsWith('page-order-plan')) {
                    addOrderSubmenu.classList.remove('hidden');
                    addOrderChevron.classList.add('rotate-180');
                } else if (initialPage.startsWith('page-storage-')) {
                    storageSubmenu.classList.remove('hidden');
                    storageChevron.classList.add('rotate-180');
                } else if (initialPage === 'page-add-order-parent') {
                    addOrderSubmenu.classList.remove('hidden');
                    addOrderChevron.classList.add('rotate-180');
                }
                navigateToPage(initialPage, null, initialAnchor);
            } else {
                navigateToPage('page-dashboard');
            }

            // Order Tracking Button
            document.body.addEventListener('click', function (e) {
                const trackBtn = e.target.closest('.order-track-btn');
                if (trackBtn) {
                    e.preventDefault();
                    const orderId = trackBtn.dataset.orderId;
                    const planId = trackBtn.dataset.planId;
                    navigateToPage('page-working', { orderId: orderId, planId: planId, isSummaryView: false });
                }

                // Order Summary Button
                const summaryBtn = e.target.closest('.order-summary-btn');
                if (summaryBtn) {
                    e.preventDefault();
                    const orderId = summaryBtn.dataset.orderId;
                    const planId = summaryBtn.dataset.planId;
                    const status = summaryBtn.dataset.status;
                    navigateToPage('page-working', { orderId: orderId, planId: planId, status: status, isSummaryView: true });
                }

                // Order Cancel Button (ยกเลิก)
                const cancelBtn = e.target.closest('.order-cancel-btn');
                if (cancelBtn) {
                    e.preventDefault();
                    const orderId = cancelBtn.dataset.orderId;
                    const cancelOrderIdSpan = document.getElementById('cancel-order-id');
                    if (cancelOrderIdSpan) {
                        cancelOrderIdSpan.textContent = orderId;
                    }
                    const cancelModal = document.getElementById('cancel-order-modal');
                    if (cancelModal) {
                        openModal(cancelModal);
                        // Store order ID for confirmation
                        cancelModal.dataset.orderId = orderId;
                    }
                }

                // Order Confirm Step (รอผู้ใช้ยืนยัน - whole step clickable)
                const confirmStepBtn = e.target.closest('.order-confirm-step-btn');
                if (confirmStepBtn) {
                    e.preventDefault();
                    const orderId = confirmStepBtn.dataset.orderId;
                    const stepId = confirmStepBtn.dataset.stepId;

                    // Find order and update current step
                    const order = ordersData.find(o => o.id === orderId);
                    if (order && stepId === 'C-001') {
                        // Move to next step
                        order.currentStep += 1;
                        order.lastUpdate = new Date().toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });

                        // Refresh the page to show updated step
                        const planId = order.plan;
                        navigateToPage('page-working', { orderId: orderId, planId: planId, isSummaryView: false });
                    }
                }

                // Order Change Destination Step (เปลี่ยนจุดวาง - clickable before reaching)
                const changeDestStepBtn = e.target.closest('.order-change-dest-step-btn');
                if (changeDestStepBtn) {
                    e.preventDefault();
                    const orderId = changeDestStepBtn.dataset.orderId;
                    const stepId = changeDestStepBtn.dataset.stepId;

                    // Open change destination modal for Plan 103
                    const changeDestModal = document.getElementById('change-destination-modal');
                    if (changeDestModal) {
                        const changeDestOrderIdSpan = document.getElementById('change-dest-order-id');
                        if (changeDestOrderIdSpan) {
                            changeDestOrderIdSpan.textContent = orderId;
                        }
                        changeDestModal.dataset.orderId = orderId;
                        // Re-render buttons when opening modal
                        renderChangeDestButtons();
                        openModal(changeDestModal);
                    }
                }

                // Change destination button selection (Group E)
                const changeDestBtn = e.target.closest('.change-dest-btn');
                if (changeDestBtn) {
                    e.preventDefault();
                    const container = document.getElementById('change-dest-group-e');
                    if (container) {
                        const changeDestButtons = container.querySelectorAll('.change-dest-btn');
                        changeDestButtons.forEach(b => b.classList.remove('selected'));
                        changeDestBtn.classList.add('selected');
                        selectedChangeDest = changeDestBtn.dataset.value;

                        const confirmBtn = document.getElementById('confirm-change-dest-btn');
                        if (confirmBtn) {
                            confirmBtn.disabled = false;
                        }
                    }
                }

                // Confirm change destination button
                const confirmChangeDestBtn = e.target.closest('#confirm-change-dest-btn');
                if (confirmChangeDestBtn && selectedChangeDest) {
                    e.preventDefault();
                    const modal = document.getElementById('change-destination-modal');
                    const orderId = modal ? modal.dataset.orderId : null;
                    if (orderId) {
                        // TODO: Update order destination in ordersData
                        alert(`เปลี่ยนจุดวาง Order ${orderId} เป็น ${selectedChangeDest}`);
                        closeModal(modal);

                        // Refresh the tracking page
                        const order = ordersData.find(o => o.id === orderId);
                        if (order) {
                            const planId = order.plan;
                            navigateToPage('page-working', { orderId: orderId, planId: planId, isSummaryView: false });
                        }
                    }
                }

                // (Req 1) Open AMR Editor
                const addAmrBtn = e.target.closest('#add-amr-btn');
                const editAmrBtn = e.target.closest('.edit-amr-btn');
                if (addAmrBtn) {
                    amrEditorTitle.textContent = 'เพิ่ม AMR ใหม่';
                    amrNameInput.value = '';
                    amrIpInput.value = '';
                    amrModelInput.value = '';
                    amrHomeTaskInput.value = '';
                    amrHomePointInput.value = '';
                    amrChargeTaskInput.value = '';
                    amrChargePointInput.value = '';
                    openModal(amrEditorModal);
                } else if (editAmrBtn) {
                    const amrId = editAmrBtn.dataset.amrId;
                    const data = amrData[amrId] || {};
                    amrEditorTitle.textContent = `แก้ไข AMR: ${amrId}`;
                    amrNameInput.value = data.name || amrId;
                    amrIpInput.value = data.ip || '';
                    amrModelInput.value = data.model || '';
                    amrHomeTaskInput.value = data.homeTask || '';
                    amrHomePointInput.value = data.homePoint || '';
                    amrChargeTaskInput.value = data.chargeTask || '';
                    amrChargePointInput.value = data.chargePoint || '';
                    amrCancelTaskInput.value = data.cancelTask || '';
                    amrPriorityInput.value = data.priority || '';
                    openModal(amrEditorModal);
                }

                // (Req 2) Open Plan Editor
                const openPlanBtn = e.target.closest('.open-plan-modal-btn');
                if (openPlanBtn) {
                    const planId = openPlanBtn.dataset.planId;
                    if (planId === 'new') {
                        planEditorTitle.textContent = 'สร้างแผนงานใหม่';
                        planNameInput.value = '';
                        planTaskList.innerHTML = '<p class="text-slate-400 text-center p-4">เพิ่ม Task เพื่อเริ่มสร้าง Plan</p>';
                    } else {
                        planEditorTitle.textContent = `แก้ไขแผนงาน: ${planId}`;
                        planNameInput.value = openPlanBtn.closest('.flex.justify-between').querySelector('h3').textContent;

                        const tasks = planTaskData[planId] || [];
                        if (tasks.length > 0) {
                            planTaskList.innerHTML = tasks.map(task => createDraggableTaskHTML(task)).join('');
                        } else {
                            planTaskList.innerHTML = '<p class="text-slate-400 text-center p-4">เพิ่ม Task เพื่อเริ่มสร้าง Plan</p>';
                        }
                    }
                    openModal(planEditorModal);
                }

                // (Req 3) Open Task Editor
                const openTaskBtn = e.target.closest('.open-task-modal-btn');
                if (openTaskBtn) {
                    const taskId = openTaskBtn.dataset.taskId;
                    const data = taskTemplateData[taskId] || {};
                    if (taskId === 'new') {
                        taskEditorTitle.textContent = 'สร้าง Task Template ใหม่';
                        taskNameInput.value = '';
                        updateIconPreview('fas fa-question');
                        taskChainContainer.innerHTML = '';
                    } else {
                        taskEditorTitle.textContent = `แก้ไข Task Template: ${data.name || taskId}`;
                        taskNameInput.value = data.name || '';
                        updateIconPreview(data.icon || 'fas fa-question');
                        taskChainContainer.innerHTML = (data.chains || []).map(createTaskChainRowHTML).join('');
                    }
                    initIconSelector();
                    openModal(taskEditorModal);
                }

                // Icon selector click handler
                const iconSelectBtn = e.target.closest('.icon-select-btn');
                if (iconSelectBtn) {
                    const iconClass = iconSelectBtn.dataset.icon;
                    updateIconPreview(iconClass);
                }

                // Storage Toggle Button
                const storageBtn = e.target.closest('.storage-toggle-btn');
                if (storageBtn && !storageBtn.disabled) {
                    currentStorageBtn = storageBtn;
                    const status = storageBtn.dataset.currentStatus;
                    const name = storageBtn.dataset.name;
                    const currentItemName = storageBtn.dataset.itemName || '';

                    if (status === 'available') {
                        // Has item - changing to empty
                        storageConfirmText.textContent = `ตำแหน่ง ${name} - คุณต้องการเปลี่ยนเป็น 'ว่าง' หรือไม่?`;
                        storageItemNameSection.classList.add('hidden');
                        storageItemNameInput.value = '';
                    } else {
                        // Empty - changing to has item (need item name)
                        storageConfirmText.textContent = `ตำแหน่ง ${name} - กรอกชื่อสินค้าเพื่อเปลี่ยนเป็น 'มีของ'`;
                        storageItemNameSection.classList.remove('hidden');
                        storageItemNameInput.value = '';
                        storageItemNameInput.focus();
                    }
                    openModal(storageConfirmModal);
                }

                // User Management
                const addUserBtn = e.target.closest('#add-user-btn');
                const editUserBtn = e.target.closest('.edit-user-btn');
                const managePermissionsBtn = e.target.closest('.manage-permissions-btn');
                const deleteUserBtn = e.target.closest('.delete-user-btn');

                if (addUserBtn) {
                    userEditorTitle.textContent = 'เพิ่มผู้ใช้ใหม่';
                    userUsernameInput.value = '';
                    userUsernameInput.removeAttribute('readonly');
                    userUsernameInput.classList.remove('bg-slate-100');
                    userExpiryInput.value = '';
                    userPasswordInput.value = '';
                    userPasswordConfirmInput.value = '';
                    userPasswordSection.style.display = 'block';
                    userPasswordConfirmSection.style.display = 'block';
                    openModal(userEditorModal);
                } else if (editUserBtn) {
                    const userId = editUserBtn.dataset.userId;
                    const data = userData[userId] || {};
                    userEditorTitle.textContent = `แก้ไขผู้ใช้: ${userId}`;
                    userUsernameInput.value = data.username || '';
                    userUsernameInput.setAttribute('readonly', 'readonly');
                    userUsernameInput.classList.add('bg-slate-100');
                    userExpiryInput.value = data.expiry || '';
                    userPasswordInput.value = '';
                    userPasswordConfirmInput.value = '';
                    userPasswordSection.style.display = 'block';
                    userPasswordConfirmSection.style.display = 'block';
                    openModal(userEditorModal);
                } else if (managePermissionsBtn) {
                    const userId = managePermissionsBtn.dataset.userId;
                    permissionsUserName.textContent = userId;

                    const permissions = userPermissionsData[userId] || [];
                    const allPlans = ['Plan 101', 'Plan 102', 'Plan 103'];
                    let currentPermissionsUserId = userId;

                    permissionsTableBody.innerHTML = allPlans.map(plan => {
                        const perm = permissions.find(p => p.plan === plan) || {
                            plan: plan,
                            canOrder: false,
                            canTrack: false,
                            canManageStorage: false
                        };
                        return `
                            <tr class="border-b">
                                <td class="p-3 font-medium">${plan}</td>
                                <td class="p-3">
                                    <button type="button" class="permission-toggle-btn ${perm.canOrder ? 'text-green-500' : 'text-red-500'}" data-user-id="${userId}" data-plan="${plan}" data-permission="canOrder">
                                        <i class="fas ${perm.canOrder ? 'fa-check-circle' : 'fa-times-circle'} text-lg cursor-pointer"></i>
                                    </button>
                                </td>
                                <td class="p-3">
                                    <button type="button" class="permission-toggle-btn ${perm.canTrack ? 'text-green-500' : 'text-red-500'}" data-user-id="${userId}" data-plan="${plan}" data-permission="canTrack">
                                        <i class="fas ${perm.canTrack ? 'fa-check-circle' : 'fa-times-circle'} text-lg cursor-pointer"></i>
                                    </button>
                                </td>
                                <td class="p-3">
                                    <button type="button" class="permission-toggle-btn ${perm.canManageStorage ? 'text-green-500' : 'text-red-500'}" data-user-id="${userId}" data-plan="${plan}" data-permission="canManageStorage">
                                        <i class="fas ${perm.canManageStorage ? 'fa-check-circle' : 'fa-times-circle'} text-lg cursor-pointer"></i>
                                    </button>
                                </td>
                            </tr>
                        `;
                    }).join('');

                    openModal(userPermissionsModal);
                } else if (deleteUserBtn) {
                    const userId = deleteUserBtn.dataset.userId;
                    currentDeleteUserId = userId;
                    deleteUserName.textContent = userId;
                    openModal(deleteUserModal);
                }

                // Permission Toggle Click
                const permissionToggleBtn = e.target.closest('.permission-toggle-btn');
                if (permissionToggleBtn) {
                    const userId = permissionToggleBtn.dataset.userId;
                    const plan = permissionToggleBtn.dataset.plan;
                    const permission = permissionToggleBtn.dataset.permission;

                    // Toggle permission
                    if (!userPermissionsData[userId]) {
                        userPermissionsData[userId] = [];
                    }
                    let perm = userPermissionsData[userId].find(p => p.plan === plan);
                    if (!perm) {
                        perm = { plan: plan, canOrder: false, canTrack: false, canManageStorage: false };
                        userPermissionsData[userId].push(perm);
                    }
                    perm[permission] = !perm[permission];

                    // Update UI
                    const icon = permissionToggleBtn.querySelector('i');
                    if (perm[permission]) {
                        icon.className = 'fas fa-check-circle text-lg cursor-pointer';
                        permissionToggleBtn.classList.remove('text-red-500');
                        permissionToggleBtn.classList.add('text-green-500');
                    } else {
                        icon.className = 'fas fa-times-circle text-lg cursor-pointer';
                        permissionToggleBtn.classList.remove('text-green-500');
                        permissionToggleBtn.classList.add('text-red-500');
                    }
                }
            });

            if (document.getElementById('back-to-orders-btn')) {
                document.getElementById('back-to-orders-btn').addEventListener('click', function (e) {
                    e.preventDefault();
                    navigateToPage('page-add-order-parent');
                });
            }

            // Order Plan 101 Logic
            let selectedPickup = null;
            let selectedDropoff = null;

            // Function to reinitialize event listeners after buttons are rendered
            function initializeOrderPlan101() {
                const pickupButtons = document.querySelectorAll('#pickup-group-a .order-point-btn');
                const dropoffButtons = document.querySelectorAll('#dropoff-group-b .order-point-btn');

                pickupButtons.forEach(btn => {
                    btn.removeEventListener('click', handlePickupClick);
                    btn.addEventListener('click', handlePickupClick);
                });

                dropoffButtons.forEach(btn => {
                    btn.removeEventListener('click', handleDropoffClick);
                    btn.addEventListener('click', handleDropoffClick);
                });
            }

            function handlePickupClick() {
                if (!this.classList.contains('status-available')) return;

                if (this.classList.contains('selected')) {
                    this.classList.remove('selected');
                    selectedPickup = null;
                } else {
                    const pickupButtons = document.querySelectorAll('#pickup-group-a .order-point-btn');
                    pickupButtons.forEach(b => b.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedPickup = this.dataset.value;
                }
                updateOrderButtonState();
            }

            function handleDropoffClick() {
                if (!this.classList.contains('status-available')) return;

                if (this.classList.contains('selected')) {
                    this.classList.remove('selected');
                    selectedDropoff = null;
                } else {
                    const dropoffButtons = document.querySelectorAll('#dropoff-group-b .order-point-btn');
                    dropoffButtons.forEach(b => b.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedDropoff = this.dataset.value;
                }
                updateOrderButtonState();
            }

            const pickupButtons = document.querySelectorAll('#pickup-group-a .order-point-btn');
            const dropoffButtons = document.querySelectorAll('#dropoff-group-b .order-point-btn');
            const confirmOrderBtn = document.getElementById('confirm-order-101');
            const orderSummary = document.getElementById('order-summary-101');

            function updateOrderButtonState() {
                if (!confirmOrderBtn) return;

                if (selectedPickup && selectedDropoff) {
                    confirmOrderBtn.disabled = false;
                    orderSummary.textContent = `ยืนยัน: รับของที่ ${selectedPickup} และส่งของที่ ${selectedDropoff}`;
                    orderSummary.classList.remove('text-slate-500');
                    orderSummary.classList.add('text-green-600', 'font-semibold');
                } else {
                    confirmOrderBtn.disabled = true;
                    let summaryText = 'กรุณาเลือก';
                    if (!selectedPickup) summaryText += 'จุดรับ';
                    if (!selectedPickup && !selectedDropoff) summaryText += 'และ';
                    if (!selectedDropoff) summaryText += 'จุดวาง';
                    orderSummary.textContent = summaryText;
                    orderSummary.classList.add('text-slate-500');
                    orderSummary.classList.remove('text-green-600', 'font-semibold');
                }
            }

            // Initialize order buttons with item names
            function renderAllOrderButtons() {
                const groupAItems = ['A01', 'A02', 'A03', 'A04', 'A05', 'A06', 'A07', 'A08'];
                const groupBItems = ['B01', 'B02', 'B03', 'B04', 'B05', 'B06', 'B07', 'B08'];
                const groupCItems = ['C01', 'C02', 'C03', 'C04', 'C05', 'C06', 'C07', 'C08'];
                const groupDItems = ['D01', 'D02', 'D03', 'D04', 'D05', 'D06', 'D07', 'D08'];

                // Order Plan 101 (A -> B)
                renderOrderButtons('pickup-group-a', groupAItems, 'fas fa-map-marker-alt');
                renderOrderButtons('dropoff-group-b', groupBItems, 'fas fa-flag-checkered');

                // Order Plan 102 (C -> D)
                renderOrderButtons('pickup-group-c', groupCItems, 'fas fa-map-marker-alt');
                renderOrderButtons('dropoff-group-d', groupDItems, 'fas fa-flag-checkered');

                // Re-initialize event listeners after rendering
                setTimeout(() => {
                    initializeOrderPlan101();
                    initializeOrderPlan102();
                }, 0);
            }

            // Initialize order buttons on page load
            renderAllOrderButtons();

            // Initialize change destination modal buttons (Group E)
            let selectedChangeDest = null;

            function renderChangeDestButtons() {
                const groupEItems = ['E01', 'E02', 'E03', 'E04', 'E05', 'E06', 'E07', 'E08'];
                const container = document.getElementById('change-dest-group-e');
                if (!container) return;

                container.innerHTML = groupEItems.map(itemId => {
                    const data = storageData[itemId];
                    const itemName = data ? data.itemName : '';
                    const status = data ? data.status : 'unavailable';

                    // Determine button class based on status
                    let btnClass = 'order-point-btn change-dest-btn';
                    if (status === 'available') {
                        btnClass += ' status-available';
                    } else if (status === 'inprogress') {
                        btnClass += ' status-inprogress';
                    } else {
                        btnClass += ' status-unavailable';
                    }

                    // Display text with item name if available
                    const displayText = itemName ?
                        `<div class="text-center"><div><i class="fas fa-flag-checkered mr-2"></i>${itemId}</div><div class="text-xs mt-1 font-normal">${itemName}</div></div>` :
                        `<i class="fas fa-flag-checkered mr-2"></i>${itemId}`;

                    return `
                        <button class="${btnClass}" data-value="${itemId}">
                            ${displayText}
                        </button>
                    `;
                }).join('');

                // Reset selection when modal opens
                selectedChangeDest = null;
                const confirmBtn = document.getElementById('confirm-change-dest-btn');
                if (confirmBtn) {
                    confirmBtn.disabled = true;
                }
            }

            // Initialize change destination buttons
            renderChangeDestButtons();

            // Re-render when modal opens
            const changeDestModal = document.getElementById('change-destination-modal');
            if (changeDestModal) {
                const modalCloseBtns = changeDestModal.querySelectorAll('.modal-close');
                modalCloseBtns.forEach(btn => {
                    btn.addEventListener('click', function () {
                        renderChangeDestButtons();
                    });
                });
            }

            // Initialize event listeners
            initializeOrderPlan101();

            if (confirmOrderBtn) {
                confirmOrderBtn.addEventListener('click', () => {
                    alert(`กำลังสั่งงาน Plan 101:\nรับ: ${selectedPickup}\nวาง: ${selectedDropoff}`);

                    pickupButtons.forEach(b => b.classList.remove('selected'));
                    dropoffButtons.forEach(b => b.classList.remove('selected'));
                    selectedPickup = null;
                    selectedDropoff = null;
                    updateOrderButtonState();

                    navigateToPage('page-add-order-parent');
                });
            }

            // Order Plan 102 Logic
            let selectedPickup102 = null;
            let selectedDropoff102 = null;

            // Function to reinitialize event listeners after buttons are rendered
            function initializeOrderPlan102() {
                const pickupButtons102 = document.querySelectorAll('#pickup-group-c .order-point-btn');
                const dropoffButtons102 = document.querySelectorAll('#dropoff-group-d .order-point-btn');

                pickupButtons102.forEach(btn => {
                    btn.removeEventListener('click', handlePickup102Click);
                    btn.addEventListener('click', handlePickup102Click);
                });

                dropoffButtons102.forEach(btn => {
                    btn.removeEventListener('click', handleDropoff102Click);
                    btn.addEventListener('click', handleDropoff102Click);
                });
            }

            function handlePickup102Click() {
                if (!this.classList.contains('status-available')) return;

                if (this.classList.contains('selected')) {
                    this.classList.remove('selected');
                    selectedPickup102 = null;
                } else {
                    const pickupButtons102 = document.querySelectorAll('#pickup-group-c .order-point-btn');
                    pickupButtons102.forEach(b => b.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedPickup102 = this.dataset.value;
                }
                updateOrder102ButtonState();
            }

            function handleDropoff102Click() {
                if (!this.classList.contains('status-available')) return;

                if (this.classList.contains('selected')) {
                    this.classList.remove('selected');
                    selectedDropoff102 = null;
                } else {
                    const dropoffButtons102 = document.querySelectorAll('#dropoff-group-d .order-point-btn');
                    dropoffButtons102.forEach(b => b.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedDropoff102 = this.dataset.value;
                }
                updateOrder102ButtonState();
            }

            const pickupButtons102 = document.querySelectorAll('#pickup-group-c .order-point-btn');
            const dropoffButtons102 = document.querySelectorAll('#dropoff-group-d .order-point-btn');
            const confirmOrderBtn102 = document.getElementById('confirm-order-102');
            const orderSummary102 = document.getElementById('order-summary-102');

            function updateOrder102ButtonState() {
                if (!confirmOrderBtn102) return;

                if (selectedPickup102 && selectedDropoff102) {
                    confirmOrderBtn102.disabled = false;
                    orderSummary102.textContent = `ยืนยัน: รับของที่ ${selectedPickup102} และส่งของที่ ${selectedDropoff102}`;
                    orderSummary102.classList.remove('text-slate-500');
                    orderSummary102.classList.add('text-green-600', 'font-semibold');
                } else {
                    confirmOrderBtn102.disabled = true;
                    let summaryText = 'กรุณาเลือก';
                    if (!selectedPickup102) summaryText += 'จุดรับ';
                    if (!selectedPickup102 && !selectedDropoff102) summaryText += 'และ';
                    if (!selectedDropoff102) summaryText += 'จุดวาง';
                    orderSummary102.textContent = summaryText;
                    orderSummary102.classList.add('text-slate-500');
                    orderSummary102.classList.remove('text-green-600', 'font-semibold');
                }
            }

            // Initialize event listeners
            initializeOrderPlan102();

            if (confirmOrderBtn102) {
                confirmOrderBtn102.addEventListener('click', () => {
                    alert(`กำลังสั่งงาน Plan 102:\nรับ: ${selectedPickup102}\nวาง: ${selectedDropoff102}`);

                    pickupButtons102.forEach(b => b.classList.remove('selected'));
                    dropoffButtons102.forEach(b => b.classList.remove('selected'));
                    selectedPickup102 = null;
                    selectedDropoff102 = null;
                    updateOrder102ButtonState();

                    navigateToPage('page-add-order-parent');
                });
            }

            // Delete User Confirmation
            if (deleteUserConfirmBtn) {
                deleteUserConfirmBtn.addEventListener('click', () => {
                    if (currentDeleteUserId) {
                        alert(`กำลังลบผู้ใช้: ${currentDeleteUserId}`);
                        // In real app, would delete from database here
                        closeModal(deleteUserModal);
                        currentDeleteUserId = null;
                    }
                });
            }

            // User Status Toggle
            document.body.addEventListener('change', function (e) {
                if (e.target.classList.contains('user-status-toggle')) {
                    if (e.target.disabled) {
                        // Case 1: User ที่หมดสิทธิ์แล้ว - ไม่สามารถเปิดได้
                        e.target.checked = false; // Force uncheck
                        alert('ไม่สามารถเปิดใช้งานได้ เนื่องจากเลยวันหมดสิทธิ์แล้ว');
                        return;
                    }
                    const userId = e.target.dataset.userId;
                    const isActive = e.target.checked;

                    // ตรวจสอบว่ายังไม่หมดสิทธิ์
                    const user = userData[userId];
                    if (user) {
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);
                        const expiryDate = new Date(user.expiry);
                        expiryDate.setHours(0, 0, 0, 0);
                        const isExpired = expiryDate < today;

                        if (isExpired) {
                            // ถ้าหมดสิทธิ์แล้ว - force เป็น inactive
                            e.target.checked = false;
                            user.status = 'inactive';
                            alert('ไม่สามารถเปิดใช้งานได้ เนื่องจากเลยวันหมดสิทธิ์แล้ว');
                            renderUsersTable(); // Re-render to update UI
                        } else {
                            // Case 2 & 3: ยังไม่หมดสิทธิ์ - สามารถ toggle ได้
                            user.status = isActive ? 'active' : 'inactive';
                            alert(`เปลี่ยนสถานะผู้ใช้ ${userId} เป็น ${isActive ? 'ใช้งาน' : 'ปิดใช้งาน'}`);
                        }
                    }
                }
            });

            // Initialize users table on page load
            renderUsersTable();

            // Map Simulation
            function startMapSimulation() {
                const canvas = document.getElementById('mapCanvas');
                if (!canvas) return;

                const ctx = canvas.getContext('2d');
                let canvasWidth, canvasHeight;

                // Define storage points (pickup/dropoff points)
                const storagePoints = {};

                // Function to calculate positions based on canvas size
                function calculateGroupPositions(width, height) {
                    const margin = 50;
                    const spacing = Math.min(60, (width - margin * 2) / 10);
                    const centerX = width / 2;
                    const centerY = height / 2;

                    return {
                        'A': { startX: margin, startY: margin, spacing: spacing, cols: 4 },
                        'B': { startX: centerX + margin, startY: margin, spacing: spacing, cols: 4 },
                        'C': { startX: margin, startY: centerY - 50, spacing: spacing, cols: 4 },
                        'D': { startX: centerX + margin, startY: centerY - 50, spacing: spacing, cols: 4 },
                        'E': { startX: centerX - 120, startY: height - 150, spacing: spacing, cols: 4 }
                    };
                }

                // Function to generate storage points
                function generateStoragePoints(groupPos) {
                    ['A', 'B', 'C', 'D', 'E'].forEach(group => {
                        const config = groupPos[group];
                        for (let i = 1; i <= 8; i++) {
                            const row = Math.floor((i - 1) / config.cols);
                            const col = (i - 1) % config.cols;
                            const pointId = `${group}${String(i).padStart(2, '0')}`;
                            storagePoints[pointId] = {
                                x: config.startX + col * config.spacing,
                                y: config.startY + row * config.spacing,
                                label: pointId,
                                group: group,
                                type: (group === 'A' || group === 'C' || group === 'D') ? 'pickup' : 'dropoff'
                            };
                        }
                    });
                }

                function resizeCanvas() {
                    canvasWidth = canvas.clientWidth;
                    canvasHeight = canvas.clientHeight;
                    canvas.width = canvasWidth;
                    canvas.height = canvasHeight;

                    // Recalculate group positions on resize
                    const groupPos = calculateGroupPositions(canvasWidth, canvasHeight);

                    // Regenerate storage points
                    generateStoragePoints(groupPos);
                }

                window.addEventListener('resize', resizeCanvas);
                resizeCanvas();

                // Initial generation of storage points (must be done before creating AMRs)
                const initialGroupPos = calculateGroupPositions(canvasWidth, canvasHeight);
                generateStoragePoints(initialGroupPos);

                // Function to get AMRs with their positions
                function getAMRs() {
                    const amrs = [];

                    // Get working AMRs from ordersData
                    const workingOrders = ordersData.filter(o => o.status === 'working');

                    workingOrders.forEach(order => {
                        const amrId = order.amr;
                        const planSteps = planTaskData[order.plan] || [];
                        const currentStepIndex = order.currentStep || 0;

                        // Determine current position based on step
                        let currentPoint = null;
                        if (currentStepIndex > 0 && currentStepIndex <= planSteps.length) {
                            const currentStep = planSteps[currentStepIndex - 1];
                            // Try to find point from step name
                            if (currentStep.name.includes('Group A')) {
                                currentPoint = storagePoints['A01']; // Default to first point
                            } else if (currentStep.name.includes('Group B')) {
                                currentPoint = storagePoints['B01'];
                            } else if (currentStep.name.includes('Group C')) {
                                currentPoint = storagePoints['C01'];
                            } else if (currentStep.name.includes('Group D')) {
                                currentPoint = storagePoints['D01'];
                            } else if (currentStep.name.includes('Group E')) {
                                currentPoint = storagePoints['E01'];
                            }
                        }

                        // Create path based on plan
                        let path = [];
                        if (order.plan === 'Plan 101') {
                            path = [storagePoints['A01'], storagePoints['B01']].filter(p => p);
                        } else if (order.plan === 'Plan 102') {
                            path = [storagePoints['C01'], storagePoints['D01']].filter(p => p);
                        } else if (order.plan === 'Plan 103') {
                            path = [storagePoints['D01'], storagePoints['E01']].filter(p => p);
                        }

                        // Use current position or default
                        const startPos = currentPoint || (path.length > 0 ? path[0] : { x: 200, y: 200 });

                        if (startPos && startPos.x !== undefined && startPos.y !== undefined) {
                            amrs.push({
                                id: amrId,
                                x: startPos.x,
                                y: startPos.y,
                                color: '#2563eb',
                                path: path,
                                speed: 0.015,
                                targetIndex: 0,
                                orderId: order.id,
                                plan: order.plan
                            });
                        }
                    });

                    // Add AMRs that are not working (idle)
                    const workingAmrIds = workingOrders.map(o => o.amr);
                    Object.keys(amrData).forEach(amrId => {
                        if (!workingAmrIds.includes(amrId)) {
                            amrs.push({
                                id: amrId,
                                x: 50,
                                y: 50,
                                color: '#94a3b8',
                                path: [],
                                speed: 0,
                                targetIndex: 0
                            });
                        }
                    });

                    return amrs;
                }

                const amrs = getAMRs();

                function animate() {
                    ctx.clearRect(0, 0, canvasWidth, canvasHeight);

                    // Draw background grid
                    ctx.strokeStyle = '#e2e8f0';
                    ctx.lineWidth = 1;
                    for (let x = 0; x < canvasWidth; x += 50) {
                        ctx.beginPath();
                        ctx.moveTo(x, 0);
                        ctx.lineTo(x, canvasHeight);
                        ctx.stroke();
                    }
                    for (let y = 0; y < canvasHeight; y += 50) {
                        ctx.beginPath();
                        ctx.moveTo(0, y);
                        ctx.lineTo(canvasWidth, y);
                        ctx.stroke();
                    }

                    // Draw storage points (pickup/dropoff points)
                    Object.values(storagePoints).forEach(point => {
                        // Draw point
                        ctx.fillStyle = point.type === 'pickup' ? '#10b981' : '#3b82f6';
                        ctx.beginPath();
                        ctx.arc(point.x, point.y, 6, 0, Math.PI * 2);
                        ctx.fill();

                        // Draw label background
                        ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
                        ctx.fillRect(point.x - 15, point.y - 20, 30, 12);

                        // Draw label
                        ctx.fillStyle = '#1e293b';
                        ctx.font = '10px Arial';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillText(point.label, point.x, point.y - 14);
                        ctx.textAlign = 'left';
                    });

                    // Draw AMR paths (route lines)
                    amrs.forEach(amr => {
                        if (amr.path && amr.path.length > 1) {
                            ctx.strokeStyle = amr.color;
                            ctx.lineWidth = 2;
                            ctx.setLineDash([5, 5]);
                            ctx.beginPath();
                            ctx.moveTo(amr.path[0].x, amr.path[0].y);
                            for (let i = 1; i < amr.path.length; i++) {
                                ctx.lineTo(amr.path[i].x, amr.path[i].y);
                            }
                            ctx.stroke();
                            ctx.setLineDash([]);
                        }
                    });

                    // Draw and update AMRs
                    amrs.forEach(amr => {
                        if (amr.path && amr.path.length > 0 && amr.speed > 0) {
                            const target = amr.path[amr.targetIndex];
                            const dx = target.x - amr.x;
                            const dy = target.y - amr.y;
                            const dist = Math.sqrt(dx * dx + dy * dy);

                            if (dist < 2) {
                                amr.targetIndex = (amr.targetIndex + 1) % amr.path.length;
                            } else {
                                amr.x += (dx / dist) * amr.speed * 50;
                                amr.y += (dy / dist) * amr.speed * 50;
                            }
                        }

                        // Draw AMR circle
                        ctx.fillStyle = amr.color;
                        ctx.beginPath();
                        ctx.arc(amr.x, amr.y, 12, 0, Math.PI * 2);
                        ctx.fill();

                        // Draw AMR border
                        ctx.strokeStyle = '#ffffff';
                        ctx.lineWidth = 2;
                        ctx.stroke();

                        // Draw AMR label
                        ctx.fillStyle = 'white';
                        ctx.font = 'bold 10px Arial';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillText(amr.id.slice(-3), amr.x, amr.y);

                        // Draw order ID if working
                        if (amr.orderId) {
                            ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                            ctx.fillRect(amr.x - 25, amr.y + 15, 50, 14);
                            ctx.fillStyle = 'white';
                            ctx.font = '9px Arial';
                            ctx.fillText(amr.orderId, amr.x, amr.y + 24);
                        }

                        ctx.textAlign = 'left';
                        ctx.textBaseline = 'alphabetic';
                    });

                    mapAnimationId = requestAnimationFrame(animate);
                }

                stopMapSimulation(); // Clear any previous loop
                animate();
            }

            function stopMapSimulation() {
                if (mapAnimationId) {
                    cancelAnimationFrame(mapAnimationId);
                    mapAnimationId = null;
                }
            }

            function setupAnalytics() {
                const perfCanvas = document.getElementById('amrPerfChart');
                if (perfCanvas) {
                    barChart = new Chart(perfCanvas, {
                        type: 'bar',
                        data: {
                            labels: ['09:00', '10:00', '11:00', '12:00', '13:00', '14:00'],
                            datasets: [{
                                label: 'Orders Completed',
                                data: [12, 19, 3, 5, 2, 3],
                                backgroundColor: 'rgba(59, 130, 246, 0.7)',
                                borderColor: 'rgba(59, 130, 246, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false, // (FIX)
                            scales: {
                                y: { beginAtZero: true }
                            }
                        }
                    });
                }

                const ratioCanvas = document.getElementById('taskRatioChart');
                if (ratioCanvas) {
                    doughnutChart = new Chart(ratioCanvas, {
                        type: 'doughnut',
                        data: {
                            labels: ['Running', 'Charging', 'Idle', 'Error'],
                            datasets: [{
                                label: 'AMR Status Ratio',
                                data: [3, 1, 0, 1], // Updated data
                                backgroundColor: [
                                    'rgba(59, 130, 246, 0.7)',
                                    'rgba(245, 158, 11, 0.7)',
                                    'rgba(107, 114, 128, 0.7)',
                                    'rgba(239, 68, 68, 0.7)'
                                ],
                                borderColor: ['#fff', '#fff', '#fff', '#fff'],
                                borderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false, // (FIX)
                        }
                    });
                }
            }

            // Modal Toggles
            function openModal(modal) {
                if (modal) modal.classList.add('open');
            }
            function closeModal(modal) {
                if (modal) modal.classList.remove('open');
            }

            // Confirm Cancel Order Button
            const confirmCancelOrderBtn = document.getElementById('confirm-cancel-order-btn');
            if (confirmCancelOrderBtn) {
                confirmCancelOrderBtn.addEventListener('click', function () {
                    const cancelModal = document.getElementById('cancel-order-modal');
                    const orderId = cancelModal ? cancelModal.dataset.orderId : null;
                    if (orderId) {
                        // Update order status to cancelled
                        const order = ordersData.find(o => o.id === orderId);
                        if (order) {
                            order.status = 'cancelled';
                            // Re-render the work sequence for the plan
                            const planId = order.plan;
                            let containerId = '';
                            if (planId === 'Plan 101') {
                                containerId = 'orders-work-sequence-plan-101';
                            } else if (planId === 'Plan 102') {
                                containerId = 'orders-work-sequence-plan-102';
                            } else if (planId === 'Plan 103') {
                                containerId = 'orders-work-sequence-plan-103';
                            }
                            if (containerId) {
                                renderPlanOrdersWorkSequence(planId, containerId);
                            }
                        }
                        closeModal(cancelModal);
                    }
                });
            }

            document.body.addEventListener('click', function (e) {
                // Close Modal
                if (e.target.classList.contains('modal-backdrop') || e.target.classList.contains('modal-close')) {
                    closeModal(e.target.closest('.modal'));
                }
            });

            // Storage Modal Confirm
            if (storageModalConfirmBtn) {
                storageModalConfirmBtn.addEventListener('click', () => {
                    if (currentStorageBtn) {
                        const status = currentStorageBtn.dataset.currentStatus;
                        const itemId = currentStorageBtn.dataset.id;

                        if (status === 'available') {
                            // Change to unavailable (empty)
                            currentStorageBtn.dataset.currentStatus = 'unavailable';
                            currentStorageBtn.dataset.itemName = '';

                            // Update storage data
                            storageData[itemId].status = 'unavailable';
                            storageData[itemId].itemName = '';
                        } else {
                            // Change to available (has item)
                            const itemName = storageItemNameInput.value.trim();
                            if (!itemName) {
                                alert('กรุณากรอกชื่อสินค้า');
                                return;
                            }

                            currentStorageBtn.dataset.currentStatus = 'available';
                            currentStorageBtn.dataset.itemName = itemName;

                            // Update storage data
                            storageData[itemId].status = 'available';
                            storageData[itemId].itemName = itemName;
                        }

                        // Re-render all storage groups to sync
                        renderAllStorageGroups();
                    }
                    closeModal(storageConfirmModal);
                });
            }

            // (Req 3) Helper for Task Chain Row
            function createTaskChainRowHTML(chain) {
                return `
                    <tr class="task-chain-row border-b">
                        <td class="p-2">
                            <input type="text" placeholder="ชื่อ" value="${chain.label || ''}" class="w-full p-2 border rounded-lg bg-slate-50">
                        </td>
                        <td class="p-2">
                            <input type="text" placeholder="ID (Task Chain)" value="${chain.chainId || ''}" class="w-full p-2 border rounded-lg bg-slate-50">
                        </td>
                        <td class="p-2">
                            <input type="text" placeholder="ID (Storage)" value="${chain.storageId || ''}" class="w-full p-2 border rounded-lg bg-slate-50">
                        </td>
                        <td class="p-2">
                            <button type="button" class="text-red-500 hover:text-red-700 remove-task-chain-btn text-lg">&times;</button>
                        </td>
                    </tr>
                `;
            }

            // (Req 3) Add/Remove Task Chain Rows
            if (addTaskChainBtn) {
                addTaskChainBtn.addEventListener('click', () => {
                    if (taskChainContainer) {
                        taskChainContainer.insertAdjacentHTML(
                            'beforeend',
                            createTaskChainRowHTML({ label: '', chainId: '', storageId: '' })
                        );
                    }
                });
            }
            if (taskChainContainer) {
                taskChainContainer.addEventListener('click', e => {
                    if (e.target.classList.contains('remove-task-chain-btn')) {
                        e.target.closest('.task-chain-row').remove();
                    }
                });
            }

            // (Req 2) Helper for dynamic plan task list
            function createDraggableTaskHTML(task) {
                return `
                    <div class="draggable-task" draggable="true" data-task-id="${task.id}">
                        <div class="flex items-center">
                            <i class="fas fa-grip-vertical drag-handle"></i>
                            <i class="fas ${task.icon} mx-3 text-lg ${task.icon.includes('user') ? 'text-yellow-500' : task.icon.includes('exchange') ? 'text-purple-500' : 'text-blue-500'}"></i>
                            <span>${task.name}</span>
                        </div>
                        <button class="text-red-500 hover:text-red-700 remove-task-from-plan-btn text-lg">&times;</button>
                    </div>
                `;
            }

            // (Req 2) Plan Editor Buttons
            if (addTaskToPlanBtn) {
                addTaskToPlanBtn.addEventListener('click', () => {
                    planTaskLibrary.classList.remove('hidden');
                });
            }
            if (cancelAddTaskBtn) {
                cancelAddTaskBtn.addEventListener('click', () => {
                    planTaskLibrary.classList.add('hidden');
                });
            }
            if (addConfirmTaskBtn) {
                addConfirmTaskBtn.addEventListener('click', () => {
                    if (planTaskList.querySelector('p')) planTaskList.innerHTML = '';
                    const task = { id: `C-${Date.now()}`, name: "รอผู้ใช้ยืนยัน", icon: "fa-user-clock" };
                    planTaskList.insertAdjacentHTML('beforeend', createDraggableTaskHTML(task));
                });
            }
            if (addChangeDestTaskBtn) {
                addChangeDestTaskBtn.addEventListener('click', () => {
                    if (planTaskList.querySelector('p')) planTaskList.innerHTML = '';
                    const task = { id: `C-${Date.now()}`, name: "เปลี่ยนจุดวาง", icon: "fa-exchange-alt" };
                    planTaskList.insertAdjacentHTML('beforeend', createDraggableTaskHTML(task));
                });
            }

            // (Req 2) Add task from library to plan
            if (planEditorModal) {
                planEditorModal.addEventListener('click', e => {
                    const addBtn = e.target.closest('.add-task-from-lib-btn');
                    if (addBtn) {
                        if (planTaskList.querySelector('p')) planTaskList.innerHTML = '';
                        const taskId = addBtn.dataset.taskId;
                        const taskData = taskTemplateData[taskId];
                        const task = { id: taskId, name: taskData.name, icon: taskData.icon };
                        planTaskList.insertAdjacentHTML('beforeend', createDraggableTaskHTML(task));
                        planTaskLibrary.classList.add('hidden');
                    }

                    const removeBtn = e.target.closest('.remove-task-from-plan-btn');
                    if (removeBtn) {
                        removeBtn.closest('.draggable-task').remove();
                        if (!planTaskList.querySelector('.draggable-task')) {
                            planTaskList.innerHTML = '<p class="text-slate-400 text-center p-4">เพิ่ม Task เพื่อเริ่มสร้าง Plan</p>';
                        }
                    }
                });
            }

            // (Req 2) Drag and Drop Logic
            let draggedItem = null;
            if (planTaskList) {
                planTaskList.addEventListener('dragstart', e => {
                    draggedItem = e.target.closest('.draggable-task');
                    if (draggedItem) {
                        setTimeout(() => {
                            draggedItem.classList.add('dragging');
                        }, 0);
                    }
                });

                planTaskList.addEventListener('dragend', e => {
                    if (draggedItem) {
                        draggedItem.classList.remove('dragging');
                        draggedItem = null;
                    }
                });

                planTaskList.addEventListener('dragover', e => {
                    e.preventDefault();
                    const afterElement = getDragAfterElement(planTaskList, e.clientY);
                    const aDraggedItem = planTaskList.querySelector('.dragging');
                    if (aDraggedItem) {
                        if (afterElement == null) {
                            planTaskList.appendChild(aDraggedItem);
                        } else {
                            planTaskList.insertBefore(aDraggedItem, afterElement);
                        }
                    }
                });
            }

            function getDragAfterElement(container, y) {
                const draggableElements = [...container.querySelectorAll('.draggable-task:not(.dragging)')];

                return draggableElements.reduce((closest, child) => {
                    const box = child.getBoundingClientRect();
                    const offset = y - box.top - box.height / 2;
                    if (offset < 0 && offset > closest.offset) {
                        return { offset: offset, element: child };
                    } else {
                        return closest;
                    }
                }, { offset: Number.NEGATIVE_INFINITY }).element;
            }

        });
    </script>
</body>

</html>
