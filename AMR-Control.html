<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AMR Control System</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts (Sarabun for Thai) -->
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">

    <style>
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #f3f4f6;
            /* Gray-100 */
            touch-action: manipulation;
            /* Improve touch response */
        }

        /* Hide scrollbar for Chrome, Safari and Opera */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        /* Hide scrollbar for IE, Edge and Firefox */
        .no-scrollbar {
            -ms-overflow-style: none;
            /* IE and Edge */
            scrollbar-width: none;
            /* Firefox */
        }

        .btn-press:active {
            transform: scale(0.95);
            transition: transform 0.1s;
        }

        /* FG Selected Parts Tags */
        .fg-tag-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            max-height: 250px;
            overflow-y: auto;
            padding: 8px;
            background: #fff;
            border-radius: 16px;
        }

        .fg-tag {
            background-color: #fff7ed;
            /* orange-50 */
            border: 2px solid #fed7aa;
            /* orange-200 */
            color: #c2410c;
            /* orange-700 */
            font-weight: 700;
            font-size: 1.125rem;
            padding: 8px 16px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 280px;
            min-width: 100px;
            position: relative;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .fg-tag:active {
            transform: scale(0.96);
        }

        .fg-tag-name {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            flex: 1;
        }

        .fg-tag.scrolling .fg-tag-name {
            text-overflow: clip;
        }

        .fg-tag.scrolling .fg-tag-name span {
            display: inline-block;
            animation: marquee 6s linear infinite;
            padding-right: 50px;
        }

        @keyframes marquee {
            0% {
                transform: translateX(0);
            }

            100% {
                transform: translateX(-100%);
            }
        }
    </style>
</head>

<body class="h-screen w-full flex flex-col overflow-hidden text-gray-800">

    <!-- Header / Status Bar -->
    <header class="bg-white shadow-sm h-16 flex justify-between items-center px-6 z-20 shrink-0">
        <div class="flex items-center space-x-2">
            <img src="https://github.com/hirunnon/Mockup/blob/main/logo_adient.png?raw=true" alt="Logo"
                class="rounded-lg w-10 h-10">
            <h1 class="text-xl font-bold text-blue-800" id="header-title">AMR Control</h1>
        </div>
        <div class="flex items-center space-x-6">
            <!-- Time Removed -->

            <!-- Status Icons -->
            <button id="btn-edit-text" onclick="toggleEditMode()"
                class="flex items-center space-x-2 bg-gray-100 px-3 py-1 rounded-full text-gray-500 hover:bg-orange-100 hover:text-orange-600 transition-colors">
                <i class="fa-solid fa-pen-to-square"></i>
                <span class="text-xs font-bold">Edit Text</span>
            </button>
            <div class="flex items-center space-x-2 bg-gray-100 px-3 py-1 rounded-full">
                <i id="wifi-icon" class="fa-solid fa-wifi text-green-500 text-lg"></i>
                <span class="text-xs font-bold text-gray-500">Ready</span>
            </div>
            <div class="flex items-center space-x-2 bg-gray-100 px-3 py-1 rounded-full">
                <i id="battery-icon" class="fa-solid fa-battery-three-quarters text-green-500 text-lg"></i>
                <span id="battery-text" class="text-xs font-bold text-gray-500">75%</span>
            </div>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="flex-1 relative overflow-hidden bg-gray-50">

        <!-- Page: Main Menu -->
        <div id="page-main"
            class="page absolute inset-0 p-6 flex flex-col items-center justify-center transition-opacity duration-300">
            <div id="main-menu-grid"
                class="grid grid-cols-2 md:grid-cols-3 gap-6 w-full max-w-5xl h-full max-h-[600px]">
                <!-- Dynamic Content -->
            </div>
        </div>

        <!-- Page: Point Menu -->
        <div id="page-point-menu" class="page hidden absolute inset-0 p-6 flex-col items-center overflow-y-auto">
            <div class="w-full max-w-5xl flex justify-between items-center mb-6">
                <button onclick="navigateTo('page-main')"
                    class="btn-press bg-gray-200 text-gray-700 px-6 py-3 rounded-xl font-bold text-lg flex items-center gap-2">
                    <i class="fa-solid fa-arrow-left"></i> Back
                </button>
                <div id="page-point-menu-title" class="text-2xl font-bold text-blue-800">Point Selection</div>
                <div class="w-24"></div>
            </div>
            <div id="point-menu-grid" class="grid grid-cols-2 gap-8 w-full max-w-4xl mt-10">
                <!-- Dynamic Content -->
            </div>
        </div>

        <!-- Page: Point Detail (Dynamic for #1, #4, #7, #10) -->
        <div id="page-point-detail"
            class="page hidden absolute inset-0 p-6 flex-col items-center bg-gray-50 overflow-y-auto">
            <div class="w-full max-w-5xl flex justify-between items-center mb-6">
                <button onclick="navigateTo('page-point-menu')"
                    class="btn-press bg-gray-200 text-gray-700 px-6 py-3 rounded-xl font-bold text-lg flex items-center gap-2">
                    <i class="fa-solid fa-arrow-left"></i> Back
                </button>
                <div id="point-detail-title" class="text-2xl font-bold text-blue-800">Point #X</div>
                <!-- Call Empty Pallet Button -->
                <button onclick="callEmptyPallet()"
                    class="btn-press bg-green-100 text-green-700 rounded-xl py-3 px-6 text-lg font-bold shadow-md hover:bg-green-200 transition-colors flex items-center justify-center gap-2">
                    <i class="fa-solid fa-pallet"></i>
                    เรียก Empty Pallet
                </button>
            </div>

            <div class="w-full max-w-2xl bg-white rounded-3xl shadow-xl p-8 flex flex-col gap-6">


                <!-- Scan QR -->
                <div class="flex justify-center mb-4">
                    <button onclick="simulateScanQR('point')"
                        class="btn-press bg-blue-100 p-6 rounded-full shadow-inner hover:bg-blue-200 transition-colors relative group">
                        <i class="fa-solid fa-qrcode text-5xl text-blue-600"></i>
                        <span
                            class="absolute -bottom-8 left-1/2 transform -translate-x-1/2 text-sm font-semibold text-blue-600 whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity">Scan
                            QR</span>
                    </button>
                </div>

                <!-- Input Station -->
                <div class="flex flex-col gap-2">
                    <label class="text-lg font-semibold text-gray-600">Station No.</label>
                    <input type="number" id="input-point-station"
                        class="w-full bg-gray-100 border-2 border-gray-300 rounded-xl px-4 py-4 text-2xl font-bold text-center focus:outline-none focus:border-blue-500 transition-colors"
                        placeholder="ระบุเลข Station">
                    <p id="station-hint" class="text-sm text-red-500 font-medium text-center h-5"></p>
                </div>

                <!-- Input Item -->
                <div class="flex flex-col gap-2">
                    <label class="text-lg font-semibold text-gray-600">Item Part No.</label>
                    <input type="text" id="input-point-item"
                        class="w-full bg-gray-100 border-2 border-gray-300 rounded-xl px-4 py-4 text-2xl font-bold text-center focus:outline-none focus:border-blue-500 transition-colors"
                        placeholder="Scan หรือ ระบุ Part">
                </div>

                <!-- Input Quantity -->
                <div class="flex flex-col gap-2">
                    <label class="text-lg font-semibold text-gray-600">Amount (Qty)</label>
                    <input type="number" id="input-point-amount"
                        class="w-full bg-gray-100 border-2 border-gray-300 rounded-xl px-4 py-4 text-2xl font-bold text-center focus:outline-none focus:border-blue-500 transition-colors"
                        placeholder="จำนวน">
                </div>

                <button onclick="confirmPointJob()"
                    class="btn-press mt-4 bg-green-500 text-white rounded-xl py-4 text-2xl font-bold shadow-lg hover:bg-green-600 transition-colors">
                    ยืนยัน
                </button>
            </div>


        </div>

        <!-- Page: FG to Truck -->
        <div id="page-fg-truck"
            class="page hidden absolute inset-0 p-6 flex-col items-center bg-gray-50 overflow-y-auto">
            <div class="w-full max-w-5xl flex justify-between items-center mb-6">
                <button onclick="navigateTo('page-main')"
                    class="btn-press bg-gray-200 text-gray-700 px-6 py-3 rounded-xl font-bold text-lg flex items-center gap-2">
                    <i class="fa-solid fa-arrow-left"></i> Back
                </button>
                <div id="page-fg-truck-title" class="text-2xl font-bold text-orange-600">FG to Truck</div>
                <div class="w-24"></div>
            </div>

            <div class="w-full max-w-2xl bg-white rounded-3xl shadow-xl p-8 flex flex-col gap-6">

                <div class="flex justify-center mb-4">
                    <button id="btn-scan-qr" onclick="toggleScanQR()"
                        class="btn-press bg-orange-100 p-6 rounded-full shadow-inner hover:bg-orange-200 transition-colors flex flex-col items-center gap-2">
                        <i id="scan-icon" class="fa-solid fa-qrcode text-5xl text-orange-600"></i>
                        <span id="scan-label" class="text-lg font-bold text-orange-600">แสกน QR</span>
                    </button>
                </div>

                <div class="flex flex-col gap-2">
                    <label class="text-lg font-semibold text-gray-600">Item Part No. (เลือกได้เฉพาะที่มีใน WH)</label>
                    <div class="relative">
                        <input type="text" id="input-fg-item" oninput="handleFGPartInput(this.value)"
                            class="w-full bg-gray-100 border-2 border-gray-300 rounded-xl px-4 py-4 text-2xl font-bold text-center focus:outline-none focus:border-orange-500"
                            placeholder="พิมพ์ชื่อ Part หรือ แสกน">

                        <div id="fg-part-dropdown"
                            class="hidden absolute left-0 right-0 top-full bg-white border border-gray-200 shadow-xl rounded-xl z-30 max-h-60 overflow-y-auto mt-2 p-2">
                            <!-- Dropdown items via JS -->
                        </div>
                    </div>
                </div>

                <!-- Container for selected parts -->
                <div id="fg-selected-parts" class="fg-tag-container">
                    <!-- Tags via JS -->
                </div>

                <button onclick="confirmFGJob()"
                    class="btn-press mt-4 bg-green-500 text-white rounded-xl py-4 text-2xl font-bold shadow-lg hover:bg-green-600 transition-colors">
                    ยืนยันเรียกงาน
                </button>
            </div>


        </div>

        <!-- Page: Empty Pallet -->
        <div id="page-empty-pallet" class="page hidden absolute inset-0 p-6 flex-col items-center overflow-y-auto">
            <div class="w-[95%] w-full max-w-5xl flex justify-between items-center mb-4">
                <button onclick="navigateTo('page-main')"
                    class="btn-press bg-gray-200 text-gray-700 px-6 py-3 rounded-xl font-bold text-lg flex items-center gap-2">
                    <i class="fa-solid fa-arrow-left"></i> Back
                </button>
                <div id="page-empty-pallet-title" class="text-2xl font-bold text-green-700">Empty Pallet</div>
                <div id="pallet-status-summary"
                    class="text-sm font-medium text-gray-600 bg-white px-3 py-1 rounded-lg border border-gray-200">
                    Loading...
                </div>
            </div>

            <div class="flex-1 w-[95%] w-full max-w-5xl flex flex-col items-center">
                <div id="pallet-grid"
                    class="flex-1 grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 px-6 overflow-y-auto content-start w-full justify-center">
                    <!-- JS Generated Buttons -->
                </div>
            </div>

            <!-- Footer Pagination -->
            <div class="w-[95%] w-full max-w-5xl flex justify-center items-center space-x-6 mt-4 pb-2">
                <button id="btn-pallet-prev" onclick="prevPage('pallet')"
                    class="btn-press w-12 h-12 rounded-full bg-white shadow flex items-center justify-center text-gray-500 hover:bg-gray-100">
                    <i class="fa-solid fa-chevron-left"></i>
                </button>
                <div class="text-lg text-gray-500 font-medium w-32 text-center" id="pallet-pagination-info">Page 1 / 1
                </div>
                <button id="btn-pallet-next" onclick="nextPage('pallet')"
                    class="btn-press w-12 h-12 rounded-full bg-white shadow flex items-center justify-center text-gray-500 hover:bg-gray-100">
                    <i class="fa-solid fa-chevron-right"></i>
                </button>
            </div>
        </div>

        <!-- Page: WH Management -->
        <div id="page-wh" class="page hidden absolute inset-0 p-6 flex-col items-center overflow-y-auto">
            <div class="w-[95%] w-full max-w-5xl flex justify-between items-center mb-4">
                <button onclick="navigateTo('page-main')"
                    class="btn-press bg-gray-200 text-gray-700 px-6 py-3 rounded-xl font-bold text-lg flex items-center gap-2">
                    <i class="fa-solid fa-arrow-left"></i> Back
                </button>
                <div id="page-wh-title" class="text-2xl font-bold text-purple-700">Warehouse</div>
                <div id="wh-status-summary"
                    class="text-sm font-medium text-gray-600 bg-white px-3 py-1 rounded-lg border border-gray-200">
                    Loading...
                </div>
            </div>

            <div class="flex-1 w-[95%] w-full max-w-5xl flex flex-col items-center">
                <div id="wh-grid"
                    class="flex-1 grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 px-6 overflow-y-auto content-start w-full justify-center">
                    <!-- JS Generated Buttons -->
                </div>
            </div>

            <!-- Footer Pagination -->
            <div class="w-[95%] w-full max-w-5xl flex justify-center items-center space-x-6 mt-4 pb-2">
                <button id="btn-wh-prev" onclick="prevPage('wh')"
                    class="btn-press w-12 h-12 rounded-full bg-white shadow flex items-center justify-center text-gray-500 hover:bg-gray-100">
                    <i class="fa-solid fa-chevron-left"></i>
                </button>
                <div class="text-lg text-gray-500 font-medium w-32 text-center" id="wh-pagination-info">Page 1 / 1</div>
                <button id="btn-wh-next" onclick="nextPage('wh')"
                    class="btn-press w-12 h-12 rounded-full bg-white shadow flex items-center justify-center text-gray-500 hover:bg-gray-100">
                    <i class="fa-solid fa-chevron-right"></i>
                </button>
            </div>
        </div>

        <!-- Page: Queue -->
        <div id="page-queue" class="page hidden absolute inset-0 p-6 flex-col items-center">
            <div class="w-full max-w-5xl flex justify-between items-center mb-4">
                <button onclick="navigateTo('page-main')"
                    class="btn-press bg-gray-200 text-gray-700 px-6 py-3 rounded-xl font-bold text-lg flex items-center gap-2">
                    <i class="fa-solid fa-arrow-left"></i> Back
                </button>
                <div id="page-queue-title" class="text-2xl font-bold text-red-600">Job Queue</div>
                <button onclick="exportQueueToCSV()"
                    class="btn-press bg-red-100 text-red-700 px-6 py-3 rounded-xl font-bold text-lg flex items-center gap-2 shadow-md hover:bg-red-200 transition-colors">
                    <i class="fa-solid fa-file-csv"></i> Export CSV
                </button>
            </div>

            <div
                class="w-full max-w-5xl bg-white rounded-2xl shadow-lg border border-gray-200 flex-1 overflow-hidden flex flex-col">
                <div
                    class="bg-red-50 p-4 grid grid-cols-12 gap-4 text-red-800 font-bold border-b border-red-100 text-lg">
                    <div class="col-span-1 text-center">#</div>
                    <div class="col-span-2">Type</div>
                    <div class="col-span-3">Source</div>
                    <div class="col-span-4">Detail</div>
                    <div class="col-span-2 text-center">Status</div>
                </div>
                <div id="queue-list" class="flex-1 overflow-y-auto p-2 space-y-2">
                    <!-- Queue Items Generated by JS -->
                </div>
            </div>

            <div class="flex items-center space-x-4 mt-4">
                <button id="btn-queue-prev" onclick="prevPage('queue')"
                    class="btn-press w-12 h-12 rounded-full bg-white shadow flex items-center justify-center text-gray-500"><i
                        class="fa-solid fa-chevron-left"></i></button>
                <span id="queue-pagination-info" class="font-medium text-gray-600">Page 1 / 1</span>
                <button id="btn-queue-next" onclick="nextPage('queue')"
                    class="btn-press w-12 h-12 rounded-full bg-white shadow flex items-center justify-center text-gray-500"><i
                        class="fa-solid fa-chevron-right"></i></button>
            </div>
        </div>

        <!-- Page: AMR Control -->
        <div id="page-amr" class="page hidden absolute inset-0 p-6 flex-col items-center overflow-y-auto">
            <div class="w-full max-w-5xl flex justify-between items-center mb-6">
                <button onclick="navigateTo('page-main')"
                    class="btn-press bg-gray-200 text-gray-700 px-6 py-3 rounded-xl font-bold text-lg flex items-center gap-2">
                    <i class="fa-solid fa-arrow-left"></i> Back
                </button>
                <div id="page-amr-title" class="text-2xl font-bold text-gray-700">AMR Control Panel</div>
                <div class="w-24"></div>
            </div>

            <!-- AMR Header -->
            <div
                class="w-full max-w-4xl bg-white rounded-2xl shadow-md p-6 mb-8 flex justify-between items-center px-12">
                <div class="flex flex-col items-center gap-2">
                    <span class="text-gray-500 font-bold text-lg">Ready</span>
                    <div
                        class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center text-green-600 text-2xl shadow-sm">
                        <i class="fa-solid fa-check"></i>
                    </div>
                </div>
                <div class="w-px h-12 bg-gray-200"></div>
                <div class="flex flex-col items-center gap-2">
                    <span class="text-gray-500 font-bold text-lg">Loc.</span>
                    <div
                        class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center text-green-600 text-2xl shadow-sm">
                        <i class="fa-solid fa-location-crosshairs"></i>
                    </div>
                </div>
                <div class="w-px h-12 bg-gray-200"></div>
                <div class="flex flex-col items-center gap-2">
                    <span class="text-gray-500 font-bold text-lg">Conf.</span>
                    <span class="text-3xl font-bold text-blue-600">80%</span>
                </div>
                <div class="w-px h-12 bg-gray-200"></div>
                <div class="flex flex-col items-center gap-2">
                    <span class="text-gray-500 font-bold text-lg">Battery</span>
                    <span class="text-3xl font-bold text-green-600" id="amr-battery-text">99%</span>
                </div>
            </div>

            <!-- AMR Button Grid -->
            <div class="w-full max-w-4xl grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                <!-- Row 1 -->
                <button onclick="controlAMR('ทำงานต่อ')"
                    class="btn-press bg-white rounded-2xl shadow-md border-b-4 border-green-500 h-32 flex flex-col items-center justify-center gap-2 hover:bg-green-50 transition-colors">
                    <i class="fa-solid fa-play text-3xl text-green-600"></i>
                    <span class="text-lg font-bold text-gray-700">ทำงานต่อ</span>
                </button>
                <button onclick="controlAMR('หยุดชั่วคราว')"
                    class="btn-press bg-white rounded-2xl shadow-md border-b-4 border-yellow-400 h-32 flex flex-col items-center justify-center gap-2 hover:bg-yellow-50 transition-colors">
                    <i class="fa-solid fa-pause text-3xl text-yellow-500"></i>
                    <span class="text-lg font-bold text-gray-700">หยุดชั่วคราว</span>
                </button>
                <button onclick="controlAMR('วิ่งไป Charge')"
                    class="btn-press bg-white rounded-2xl shadow-md border-b-4 border-blue-500 h-32 flex flex-col items-center justify-center gap-2 hover:bg-blue-50 transition-colors">
                    <i class="fa-solid fa-charging-station text-3xl text-blue-600"></i>
                    <span class="text-lg font-bold text-gray-700">ชาร์จแบต</span>
                </button>
                <button onclick="controlAMR('วิ่งไป Home')"
                    class="btn-press bg-white rounded-2xl shadow-md border-b-4 border-purple-500 h-32 flex flex-col items-center justify-center gap-2 hover:bg-purple-50 transition-colors">
                    <i class="fa-solid fa-house text-3xl text-purple-600"></i>
                    <span class="text-lg font-bold text-gray-700">กลับ Home</span>
                </button>

                <!-- Row 2 -->
                <button onclick="controlAMR('ยกเลิกงานที่ทำอยู่')"
                    class="btn-press bg-white rounded-2xl shadow-md border-b-4 border-red-500 h-32 flex flex-col items-center justify-center gap-2 hover:bg-red-50 transition-colors">
                    <i class="fa-solid fa-ban text-3xl text-red-600"></i>
                    <span class="text-lg font-bold text-gray-700">ยกเลิกงาน</span>
                </button>
                <button onclick="controlAMR('เคลียร์ Error')"
                    class="btn-press bg-white rounded-2xl shadow-md border-b-4 border-gray-500 h-32 flex flex-col items-center justify-center gap-2 hover:bg-gray-50 transition-colors">
                    <i class="fa-solid fa-screwdriver-wrench text-3xl text-gray-600"></i>
                    <span class="text-lg font-bold text-gray-700">แก้ Error</span>
                </button>
                <button onclick="controlAMR('ย้ายไปจุด Home')"
                    class="btn-press bg-white rounded-2xl shadow-md border-b-4 border-indigo-500 h-32 flex flex-col items-center justify-center gap-2 hover:bg-indigo-50 transition-colors">
                    <i class="fa-solid fa-arrow-right-to-bracket text-3xl text-indigo-600"></i>
                    <span class="text-lg font-bold text-gray-700">ย้ายไป Home</span>
                </button>
                <button onclick="controlAMR('ยืนยันจุด Home')"
                    class="btn-press bg-white rounded-2xl shadow-md border-b-4 border-teal-500 h-32 flex flex-col items-center justify-center gap-2 hover:bg-teal-50 transition-colors">
                    <i class="fa-solid fa-check-double text-3xl text-teal-600"></i>
                    <span class="text-lg font-bold text-gray-700">ยืนยัน Home</span>
                </button>
            </div>


        </div>

    </main>

    <!-- Modals -->
    <div id="modal-overlay"
        class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">

        <!-- Confirm Modal (Generic) -->
        <div id="modal-confirm"
            class="hidden bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full transform scale-100 transition-transform">
            <h3 id="modal-confirm-title" class="text-2xl font-bold text-gray-800 mb-4">Confirm?</h3>
            <p id="modal-confirm-msg" class="text-gray-600 mb-8 text-lg">Are you sure?</p>
            <div class="flex justify-end space-x-4">
                <button onclick="closeModal()"
                    class="px-6 py-3 rounded-xl text-gray-600 font-bold hover:bg-gray-100 text-lg">Cancel</button>
                <button id="modal-confirm-btn"
                    class="px-6 py-3 rounded-xl bg-blue-600 text-white font-bold hover:bg-blue-700 text-lg shadow-md">Confirm</button>
            </div>
        </div>

        <!-- Input Modal (WH) -->
        <div id="modal-input" class="hidden bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
            <h3 class="text-2xl font-bold text-gray-800 mb-4">Input Data</h3>

            <div class="space-y-4 mb-6">
                <div>
                    <label class="text-sm font-semibold text-gray-500 mb-1 block">Item Part No.</label>
                    <input type="text" id="modal-input-field"
                        class="w-full border-2 border-gray-300 rounded-xl p-3 text-xl focus:border-blue-500 outline-none"
                        placeholder="ระบุ Part">
                </div>
                <div>
                    <label class="text-sm font-semibold text-gray-500 mb-1 block">Amount (Qty)</label>
                    <input type="number" id="modal-input-amount"
                        class="w-full border-2 border-gray-300 rounded-xl p-3 text-xl focus:border-blue-500 outline-none"
                        placeholder="จำนวน">
                </div>
                <div>
                    <label class="text-sm font-semibold text-gray-500 mb-1 block">Date & Time</label>
                    <input type="datetime-local" id="modal-input-datetime"
                        class="w-full border-2 border-gray-300 rounded-xl p-3 text-xl focus:border-blue-500 outline-none">
                </div>
            </div>

            <div class="flex justify-end space-x-4">
                <button onclick="closeModal()"
                    class="px-6 py-3 rounded-xl text-gray-600 font-bold hover:bg-gray-100 text-lg">Cancel</button>
                <button id="modal-input-btn"
                    class="px-6 py-3 rounded-xl bg-purple-600 text-white font-bold hover:bg-purple-700 text-lg shadow-md">Submit</button>
            </div>
        </div>

        <!-- Queue Detail Modal -->
        <div id="modal-queue-detail" class="hidden bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
            <h3 class="text-2xl font-bold text-gray-800 mb-2">Job Detail</h3>
            <div class="bg-gray-50 p-4 rounded-xl mb-6 space-y-2">
                <p class="text-lg"><span class="font-bold text-gray-500 w-24 inline-block">ID:</span> <span
                        id="q-detail-id"></span></p>
                <p class="text-lg"><span class="font-bold text-gray-500 w-24 inline-block">Type:</span> <span
                        id="q-detail-type"></span></p>
                <p class="text-lg"><span class="font-bold text-gray-500 w-24 inline-block">Source:</span> <span
                        id="q-detail-source"></span></p>
                <p class="text-lg"><span class="font-bold text-gray-500 w-24 inline-block">Item:</span> <span
                        id="q-detail-item"></span></p>
                <p class="text-lg"><span class="font-bold text-gray-500 w-24 inline-block">Amount:</span> <span
                        id="q-detail-amount"></span></p>
            </div>

            <div class="flex justify-between space-x-4">
                <button id="q-detail-cancel-btn"
                    class="flex-1 px-4 py-3 rounded-xl bg-red-100 text-red-600 font-bold hover:bg-red-200 text-lg">ยกเลิกงานนี้</button>
                <button onclick="closeModal()"
                    class="flex-1 px-4 py-3 rounded-xl bg-gray-200 text-gray-700 font-bold hover:bg-gray-300 text-lg">ปิด</button>
            </div>
        </div>

    </div>

    <!-- Toast Notification -->
    <div id="toast"
        class="fixed bottom-10 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-8 py-4 rounded-full shadow-xl opacity-0 transition-opacity duration-300 pointer-events-none z-50 text-xl font-bold flex items-center gap-3">
        <i class="fa-solid fa-circle-info"></i>
        <span id="toast-msg">Notification</span>
    </div>

    <script>
        // --- Configuration ---
        const CONFIG = {
            palletCount: 8, // Total Empty Pallet slots
            palletPerPage: 12,

            whCount: 179,     // Total WH slots
            whPerPage: 12, // User requested 12 - Grid 4 cols

            queuePerPage: 8
        };

        // --- State Management ---
        let appState = {
            currentPoint: null, // 1, 4, 7, 10
            queue: [
                { id: 'J-1001', type: 'Point', source: 'Point #4', item: 'Part-A12', amount: '-', status: 'Pending', timestamp: Date.now() },
                { id: 'J-1002', type: 'FG', source: 'FG Area', item: 'FG-999', amount: '500', status: 'In Process', timestamp: Date.now() - 10000 },
                { id: 'J-1003', type: 'Point', source: 'Point #1', item: 'Part-C33', amount: '-', status: Date.now() - 20000 },
            ],
            pallets: Array.from({ length: CONFIG.palletCount }, (_, i) => ({ id: i + 1, status: Math.random() > 0.5 ? 'empty' : 'full' })),
            wh: Array.from({ length: CONFIG.whCount }, (_, i) => ({
                id: i + 1,
                value: Math.random() > 0.7 ? '2450616-T' : null,
                amount: Math.random() > 0.7 ? 1000 : 0,
                timestamp: Date.now() - Math.floor(Math.random() * 1000000000)
            })),
            pagination: {
                pallet: 1,
                wh: 1,
                queue: 1
            },
            amr: {
                wifi: true,
                battery: 85,
                status: 'Idle'
            },
            editMode: false,
            fgSelectedParts: [],
            isScanning: false,
            pointLabels: { 1: 'Point #1', 4: 'Point #4', 7: 'Point #7', 10: 'Point #10' },
            palletLabels: Array.from({ length: CONFIG.palletCount }, (_, i) => `E${i + 1}`),
            whLabels: Array.from({ length: CONFIG.whCount }, (_, i) => `WH${i + 1}`),
            mainMenuLabels: {
                'page-point-menu': 'Point 1,4,7,10',
                'page-fg-truck': 'ยก FG มาส่ง Truck',
                'page-empty-pallet': 'จัดการ Empty Pallet',
                'page-wh': 'จัดการ WH',
                'page-queue': 'จัดการคิวงาน',
                'page-amr': 'ควบคุม AMR'
            }
        };

        function toggleEditMode() {
            appState.editMode = !appState.editMode;
            const btn = document.getElementById('btn-edit-text');
            if (appState.editMode) {
                btn.classList.add('bg-orange-500', 'text-white');
                btn.classList.remove('bg-gray-100', 'text-gray-500');
                btn.querySelector('span').innerText = 'Save & Close';
                showToast("Edit Mode Active", "info");
            } else {
                btn.classList.remove('bg-orange-500', 'text-white');
                btn.classList.add('bg-gray-100', 'text-gray-500');
                btn.querySelector('span').innerText = 'Edit Text';
                showToast("Labels Saved");
            }

            // Re-render current page if applicable
            const activePage = window.location.hash.substring(1) || 'page-main';
            if (activePage === 'page-main') renderMainMenu();
            if (activePage === 'page-point-menu') renderPointMenu();
            if (activePage === 'page-empty-pallet') renderPallets();
            if (activePage === 'page-wh') renderWH();
        }

        // --- Navigation ---
        function renderPage(pageId) {
            // Handle Point Hash (point-X)
            if (pageId.startsWith('point-')) {
                const pNum = parseInt(pageId.split('-')[1]);
                if (!isNaN(pNum)) {
                    openPointDetail(pNum);
                    // Don't return, let it fall through to show page-point-detail
                    // But wait, openPointDetail calls navigateTo('page-point-detail') in original code?
                    // No, see below. We need to prevent loop or double render.
                    // Actually, openPointDetail in original code set state then routed.
                    // New flow: Hash -> renderPage -> openPointDetail(logic only) -> Show Div
                }
                pageId = 'page-point-detail';
            }

            // Redirect if trying to access detail page without state (and not handled by point-X)
            if (pageId === 'page-point-detail' && !appState.currentPoint) {
                navigateTo('page-point-menu');
                return;
            }

            document.querySelectorAll('.page').forEach(el => {
                el.classList.add('hidden');
                el.classList.remove('flex'); // remove flex display
            });
            const target = document.getElementById(pageId);
            if (!target) return;

            target.classList.remove('hidden');
            target.classList.add('flex'); // Add flex back for centering

            // Specific page init
            if (pageId !== 'page-fg-truck' && appState.isScanning) {
                toggleScanQR();
            }

            if (pageId === 'page-main') {
                updateHeader('AMR Control');
                renderMainMenu();
            } else if (pageId === 'page-point-menu') {
                renderPointMenu();
                syncPageTitle(pageId);
            } else if (pageId === 'page-fg-truck') {
                syncPageTitle(pageId);
                renderFGParts();
            } else if (pageId === 'page-empty-pallet') {
                renderPallets();
                syncPageTitle(pageId);
            } else if (pageId === 'page-wh') {
                renderWH();
                syncPageTitle(pageId);
            } else if (pageId === 'page-queue') {
                renderQueue();
                syncPageTitle(pageId);
            } else if (pageId === 'page-amr') {
                syncPageTitle(pageId);
            }
        }

        function navigateTo(pageId) {
            window.location.hash = pageId;
        }

        window.addEventListener('hashchange', () => {
            const pageId = window.location.hash.substring(1);
            if (pageId) renderPage(pageId);
        });

        function updateHeader(title) {
            document.getElementById('header-title').innerText = title;
        }

        // --- Clock ---
        setInterval(() => {
            const now = new Date();
            document.getElementById('clock').innerText = now.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
        }, 1000);

        function renderPointMenu() {
            const grid = document.getElementById('point-menu-grid');
            grid.innerHTML = '';
            [1, 4, 7, 10].forEach(pNum => {
                const btn = document.createElement('div'); // Using div to allow input inside
                btn.className = `h-40 bg-white rounded-2xl shadow-lg border-l-8 border-blue-500 flex flex-col items-center justify-center text-4xl font-bold text-gray-700 hover:bg-blue-50 cursor-pointer relative`;

                if (appState.editMode) {
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.className = 'w-[80%] text-center bg-gray-50 border-2 border-orange-300 rounded-lg text-2xl p-2 outline-none';
                    input.value = appState.pointLabels[pNum];
                    input.onclick = (e) => e.stopPropagation();
                    input.oninput = (e) => {
                        appState.pointLabels[pNum] = e.target.value;
                    };
                    btn.appendChild(input);
                    const label = document.createElement('span');
                    label.className = 'text-xs text-orange-500 mt-2 font-normal';
                    label.innerText = 'Editing...';
                    btn.appendChild(label);
                } else {
                    btn.innerText = appState.pointLabels[pNum];
                    btn.onclick = () => navigateTo(`point-${pNum}`);
                }
                grid.appendChild(btn);
            });
        }

        function renderMainMenu() {
            const grid = document.getElementById('main-menu-grid');
            grid.innerHTML = '';
            const items = [
                { id: 'page-point-menu', icon: 'fa-location-dot', color: 'blue' },
                { id: 'page-fg-truck', icon: 'fa-truck-ramp-box', color: 'orange' },
                { id: 'page-empty-pallet', icon: 'fa-pallet', color: 'green' },
                { id: 'page-wh', icon: 'fa-warehouse', color: 'purple' },
                { id: 'page-queue', icon: 'fa-list-check', color: 'red' },
                { id: 'page-amr', icon: 'fa-robot', color: 'gray' }
            ];

            items.forEach(item => {
                const btn = document.createElement('div');
                btn.className = `btn-press bg-white rounded-2xl shadow-md flex flex-col items-center justify-center gap-4 border-b-4 border-${item.color}-500 hover:bg-${item.color}-50 transition-colors cursor-pointer`;

                const iconContainer = document.createElement('div');
                iconContainer.className = `w-20 h-20 bg-${item.color}-100 rounded-full flex items-center justify-center text-${item.color}-600 text-4xl`;
                iconContainer.innerHTML = `<i class="fa-solid ${item.icon}"></i>`;
                btn.appendChild(iconContainer);

                if (appState.editMode) {
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.className = 'w-[90%] text-center bg-gray-50 border-2 border-orange-300 rounded-lg text-xl p-1 outline-none font-bold text-gray-700';
                    input.value = appState.mainMenuLabels[item.id];
                    input.onclick = (e) => e.stopPropagation();
                    input.oninput = (e) => {
                        appState.mainMenuLabels[item.id] = e.target.value;
                    };
                    btn.appendChild(input);
                    const hint = document.createElement('span');
                    hint.className = 'text-xs text-orange-500 font-normal mt-[-8px]';
                    hint.innerText = 'Editing...';
                    btn.appendChild(hint);
                } else {
                    const label = document.createElement('span');
                    label.className = 'text-2xl font-bold text-gray-700 text-center px-4';
                    label.innerText = appState.mainMenuLabels[item.id];
                    btn.appendChild(label);
                    btn.onclick = () => navigateTo(item.id);
                }
                grid.appendChild(btn);
            });
        }

        function syncPageTitle(pageId) {
            const titleEl = document.getElementById(`${pageId}-title`);
            if (titleEl && appState.mainMenuLabels[pageId]) {
                titleEl.innerText = appState.mainMenuLabels[pageId];
            }
        }

        // --- Point Logic ---
        function openPointDetail(pointNum) {
            appState.currentPoint = pointNum;
            document.getElementById('point-detail-title').innerText = appState.pointLabels[pointNum] || `Point #${pointNum}`;

            // Reset Inputs
            const inputStation = document.getElementById('input-point-station');
            inputStation.value = '';
            document.getElementById('input-point-item').value = '';
            document.getElementById('input-point-amount').value = '';
            document.getElementById('station-hint').innerText = '';

            // Hint logic
            let hint = "";
            if (pointNum === 1) hint = "ใส่ได้เฉพาะเลข 2 กับ 3";
            if (pointNum === 4) hint = "ใส่ได้เฉพาะเลข 5 กับ 6";
            if (pointNum === 7) hint = "ใส่ได้เฉพาะเลข 8";
            if (pointNum === 10) hint = "ใส่ได้เฉพาะเลข 9";
            inputStation.placeholder = `Station (${hint})`;

            // updateMiniQueue(); // Removed functionality
            // Removed navigateTo('page-point-detail') as this is now called during render
        }

        function validateStation(val) {
            const p = appState.currentPoint;
            const v = parseInt(val);
            if (isNaN(v)) return false;

            if (p === 1 && [2, 3].includes(v)) return true;
            if (p === 4 && [5, 6].includes(v)) return true;
            if (p === 7 && v === 8) return true;
            if (p === 10 && v === 9) return true;
            return false;
        }

        function confirmPointJob() {
            const stInput = document.getElementById('input-point-station');
            const itInput = document.getElementById('input-point-item');
            const amInput = document.getElementById('input-point-amount');
            const hintEl = document.getElementById('station-hint');

            if (!validateStation(stInput.value)) {
                hintEl.innerText = `Error: Point #${appState.currentPoint} ไม่รองรับ Station ${stInput.value}`;
                showToast("Station ไม่ถูกต้อง!", "error");
                return;
            }
            if (!itInput.value) {
                showToast("กรุณาระบุ Item Part", "error");
                return;
            }
            if (!amInput.value) {
                showToast("กรุณาระบุจำนวน", "error");
                return;
            }

            // check duplicate
            const newSource = `Point #${appState.currentPoint} (St.${stInput.value})`;
            const exists = appState.queue.some(j => j.source === newSource && j.status !== 'Completed');
            if (exists) {
                showToast(`Station ${stInput.value} มีงานค้างอยู่ในคิวแล้ว`, "error");
                return;
            }

            // Add Job
            addJob('Point', `Point #${appState.currentPoint} (St.${stInput.value})`, itInput.value, amInput.value);

            hintEl.innerText = '';
            stInput.value = '';
            itInput.value = '';
            amInput.value = '';
            showToast("เพิ่มงานสำเร็จ!");
            // updateMiniQueue(); // Removed functionality
        }

        // --- FG Logic ---
        function handleFGPartInput(q) {
            const dropdown = document.getElementById('fg-part-dropdown');
            if (!q) {
                dropdown.classList.add('hidden');
                return;
            }

            const parts = getAvailableWHParts().filter(p => p.toLowerCase().includes(q.toLowerCase()));
            if (parts.length === 0) {
                dropdown.classList.add('hidden');
                return;
            }

            dropdown.innerHTML = parts.map(p => `
                <div onclick="addFGPart('${p}')" class="p-3 hover:bg-orange-50 cursor-pointer text-xl font-bold border-b last:border-0 border-gray-100">
                    ${p}
                </div>
            `).join('');
            dropdown.classList.remove('hidden');
        }

        function addFGPart(name) {
            const whCount = appState.wh.filter(w => w.value === name).length;
            const currentSelectedCount = appState.fgSelectedParts.filter(p => p === name).length;

            if (currentSelectedCount >= whCount) {
                // Only show toast if it's a manual action or if scanning just hit the limit
                showToast(`ใน Warehouse มี Part "${name}" เพียง ${whCount} รายการ`, "error");
                return;
            }

            appState.fgSelectedParts.push(name);
            renderFGParts();
            document.getElementById('input-fg-item').value = '';
            document.getElementById('fg-part-dropdown').classList.add('hidden');
        }

        function removeFGPart(idx) {
            appState.fgSelectedParts.splice(idx, 1);
            renderFGParts();
        }

        function renderFGParts() {
            const container = document.getElementById('fg-selected-parts');
            if (appState.fgSelectedParts.length === 0) {
                container.innerHTML = '<div class="text-gray-300 italic w-full text-center py-4">ยังไม่ได้เลือกรายการ</div>';
                return;
            }

            const currentCounts = {};
            container.innerHTML = appState.fgSelectedParts.map((p, i) => {
                currentCounts[p] = (currentCounts[p] || 0) + 1;
                const displayName = currentCounts[p] > 1 ? `${p} #${currentCounts[p]}` : p;

                return `
                    <div class="fg-tag" onclick="this.classList.toggle('scrolling')">
                        <div class="fg-tag-name"><span>${displayName}</span></div>
                        <button onclick="event.stopPropagation(); removeFGPart(${i})" class="text-red-400 hover:text-red-600 transition-colors">
                            <i class="fa-solid fa-circle-xmark text-xl"></i>
                        </button>
                    </div>
                `;
            }).join('');
        }

        function getAvailableWHParts() {
            return [...new Set(appState.wh.filter(w => w.value).map(w => w.value))];
        }

        function confirmFGJob() {
            if (appState.fgSelectedParts.length === 0) {
                showToast("กรุณาเลือก Part อย่างน้อย 1 รายการ", "error");
                return;
            }

            const count = appState.fgSelectedParts.length;
            appState.fgSelectedParts.forEach(item => {
                addJob('FG', 'FG to Truck', item, '-');
            });

            if (appState.isScanning) toggleScanQR(); // Stop scanning on confirm

            appState.fgSelectedParts = [];
            renderFGParts();
            showToast(`เพิ่มงาน FG ${count} รายการ สำเร็จ!`);
            navigateTo('page-queue');
        }

        /* function updateMiniQueue() {
            // Render logic for mini queue lists in Point & FG pages
            const q = appState.queue.slice(0, 3);
            const html = q.map(j => `
                <div class="bg-white border rounded-lg p-3 flex justify-between items-center shadow-sm">
                    <div>
                        <div class="font-bold text-gray-700">${j.source}</div>
                        <div class="text-sm text-gray-500">Item: ${j.item}</div>
                    </div>
                    <div class="text-sm font-bold ${j.status === 'Pending' ? 'text-yellow-500' : 'text-blue-500'}">${j.status}</div>
                </div>
            `).join('');

            document.getElementById('point-mini-queue').innerHTML = html;
            document.getElementById('fg-mini-queue').innerHTML = html;
        } */

        function addJob(type, source, item, amount) {
            const newJob = {
                id: `J-${1000 + appState.queue.length + 1}`,
                type,
                source,
                item,
                amount,
                status: 'Pending',
                timestamp: Date.now()
            };
            appState.queue.push(newJob); // Add to end (FIFO)
        }

        // --- Call Empty Pallet ---
        function callEmptyPallet() {
            if (!appState.currentPoint) {
                showToast("ไม่พบ Point", "error");
                return;
            }

            const pointNum = appState.currentPoint;
            const targetSource = `Point #${pointNum}`;

            // Check Duplicate: Only if status is not 'Completed'
            const exists = appState.queue.some(j => j.type === 'Empty' && j.source === targetSource && j.status !== 'Completed');
            if (exists) {
                const pLabel = appState.pointLabels[pointNum] || targetSource;
                showToast(`งาน Empty Pallet สำหรับ ${pLabel} มีอยู่ในคิวแล้ว`, "error");
                return;
            }

            addJob('Empty', targetSource, 'Empty Pallet', '-');
            showToast(`เรียก Empty Pallet สำเร็จ!`);
        }

        // --- QR Scan Simulation ---
        let scanInterval = null;
        function toggleScanQR() {
            appState.isScanning = !appState.isScanning;
            const btn = document.getElementById('btn-scan-qr');
            const icon = document.getElementById('scan-icon');
            const label = document.getElementById('scan-label');

            if (appState.isScanning) {
                btn.classList.add('bg-red-100', 'border-2', 'border-red-400');
                btn.classList.remove('bg-orange-100');
                icon.classList.remove('fa-qrcode', 'text-orange-600');
                icon.classList.add('fa-video-slash', 'text-red-600');
                label.innerText = "ปิดแสกน";
                label.classList.replace('text-orange-600', 'text-red-600');

                showToast("เปิดแสกน QR ต่อเนื่อง...", "info");

                // Simulate continuous scanning
                scanInterval = setInterval(() => {
                    const available = getAvailableWHParts();
                    if (available.length > 0) {
                        const randomPart = available[Math.floor(Math.random() * available.length)];
                        // Allow adding multiple if WH has more
                        const whTotal = appState.wh.filter(w => w.value === randomPart).length;
                        const selTotal = appState.fgSelectedParts.filter(p => p === randomPart).length;

                        if (selTotal < whTotal) {
                            addFGPart(randomPart);
                            showToast(`QR เจอ Part: ${randomPart}`);
                        }
                    }
                }, 2000); // scan every 2 sec
            } else {
                btn.classList.remove('bg-red-100', 'border-2', 'border-red-400');
                btn.classList.add('bg-orange-100');
                icon.classList.add('fa-qrcode', 'text-orange-600');
                icon.classList.remove('fa-video-slash', 'text-red-600');
                label.innerText = "แสกน QR";
                label.classList.replace('text-red-600', 'text-orange-600');

                clearInterval(scanInterval);
                showToast("ปิดการแสกน");
            }
        }

        function simulateScanQR(context) {
            if (context === 'point') {
                showToast("Scanning QR...", "info");
                setTimeout(() => {
                    // Random valid station based on point
                    let validSt = 2;
                    if (appState.currentPoint === 4) validSt = 5;
                    if (appState.currentPoint === 7) validSt = 8;
                    if (appState.currentPoint === 10) validSt = 9;

                    document.getElementById('input-point-station').value = validSt;
                    document.getElementById('input-point-item').value = 'QR-PART-' + Math.floor(Math.random() * 1000);
                    showToast("QR Scan Success!");
                }, 1000);
            }
        }

        // --- Empty Pallet Logic ---
        function renderPallets() {
            const grid = document.getElementById('pallet-grid');
            grid.innerHTML = '';
            // Responsive: 2 cols on small, 3 on md, 4 on lg
            grid.className = `flex-1 grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 px-6 h-[500px] overflow-y-auto content-start justify-center w-full`;

            // Update Status
            const emptyCount = appState.pallets.filter(p => p.status === 'empty').length;
            const fullCount = appState.pallets.length - emptyCount;
            document.getElementById('pallet-status-summary').innerHTML = `<span class="text-gray-400">ว่าง:</span> <span class="text-green-600 font-bold">${emptyCount}</span> | <span class="text-gray-400">มีของ:</span> <span class="text-blue-600 font-bold">${fullCount}</span>`;

            const start = (appState.pagination.pallet - 1) * CONFIG.palletPerPage;
            const end = start + CONFIG.palletPerPage;
            const pageData = appState.pallets.slice(start, end);

            pageData.forEach(p => {
                const isFull = p.status === 'full';
                const labelIndex = p.id - 1;
                const btn = document.createElement('div');
                btn.className = `h-32 rounded-2xl shadow-md text-2xl font-bold flex flex-col items-center justify-center gap-2 transition-transform btn-press cursor-pointer ${isFull ? 'bg-blue-100 text-blue-700 border-2 border-blue-300' : 'bg-gray-100 text-gray-400 border-2 border-dashed border-gray-300'}`;

                if (appState.editMode) {
                    btn.innerHTML = `<i class="fa-solid fa-pallet ${isFull ? 'text-4xl' : 'text-2xl opacity-50'}"></i>`;
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.className = 'w-[80%] text-center bg-gray-50 border-2 border-orange-300 rounded-lg text-lg p-1 outline-none';
                    input.value = appState.palletLabels[labelIndex];
                    input.onclick = (e) => e.stopPropagation();
                    input.oninput = (e) => {
                        appState.palletLabels[labelIndex] = e.target.value;
                    };
                    btn.appendChild(input);
                    const hint = document.createElement('span');
                    hint.className = 'text-[10px] text-orange-500 font-normal';
                    hint.innerText = 'Editing...';
                    btn.appendChild(hint);
                } else {
                    btn.innerHTML = `
                        <i class="fa-solid fa-pallet ${isFull ? 'text-4xl' : 'text-2xl opacity-50'}"></i>
                        <span>${appState.palletLabels[labelIndex]}</span>
                        <span class="text-sm font-normal">${isFull ? 'มี Pallet' : 'ว่าง'}</span>
                    `;
                    btn.onclick = () => togglePallet(p.id);
                }
                grid.appendChild(btn);
            });

            const totalPages = Math.ceil(appState.pallets.length / CONFIG.palletPerPage);
            document.getElementById('pallet-pagination-info').innerText = `Page ${appState.pagination.pallet} / ${totalPages}`;

            // Hide pagination if single page
            const prevBtn = document.getElementById('btn-pallet-prev');
            const nextBtn = document.getElementById('btn-pallet-next');
            if (totalPages <= 1) {
                prevBtn.classList.add('hidden');
                nextBtn.classList.add('hidden');
            } else {
                prevBtn.classList.remove('hidden');
                nextBtn.classList.remove('hidden');
            }
        }

        function togglePallet(id) {
            const p = appState.pallets.find(x => x.id === id);
            const action = p.status === 'full' ? 'ว่าง (Empty)' : 'มี Pallet (Full)';

            showConfirmModal(`เปลี่ยนสถานะ E${id} เป็น "${action}"?`, () => {
                p.status = p.status === 'full' ? 'empty' : 'full';
                renderPallets();
                showToast(`E${id} Updated`);
            });
        }

        // --- WH Logic ---
        function renderWH() {
            const grid = document.getElementById('wh-grid');
            grid.innerHTML = '';
            // Responsive: 2 cols on small, 3 on md, 4 on lg
            grid.className = `flex-1 grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 px-6 h-[500px] overflow-y-auto content-start justify-center w-full`;

            // Calculate Sequence Numbers per Part
            const occupied = appState.wh.filter(w => w.value !== null);
            const groups = {};
            occupied.forEach(w => {
                if (!groups[w.value]) groups[w.value] = [];
                groups[w.value].push(w);
            });
            // Assign sequence #
            Object.keys(groups).forEach(part => {
                groups[part].sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));
                groups[part].forEach((w, idx) => {
                    w.seqNum = idx + 1;
                });
            });

            // Update Status
            const emptyCount = appState.wh.filter(w => w.value === null).length;
            const fullCount = appState.wh.length - emptyCount;
            document.getElementById('wh-status-summary').innerHTML = `<span class="text-gray-400">ว่าง:</span> <span class="text-green-600 font-bold">${emptyCount}</span> | <span class="text-gray-400">มีของ:</span> <span class="text-purple-600 font-bold">${fullCount}</span>`;

            const start = (appState.pagination.wh - 1) * CONFIG.whPerPage;
            const end = start + CONFIG.whPerPage;
            const pageData = appState.wh.slice(start, end);

            pageData.forEach(w => {
                const hasItem = w.value !== null;
                const labelIndex = w.id - 1;
                const btn = document.createElement('div');
                btn.className = `relative h-32 rounded-2xl shadow-md text-2xl font-bold flex flex-col items-center justify-center gap-1 transition-transform btn-press cursor-pointer ${hasItem ? 'bg-purple-100 text-purple-700 border-2 border-purple-300' : 'bg-gray-100 text-gray-400 border-2 border-dashed border-gray-300'}`;

                if (appState.editMode) {
                    btn.innerHTML = `<i class="fa-solid ${hasItem ? 'fa-box-open text-4xl' : 'fa-warehouse text-2xl opacity-50'}"></i>`;
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.className = 'w-[80%] text-center bg-gray-50 border-2 border-orange-300 rounded-lg text-lg p-1 outline-none';
                    input.value = appState.whLabels[labelIndex];
                    input.onclick = (e) => e.stopPropagation();
                    input.oninput = (e) => {
                        appState.whLabels[labelIndex] = e.target.value;
                    };
                    btn.appendChild(input);
                    const hint = document.createElement('span');
                    hint.className = 'text-[10px] text-orange-500 font-normal';
                    hint.innerText = 'Editing...';
                    btn.appendChild(hint);
                } else {
                    btn.innerHTML = `
                        ${hasItem ? `<span class="absolute top-2 right-3 text-xs font-bold text-purple-500">#${w.seqNum}</span>` : ''}
                        <div class="flex items-center gap-2">
                             <i class="fa-solid ${hasItem ? 'fa-box-open text-3xl' : 'fa-warehouse text-2xl opacity-50'}"></i>
                             ${hasItem ? `<span class="text-xs font-bold bg-purple-500 text-white px-1.5 py-0.5 rounded opacity-80">x${w.amount.toLocaleString()}</span>` : ''}
                        </div>
                        <span class="text-xs text-gray-400 mt-1">${appState.whLabels[labelIndex]}</span>
                        <span class="${hasItem ? 'text-lg' : 'text-base font-normal'} truncate w-full text-center px-1">${hasItem ? w.value : 'ว่าง'}</span>
                    `;
                    btn.onclick = () => handleWHClick(w.id);
                }
                grid.appendChild(btn);
            });

            const totalPages = Math.ceil(appState.wh.length / CONFIG.whPerPage);
            document.getElementById('wh-pagination-info').innerText = `Page ${appState.pagination.wh} / ${totalPages}`;

            // Hide pagination if single page
            const prevBtn = document.getElementById('btn-wh-prev');
            const nextBtn = document.getElementById('btn-wh-next');
            if (totalPages <= 1) {
                prevBtn.classList.add('hidden');
                nextBtn.classList.add('hidden');
            } else {
                prevBtn.classList.remove('hidden');
                nextBtn.classList.remove('hidden');
            }
        }

        function handleWHClick(id) {
            const w = appState.wh.find(x => x.id === id);
            if (w.value) {
                // Clear
                showConfirmModal(`เคลียร์ WH${id} (${w.value}) เป็น "ว่าง"?`, () => {
                    w.value = null;
                    w.amount = 0;
                    w.timestamp = null;
                    renderWH();
                    showToast(`WH${id} Cleared`);
                });
            } else {
                // Input
                showInputModal(`กรอก Part สำหรับ WH${id}`, (data) => {
                    if (data && data.part) {
                        w.value = data.part;
                        w.amount = data.amount;
                        w.timestamp = data.timestamp;
                        renderWH();
                        showToast(`WH${id} Updated`);
                    }
                });
            }
        }

        // --- Queue Logic ---
        function renderQueue() {
            // Update Status Logic: First = In Process, Others = Pending
            if (appState.queue.length > 0) {
                appState.queue.forEach((j, index) => {
                    j.status = index === 0 ? 'In Process' : 'Pending';
                });
            }

            const list = document.getElementById('queue-list');
            list.innerHTML = '';

            const start = (appState.pagination.queue - 1) * CONFIG.queuePerPage;
            const end = start + CONFIG.queuePerPage;
            const pageData = appState.queue.slice(start, end);

            pageData.forEach((j, idx) => {
                let displaySource = j.source;
                if (j.type === 'Point' || j.type === 'Empty') {
                    // Try to match Point #X from source string and replace with custom label
                    const match = j.source.match(/Point #(\d+)/);
                    if (match) {
                        const pNum = match[1];
                        displaySource = j.source.replace(`Point #${pNum}`, appState.pointLabels[pNum] || `Point #${pNum}`);
                    }
                }

                const row = document.createElement('div');
                row.className = "grid grid-cols-12 gap-4 items-center bg-white p-4 rounded-xl shadow-sm border border-gray-100 hover:bg-red-50 cursor-pointer transition-colors";
                row.innerHTML = `
                    <div class="col-span-1 text-center font-mono text-gray-500 text-sm">${start + idx + 1}</div>
                    <div class="col-span-2 font-bold text-gray-700">${j.type}</div>
                    <div class="col-span-3 text-sm text-gray-600 truncate">${displaySource}</div>
                    <div class="col-span-4 text-sm text-gray-800 font-medium truncate">${j.item} ${j.amount !== '-' ? '(x' + j.amount + ')' : ''}</div>
                    <div class="col-span-2 text-center">
                         <span class="px-2 py-1 rounded-full text-xs font-bold ${j.status === 'Pending' ? 'bg-yellow-100 text-yellow-600' : 'bg-blue-100 text-blue-600'}">${j.status}</span>
                    </div>
                `;
                row.onclick = () => openQueueDetail(j.id);
                list.appendChild(row);
            });

            const totalPages = Math.ceil(appState.queue.length / CONFIG.queuePerPage) || 1;
            document.getElementById('queue-pagination-info').innerText = `Page ${appState.pagination.queue} / ${totalPages}`;

            // Hide pagination if single page
            const prevBtn = document.getElementById('btn-queue-prev');
            const nextBtn = document.getElementById('btn-queue-next');
            if (totalPages <= 1) {
                prevBtn.classList.add('hidden');
                nextBtn.classList.add('hidden');
            } else {
                prevBtn.classList.remove('hidden');
                nextBtn.classList.remove('hidden');
            }
        }

        function openQueueDetail(jid) {
            const j = appState.queue.find(x => x.id === jid);
            if (!j) return;

            document.getElementById('q-detail-id').innerText = j.id;
            document.getElementById('q-detail-type').innerText = j.type;
            document.getElementById('q-detail-source').innerText = j.source;
            document.getElementById('q-detail-item').innerText = j.item;
            document.getElementById('q-detail-amount').innerText = j.amount;

            const modal = document.getElementById('modal-queue-detail');
            const overlay = document.getElementById('modal-overlay');
            const cancelBtn = document.getElementById('q-detail-cancel-btn');

            cancelBtn.onclick = () => {
                modal.classList.add('hidden'); // Close detail modal first
                showConfirmModal("ต้องการลบงานนี้ใช่หรือไม่?", () => {
                    appState.queue = appState.queue.filter(x => x.id !== jid);
                    renderQueue();
                    showToast("ลบงานเรียบร้อย");
                });
            };

            overlay.classList.remove('hidden');
            modal.classList.remove('hidden');
        }

        function exportQueueToCSV() {
            if (appState.queue.length === 0) {
                showToast("ไม่มีข้อมูลในคิวงานให้ส่งออก", "error");
                return;
            }

            const headers = ["ID", "Type", "Source", "Item", "Amount", "Status", "Timestamp"];
            const rows = appState.queue.map(j => {
                let displaySource = j.source;
                if (j.type === 'Point' || j.type === 'Empty') {
                    const match = j.source.match(/Point #(\d+)/);
                    if (match) {
                        const pNum = match[1];
                        displaySource = j.source.replace(`Point #${pNum}`, appState.pointLabels[pNum] || `Point #${pNum}`);
                    }
                }
                return [
                    j.id,
                    j.type,
                    `"${displaySource}"`,
                    `"${j.item}"`,
                    j.amount,
                    j.status,
                    new Date(j.timestamp).toLocaleString()
                ];
            });

            const csvContent = [headers.join(","), ...rows.map(r => r.join(","))].join("\n");
            const blob = new Blob(["\ufeff" + csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");

            const now = new Date();
            const filename = `JobQueue_${now.getFullYear()}${(now.getMonth() + 1).toString().padStart(2, '0')}${now.getDate().toString().padStart(2, '0')}.csv`;

            link.setAttribute("href", url);
            link.setAttribute("download", filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showToast("ส่งออกไฟล์ CSV สำเร็จ!");
        }

        // --- AMR Logic ---
        function controlAMR(action) {
            showToast(`สั่งการ: ${action}`, "info");

            // Simulate status change
            if (action === 'ทำงานต่อ') {
                appState.amr.status = 'Running';
                appState.amr.wifi = true;
            } else if (action === 'หยุดชั่วคราว') {
                appState.amr.status = 'Paused';
            } else if (action === 'กลับจุดชาร์จ') {
                appState.amr.status = 'Charging';
                appState.amr.wifi = false; // Simulate connection drop for fun
            }

            updateGlobalIcons();
        }

        function updateGlobalIcons() {
            const wifiEl = document.getElementById('wifi-icon');
            if (appState.amr.wifi) {
                wifiEl.className = "fa-solid fa-wifi text-green-500 text-lg";
            } else {
                wifiEl.className = "fa-solid fa-wifi text-red-500 text-lg";
            }

            // Simulate slight battery drain
            if (appState.amr.status === 'Running') appState.amr.battery -= 1;
            if (appState.amr.status === 'Charging') appState.amr.battery += 5;
            if (appState.amr.battery > 100) appState.amr.battery = 100;

            document.getElementById('battery-text').innerText = appState.amr.battery + "%";
            const batIcon = document.getElementById('battery-icon');
            if (appState.amr.battery > 70) batIcon.className = "fa-solid fa-battery-full text-green-500 text-lg";
            else if (appState.amr.battery > 30) batIcon.className = "fa-solid fa-battery-half text-yellow-500 text-lg";
            else batIcon.className = "fa-solid fa-battery-quarter text-red-500 text-lg";
        }

        // Loop update for battery simulation
        setInterval(updateGlobalIcons, 5000);


        // --- Generic Utility Functions ---
        function nextPage(type) {
            const max = Math.ceil((type === 'queue' ? appState.queue.length : type === 'pallet' ? appState.pallets.length : appState.wh.length) / CONFIG[type + 'PerPage']);
            if (appState.pagination[type] < max) {
                appState.pagination[type]++;
            } else {
                appState.pagination[type] = 1; // Loop to first
            }
            if (type === 'pallet') renderPallets();
            if (type === 'wh') renderWH();
            if (type === 'queue') renderQueue();
        }

        function prevPage(type) {
            const max = Math.ceil((type === 'queue' ? appState.queue.length : type === 'pallet' ? appState.pallets.length : appState.wh.length) / CONFIG[type + 'PerPage']);
            if (appState.pagination[type] > 1) {
                appState.pagination[type]--;
            } else {
                appState.pagination[type] = max; // Loop to last
            }
            if (type === 'pallet') renderPallets();
            if (type === 'wh') renderWH();
            if (type === 'queue') renderQueue();
        }

        function showToast(msg, type = 'success') {
            const toast = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;

            // Reset classes
            toast.className = `fixed bottom-10 left-1/2 transform -translate-x-1/2 px-8 py-4 rounded-full shadow-xl opacity-0 transition-opacity duration-300 pointer-events-none z-50 text-xl font-bold flex items-center gap-3`;

            if (type === 'error') toast.classList.add('bg-red-600', 'text-white');
            else if (type === 'info') toast.classList.add('bg-blue-600', 'text-white');
            else toast.classList.add('bg-gray-800', 'text-white'); // default

            toast.classList.remove('opacity-0');
            setTimeout(() => {
                toast.classList.add('opacity-0');
            }, 3000);
        }

        // --- Modal System ---
        let confirmCallback = null;
        let inputCallback = null;

        function showConfirmModal(msg, callback) {
            document.getElementById('modal-confirm-msg').innerText = msg;
            document.getElementById('modal-overlay').classList.remove('hidden');
            document.getElementById('modal-confirm').classList.remove('hidden');
            confirmCallback = callback;
        }

        function showInputModal(msg, callback) {
            // Updated for WH with multi-fields
            document.getElementById('modal-input-field').value = '';
            document.getElementById('modal-input-amount').value = '';

            // Default datetime to now
            const now = new Date();
            const tzoffset = now.getTimezoneOffset() * 60000;
            const localISOTime = (new Date(now - tzoffset)).toISOString().slice(0, 16);
            document.getElementById('modal-input-datetime').value = localISOTime;

            document.getElementById('modal-overlay').classList.remove('hidden');
            document.getElementById('modal-input').classList.remove('hidden');
            inputCallback = callback;
        }

        function closeModal() {
            document.getElementById('modal-overlay').classList.add('hidden');
            document.querySelectorAll('#modal-overlay > div').forEach(d => d.classList.add('hidden'));
            confirmCallback = null;
            inputCallback = null;
        }

        document.getElementById('modal-confirm-btn').onclick = () => {
            if (confirmCallback) confirmCallback();
            closeModal();
        };

        document.getElementById('modal-input-btn').onclick = () => {
            const part = document.getElementById('modal-input-field').value;
            const amount = document.getElementById('modal-input-amount').value;
            const datetime = document.getElementById('modal-input-datetime').value;

            if (inputCallback) {
                inputCallback({
                    part: part,
                    amount: parseInt(amount) || 0,
                    timestamp: new Date(datetime).getTime()
                });
            }
            closeModal();
        };

        // Initialize
        // Initialize
        if (window.location.hash) {
            renderPage(window.location.hash.substring(1));
        } else {
            navigateTo('page-main');
        }

    </script>
</body>

</html>
